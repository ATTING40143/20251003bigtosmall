<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水果包裝與庫存管理系統 (整合版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS 程式庫用於 Excel 檔案解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .main-tab.active { border-bottom-color: #2563eb; color: #1e3a8a; font-weight: 600; }
        .sub-tab.active { background-color: #2563eb; color: white; }
        .role-btn.active { background-color: #1d4ed8; color: white; font-weight: 700; }
        .work-order-item.selected { background-color: #eff6ff; border-left-color: #2563eb; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view, .hidden-pane { display: none; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .fruit-select {
            color: #374151;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 由於 option 元素樣式限制，我們使用 JavaScript 來處理庫存數量的藍色顯示 */
        .fruit-select option {
            background: white;
            padding: 8px 12px;
        }
        .stock-highlight {
            color: #3B82F6 !important;
            font-weight: 600 !important;
        }
        /* 為下拉選單中的庫存數量添加藍色樣式 */
        .fruit-select option {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 使用 CSS 變數來處理庫存數量的藍色顯示 */
        .fruit-select {
            color: #374151;
        }
        
        /* 狐狸頭匯入表格凍結標題樣式 */
        #preview-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.1);
        }
        
        /* 確保不同類型的標題列有正確的背景色 */
        #preview-table thead th.bg-gray-50 {
            background-color: #f9fafb !important;
        }
        
        #preview-table thead th.bg-blue-50 {
            background-color: #eff6ff !important;
        }
        
        #preview-table thead th.bg-gray-100 {
            background-color: #f3f4f6 !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-6 flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">水果包裝與庫存管理系統</h1>
                <p class="text-gray-600 mt-1">整合工單、庫存、資料維護、紀錄與儀表板的完整系統原型。</p>
            </div>
            <div id="current-role-display" class="hidden bg-blue-100 text-blue-800 text-sm font-bold px-4 py-2 rounded-lg shadow-sm">
                <!-- Role info will be injected here -->
            </div>
        </header>

        <!-- 主功能分頁 -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" id="main-tabs">
                <button data-view="dashboard" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">儀表板</button>
                <button data-view="work_orders" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">工單系統</button>
                <button data-view="inventory" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">庫存管理</button>
                <button data-view="maintenance" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">資料維護</button>
                <button data-view="logs" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">庫存紀錄</button>
                <button data-view="locations" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">儲位</button>
            </nav>
        </div>

        <!-- 儀表板視圖 -->
        <div id="view-dashboard" class="view-container hidden-view fade-in">
             <div class="flex flex-wrap gap-4 items-center mb-4 p-4 bg-white rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-800">儀表板篩選</h2>
                <div class="flex items-center gap-2"><label for="dashboard-year-filter" class="text-sm font-medium">年份:</label><select id="dashboard-year-filter" class="rounded-md border-gray-300 shadow-sm"></select></div>
                <div class="flex items-center gap-2"><label for="dashboard-month-filter" class="text-sm font-medium">月份:</label><select id="dashboard-month-filter" class="rounded-md border-gray-300 shadow-sm"></select></div>
                <div class="flex items-center gap-2"><label for="dashboard-start-date" class="text-sm font-medium">從:</label><input type="date" id="dashboard-start-date" class="rounded-md border-gray-300 shadow-sm"></div>
                <div class="flex items-center gap-2"><label for="dashboard-end-date" class="text-sm font-medium">到:</label><input type="date" id="dashboard-end-date" class="rounded-md border-gray-300 shadow-sm"></div>
                <button id="dashboard-clear-filter-btn" class="text-sm text-blue-600 hover:underline">清除篩選</button>
            </div>
            <div class="space-y-6" id="dashboard-container">
                <!-- Dashboard content will be injected here -->
            </div>
        </div>

        <!-- 工單系統視圖 -->
        <div id="view-work_orders" class="view-container">
            <div class="mb-6 p-4 bg-white rounded-lg shadow-sm"><h2 class="text-lg font-semibold mb-3">1. 請選擇您的角色身份：</h2><div id="role-switcher" class="flex flex-wrap gap-3"><button data-role="retail" data-role-name="門市人員" class="role-btn px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-all duration-200">門市人員</button><button data-role="warehouse" data-role-name="倉儲人員" class="role-btn px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-all duration-200">倉儲人員</button><button data-role="packaging" data-role-name="包裝人員" class="role-btn px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-all duration-200">包裝人員</button></div></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm p-4 h-full">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-semibold">2. 點擊查看工單：</h2>
                            <button id="add-wo-btn" class="bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-blue-700 transition-colors">新增工單</button>
                        </div>
                        <!-- 門市人員專用的工單狀態分頁 -->
                        <div id="work-order-status-tabs" class="mb-3 border-b border-gray-200" style="display: none;">
                            <nav class="flex space-x-1">
                                <button data-status="待處理" class="work-order-status-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300 transition-colors">待處理</button>
                                <button data-status="包裝中" class="work-order-status-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300 transition-colors">包裝中</button>
                                <button data-status="已完成" class="work-order-status-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300 transition-colors">已完成</button>
                            </nav>
                        </div>
                        <div id="work-order-list" class="space-y-2"></div>
                    </div>
                </div>
                <div class="lg:col-span-2"><div id="work-order-details" class="bg-white rounded-lg shadow-sm p-6 min-h-[400px] fade-in"></div></div>
            </div>
        </div>

        <!-- 庫存管理視圖 -->
        <div id="view-inventory" class="view-container hidden-view fade-in">
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-center border-b border-gray-200 pb-3">
                    <nav class="flex space-x-1" id="inventory-sub-tabs"></nav>
                    <button id="min-stock-settings-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md text-sm hover:bg-blue-600 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        最低庫存量設定
                    </button>
                </div>
                <div id="inventory-panes-container" class="mt-4"></div>
            </div>
        </div>

        <!-- 資料維護視圖 -->
        <div id="view-maintenance" class="view-container hidden-view fade-in">
             <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="border-b border-gray-200"><nav class="flex space-x-1" id="maintenance-sub-tabs"></nav></div>
                <div id="maintenance-panes-container" class="mt-4"></div>
            </div>
        </div>

        <!-- 庫存紀錄視圖 -->
        <div id="view-logs" class="view-container hidden-view fade-in">
             <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="border-b border-gray-200"><nav class="flex space-x-1" id="log-sub-tabs"></nav></div>
                <div id="log-content-container" class="mt-4"></div>
            </div>
        </div>
        
        <!-- 儲位視圖 -->
        <div id="view-locations" class="view-container hidden-view fade-in">
             <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">儲位管理</h2>
                    <button id="add-location-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">新增儲位</button>
                </div>
                <div id="locations-list" class="mt-2"></div>
             </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden modal"></div>
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform -translate-y-10"></div>
    </div>

<script>
    // --- Data Layer ---
    let products = [
        { sku: 'NZ-AMB-70S', category: 'large_fruit', name: '紐西蘭Ambrosia', details: { category: '進口水果', fruitType: '蘋果', variety: 'Ambrosia', country: '紐西蘭', region: '', size: '70s', grade: 'PG', brand: 'Luvya' } },
        { sku: 'CA-KOR-8.5R', category: 'large_fruit', name: '加拿大Kordia', details: { category: '進口水果', fruitType: '櫻桃', variety: 'Kordia', country: '加拿大', region: '', size: '8.5 Row', grade: 'Dark', brand: 'Kordia' } },
        { sku: 'JP-CAT-700G', category: 'large_fruit', name: '日本岡山貓眼', details: { category: '進口水果', fruitType: '葡萄', variety: '貓眼', country: '日本', region: '岡山', size: '700g/串', grade: '特秀', brand: '' } },
        // 測試用的富士蘋果品項 - 用來測試自動帶入功能
        { sku: 'JP-FUJI-AAA', category: 'large_fruit', name: '富士', details: { category: '進口水果', fruitType: '蘋果', variety: '富士', country: '日本', region: '青森', size: '32粒', grade: 'AAA', brand: '三朵花' } },
        { sku: 'US-GALA-AAA', category: 'large_fruit', name: 'Gala蘋果', details: { category: '進口水果', fruitType: '蘋果', variety: 'Gala', country: '美國', region: '華盛頓', size: '36粒', grade: 'AAA', brand: '' } },
        // 示範：台灣水果資料 - 系統會自動偵測「台灣」和「台中」關鍵字
        { sku: 'TW-APP-01', category: 'large_fruit', name: '台灣蘋果', details: { category: '進口水果', fruitType: '蘋果', variety: '富士', country: '台灣', region: '台中', size: '32粒', grade: 'A', brand: '' } },
        // 示範：狐狸頭匯入的水果資料
        { 
            sku: 'NZ-FUJI-TEST', 
            category: 'large_fruit', 
            name: '紐西蘭富士蘋果', 
            details: { 
                category: '進口水果', 
                fruitType: '蘋果', 
                variety: '富士', 
                country: '紐西蘭', 
                region: '奧克蘭', 
                size: '32粒', 
                grade: 'AAA', 
                brand: 'ROCKIT' 
            },
            foxImportData: {
                originalName: '紐西蘭(雙) 富士蘋果 ROCKIT AAA',
                importDate: '2024/01/15',
                fruitType: 'APP-NZ',
                size: '32',
                variety: 'FUJI',
                brand: 'ROCKIT',
                quantity: 100,
                unitPrice: 1250,
                category: '進口水果',
                country: '紐西蘭',
                region: '奧克蘭',
                grade: 'AAA',
                transactionType: '進貨',
                transactionCode: 'PUR001',
                customer: 'ABC水果商',
                eta: '2024/01/20',
                containerNumber: 'ABCD1234567',
                documentNumber: 'DOC001',
                coldStorage: '1號冰庫',
                company: 'A公司',
                importTimestamp: '2024-01-15T10:30:00.000Z'
            }
        },
        { sku: 'PKG-APP-12P', category: 'small_fruit', name: '#12 日本蘋果盒 (12顆/盒)' },
        { sku: 'PKG-CHERRY-2KG', category: 'small_fruit', name: '2KG 櫻桃盒' },
        { sku: 'PKG-GRAPE-1S', category: 'small_fruit', name: '單串精裝禮盒' },
        { sku: 'BOX-APP-12P', category: 'packaging', name: '#12 日本蘋果盒', details: { spec: '12顆裝', price: 20, type: 'box', defaultStorageLocation: '主倉-A1' } },
        { sku: 'BOX-CHERRY-2KG', category: 'packaging', name: '2KG 櫻桃盒', details: { spec: '2KG裝', price: 15, type: 'box', defaultStorageLocation: '主倉-A1' } },
        { sku: 'BOX-GRAPE-1S', category: 'packaging', name: '單串精裝禮盒', details: { spec: '單串裝', price: 50, type: 'box', defaultStorageLocation: '主倉-A1' } },
        { sku: 'BND-STD-RED', category: 'packaging', name: '束帶-紅', details: { spec: '標準束帶', price: 1, type: 'strap', defaultStorageLocation: '主倉-B2' } },
        { sku: 'BND-STD-GRN', category: 'packaging', name: '束帶-綠', details: { spec: '標準束帶', price: 1, type: 'strap', defaultStorageLocation: '主倉-B2' } },
        { sku: 'INB-APP-12P', category: 'packaging', name: '內帶-蘋果12', details: { spec: '12顆內袋', price: 2, type: 'inner_bag', defaultStorageLocation: '副倉-C1' } },
        { sku: 'SLEEVE-APPLE-S', category: 'packaging', name: '果套-小', details: { spec: '小', price: 1, type: 'fruit_sleeve', defaultStorageLocation: '副倉-C1' } },
        { sku: 'CARD-PVC-S', category: 'packaging', name: '塑膠民片-小', details: { spec: '小', price: 0.5, type: 'plastic_card', defaultStorageLocation: '副倉-C1' } },
        { sku: 'STKR-LOGO-S', category: 'packaging', name: '貼紙-LOGO小', details: { spec: 'LOGO', price: 0.2, type: 'sticker', defaultStorageLocation: '副倉-C1' } },
        { sku: 'BAG-PAPER-M', category: 'packaging', name: '提袋-中', details: { spec: '紙袋 中', price: 5, type: 'tote_bag', defaultStorageLocation: '主倉-B2' } },
        { sku: 'CUST-DEMO-1', category: 'packaging', name: '自訂類別-示例品', details: { spec: 'DEMO', price: 3, type: 'custom_demo', defaultStorageLocation: null } },
    ];
    // 可被管理的包材類別（可新增/刪除/重新命名）
    let packagingCategories = [
        { key: 'box', name: '盒子' },
        { key: 'strap', name: '束帶' },
        { key: 'inner_bag', name: '內帶' },
        { key: 'fruit_sleeve', name: '果套' },
        { key: 'plastic_card', name: '塑膠民片' },
        { key: 'sticker', name: '貼紙' },
        { key: 'tote_bag', name: '提袋' },
        { key: 'custom_demo', name: '自訂' },
    ];
    
    // 常用包材組合資料
    let favoritePackagingCombos = [
        {
            id: 'combo-demo-1',
            name: '蘋果標準組合',
            boxSku: 'BOX-APP-12P',
            additionalSkus: ['BND-STD-RED', 'INB-APP-12P'],
            visible: true,
            createdAt: new Date('2025-01-01')
        },
        {
            id: 'combo-demo-2', 
            name: '櫻桃豪華組合',
            boxSku: 'BOX-CHERRY-2KG',
            additionalSkus: ['BND-STD-GRN', 'BAG-PAPER-M'],
            visible: true,
            createdAt: new Date('2025-01-02')
        },
        {
            id: 'combo-demo-3',
            name: '隱藏測試組合',
            boxSku: 'BOX-GRAPE-1S',
            additionalSkus: ['STKR-LOGO-S'],
            visible: true,
            createdAt: new Date('2025-01-03')
        }
    ];
    let inventory = [
        { sku: 'NZ-AMB-70S', quantity: 50, unitCost: 2200, lots: [{lotNumber: 'A-1722888001', quantity: 20}, {lotNumber: 'A-1722888002', quantity: 30}] }, 
        { sku: 'CA-KOR-8.5R', quantity: 8, unitCost: 3500, lots: [{lotNumber: 'B-1722888003', quantity: 8}] }, 
        { sku: 'JP-CAT-700G', quantity: 100, unitCost: 1800, lots: [{lotNumber: 'C-1722888004', quantity: 100}] },
        { sku: 'JP-FUJI-AAA', quantity: 80, unitCost: 1500, lots: [{lotNumber: 'D-1722888005', quantity: 80}] },
        { sku: 'US-GALA-AAA', quantity: 60, unitCost: 1800, lots: [{lotNumber: 'E-1722888006', quantity: 60}] },
        { sku: 'TW-APP-01', quantity: 120, unitCost: 800, lots: [{lotNumber: 'F-1722888007', quantity: 120}] },
        // 示範：狐狸頭匯入的水果庫存
        { sku: 'NZ-FUJI-TEST', quantity: 100, unitCost: 1250, lots: [{lotNumber: 'FOX-1234567', quantity: 100}] },
        { sku: 'PKG-APP-12P', quantity: 0 }, { sku: 'PKG-CHERRY-2KG', quantity: 0 }, { sku: 'PKG-GRAPE-1S', quantity: 0 },
        { sku: 'BOX-APP-12P', quantity: 500 }, { sku: 'BOX-CHERRY-2KG', quantity: 5 }, { sku: 'BOX-GRAPE-1S', quantity: 100 },
        { sku: 'BND-STD-RED', quantity: 200 }, { sku: 'BND-STD-GRN', quantity: 180 },
        { sku: 'INB-APP-12P', quantity: 120 }, { sku: 'SLEEVE-APPLE-S', quantity: 400 },
        { sku: 'CARD-PVC-S', quantity: 350 }, { sku: 'STKR-LOGO-S', quantity: 1000 },
        { sku: 'BAG-PAPER-M', quantity: 80 }, { sku: 'CUST-DEMO-1', quantity: 60 },
    ];
    let workOrders = [
        { id: 'WO-20250811-001', status: '待處理', largeItemSku: 'NZ-AMB-70S', sourceLotNumber: 'A-1722888001', smallItemSku: 'PKG-APP-12P', boxSku: 'BOX-APP-12P', retailRequest: { note: '客戶急單，請優先處理。' }, warehouseInfo: { requestUnits: 2, dispatchedUnits: 0, dispatchedBy: '', dispatchedAt: null, returnedUnits: 0 }, packagingResult: { receivedUnits: 0, producedCount: 0, ngCount: 0, completedBy: '', completedAt: null }, costing: { unitCost: 2100, finalCostPerPackage: 0 } },
        { id: 'WO-20250725-001', status: '已完成', largeItemSku: 'CA-KOR-8.5R', sourceLotNumber: 'B-1722888003', smallItemSku: 'PKG-CHERRY-2KG', boxSku: 'BOX-CHERRY-2KG', retailRequest: { note: '' }, warehouseInfo: { requestUnits: 5, dispatchedUnits: 5, dispatchedBy: '倉儲-王大哥', dispatchedAt: new Date('2025-07-25T10:30:00'), returnedUnits: 0 }, packagingResult: { receivedUnits: 5, producedCount: 10, ngCount: 1, completedBy: '包裝-陳小姐', completedAt: new Date('2025-07-25T15:00:00') }, costing: { unitCost: 3500, finalCostPerPackage: 1765 } },
        { id: 'WO-20250810-003', status: '已完成', largeItemSku: 'JP-CAT-700G', sourceLotNumber: 'C-1722888004', smallItemSku: 'PKG-GRAPE-1S', boxSku: 'BOX-GRAPE-1S', retailRequest: { note: 'VIP客戶送禮用，請仔細挑選。' }, warehouseInfo: { requestUnits: 10, dispatchedUnits: 10, dispatchedBy: '倉儲-王大哥', dispatchedAt: new Date('2025-08-10T09:15:00'), returnedUnits: 1 }, packagingResult: { receivedUnits: 10, producedCount: 18, ngCount: 2, completedBy: '包裝-李小姐', completedAt: new Date('2025-08-10T14:00:00') }, costing: { unitCost: 800, finalCostPerPackage: 450 } }
    ];
    let inventoryLog = [];
    let storageLocations = ['主倉-A1', '主倉-B2', '副倉-C1'];
    
    // 最低庫存量設定資料
    let minStockSettings = {
        large_fruit: {}, // SKU: minQuantity
        packaging: {}    // SKU: minQuantity
    };
    
    // 全域包材選擇狀態
    let selectedBoxSku = '';
    let selectedAdditional = new Set();
    let charts = {};

    // --- State Management ---
    let currentRole = ''; let selectedWorkOrderId = null; let currentView = 'work_orders';
    let currentMaintenanceTab = 'fruit-pane'; // 記住當前的資料維護分頁
    let currentWorkOrderStatusFilter = '待處理'; // 門市人員的工單狀態篩選

    // --- DOM Elements ---
    const mainTabsContainer = document.getElementById('main-tabs');
    const roleSwitcher = document.getElementById('role-switcher');
    const workOrderListContainer = document.getElementById('work-order-list');
    const workOrderDetailsContainer = document.getElementById('work-order-details');
    const inventoryPanesContainer = document.getElementById('inventory-panes-container');
    const inventorySubTabs = document.getElementById('inventory-sub-tabs');
    const maintenancePanesContainer = document.getElementById('maintenance-panes-container');
    const maintenanceSubTabs = document.getElementById('maintenance-sub-tabs');
    const dashboardContainer = document.getElementById('dashboard-container');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContainer = document.getElementById('modal-container');
    const modalContent = document.getElementById('modal-content');
    const currentRoleDisplay = document.getElementById('current-role-display');
    const logSubTabsContainer = document.getElementById('log-sub-tabs');
    const logContentContainer = document.getElementById('log-content-container');

    // --- Helper Functions ---
    const findProduct = (sku) => products.find(p => p.sku === sku);
    const findStock = (sku) => inventory.find(i => i.sku === sku);
    
    // 取得小件成品對應的水果品名
    const getSmallItemDisplayName = (sku) => {
        const product = findProduct(sku);
        if (!product || product.category !== 'small_fruit') {
            return product ? product.name : '未知品項';
        }
        
        // 根據工單找到對應的大件原料和包裝信息
        const workOrder = workOrders.find(wo => wo.smallItemSku === sku);
        if (workOrder) {
            const largeProduct = findProduct(workOrder.largeItemSku);
            const boxProduct = findProduct(workOrder.boxSku);
            
            if (largeProduct && largeProduct.details) {
                // 構建新的顯示格式：(國家 區域 品種 規格 包裝)
                const country = largeProduct.details.country || '';
                const region = largeProduct.details.region || '';
                const variety = largeProduct.details.variety || '';
                const size = largeProduct.details.size || '';
                const packaging = boxProduct?.details?.spec || '';
                
                // 組合各部分，過濾空值，移除所有空格
                const parts = [country, region, variety, size, packaging]
                    .filter(part => part.trim() !== '')
                    .map(part => part.replace(/\s+/g, '')); // 移除所有空格
                
                if (parts.length > 0) {
                    return parts.join('');
                }
            }
            
            // 如果數據不完整，回退到原來的格式
            if (largeProduct) {
                const fruitType = largeProduct.name.match(/(蘋果|櫻桃|葡萄)/)?.[1];
                if (largeProduct.details?.variety && fruitType) {
                    return `${largeProduct.details.variety} ${fruitType}`;
                }
                return largeProduct.name;
            }
        }
        
        return product.name;
    };
    
    const addInventoryLog = (sku, type, quantity, remark, lotNumber = null, unitCost = 0, storageLocation = undefined) => { 
        const product = findProduct(sku); 
        const displayName = product && product.category === 'small_fruit' ? getSmallItemDisplayName(sku) : (product ? product.name : '未知品項');
        inventoryLog.unshift({ timestamp: new Date(), sku: sku, productName: displayName, type: type, quantity: quantity, remark: remark, lotNumber, unitCost, storageLocation }); 
    };
    
    // 計算包材組合總價格
    const calculateComboTotalPrice = (boxSku, additionalSkus) => {
        let totalPrice = 0;
        
        // 盒子價格 - 只有當盒子存在時才計算
        if (boxSku) {
            const boxProduct = findProduct(boxSku);
            if (boxProduct && boxProduct.details && boxProduct.details.price) {
                totalPrice += boxProduct.details.price;
            }
        }
        
        // 其他包材價格 - 過濾掉不存在的包材
        if (Array.isArray(additionalSkus)) {
            additionalSkus.forEach(sku => {
                const product = findProduct(sku);
                if (product && product.details && product.details.price) {
                    totalPrice += product.details.price;
                }
            });
        }
        
        return totalPrice;
    };
    
    // 檢查哪些常用組合使用了特定的包材
    const findCombosUsingSku = (sku) => {
        return favoritePackagingCombos.filter(combo => {
            return combo.boxSku === sku || combo.additionalSkus.includes(sku);
        });
    };
    
    // 檢查哪些常用組合使用了特定類別的包材
    const findCombosUsingCategory = (categoryKey) => {
        const categoryProducts = products.filter(p => p.category === 'packaging' && p.details?.type === categoryKey);
        const categorySkus = categoryProducts.map(p => p.sku);
        
        return favoritePackagingCombos.filter(combo => {
            return categorySkus.includes(combo.boxSku) || combo.additionalSkus.some(sku => categorySkus.includes(sku));
        });
    };
    
    // 清理所有常用組合中的無效包材
    const cleanupInvalidPackagingInCombos = () => {
        let removedEmptyCount = 0;
        let cleanedCombos = 0;
        
        console.log('開始清理無效包材，組合總數:', favoritePackagingCombos.length);
        
        // 清理無效的包材
        favoritePackagingCombos.forEach(combo => {
            const originalBoxSku = combo.boxSku;
            const originalAdditionalCount = combo.additionalSkus.length;
            
            // 檢查盒子是否還存在
            if (combo.boxSku && !findProduct(combo.boxSku)) {
                combo.boxSku = '';
                console.log(`組合「${combo.name}」的盒子 ${originalBoxSku} 已被清理`);
                cleanedCombos++;
            }
            
            // 過濾掉不存在的其他包材
            const validAdditionalSkus = combo.additionalSkus.filter(sku => findProduct(sku));
            if (validAdditionalSkus.length !== originalAdditionalCount) {
                const removedSkus = combo.additionalSkus.filter(sku => !findProduct(sku));
                combo.additionalSkus = validAdditionalSkus;
                console.log(`組合「${combo.name}」移除了無效包材:`, removedSkus);
                cleanedCombos++;
            }
        });
        
        // 移除完全沒有包材的空組合
        for (let i = favoritePackagingCombos.length - 1; i >= 0; i--) {
            const combo = favoritePackagingCombos[i];
            if (!combo.boxSku && combo.additionalSkus.length === 0) {
                console.log(`移除空組合「${combo.name}」`);
                favoritePackagingCombos.splice(i, 1);
                removedEmptyCount++;
            }
        }
        
        console.log(`清理完成: ${cleanedCombos} 個組合被清理, ${removedEmptyCount} 個空組合被移除`);
        return removedEmptyCount;
    };

    // 從組合中移除已刪除的包材
    const cleanupComboAfterDeletion = (deletedSkus) => {
        // 記錄需要移除的空組合
        const combosToRemove = [];
        
        favoritePackagingCombos.forEach((combo, index) => {
            // 如果盒子被刪除，將其設為空
            if (deletedSkus.includes(combo.boxSku)) {
                combo.boxSku = '';
            }
            
            // 移除已刪除的其他包材
            combo.additionalSkus = combo.additionalSkus.filter(sku => !deletedSkus.includes(sku));
            
            // 檢查組合是否變成空的（沒有盒子且沒有其他包材）
            if (!combo.boxSku && combo.additionalSkus.length === 0) {
                combosToRemove.push(index);
            }
        });
        
        // 從後往前移除空組合，避免索引錯位
        combosToRemove.reverse().forEach(index => {
            favoritePackagingCombos.splice(index, 1);
        });
        
        return combosToRemove.length; // 返回被移除的空組合數量
    };
    
    // 工單編號：WO-YYYYMMDD-<5碼全域碼>
    function generateWorkOrderId(prefix = 'WO') {
        const date = new Date();
        const ymd = date.toISOString().slice(0,10).replace(/-/g, "");
        const alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const generateCode = (len = 5) => {
            try {
                if (typeof crypto !== 'undefined' && typeof crypto.getRandomValues === 'function') {
                    const buf = new Uint8Array(len);
                    crypto.getRandomValues(buf);
                    return Array.from(buf).map(b => alphabet[b % alphabet.length]).join('');
                }
            } catch (e) { /* ignore and fallback */ }
            let code = '';
            for (let i = 0; i < len; i++) {
                code += alphabet[Math.floor(Math.random() * alphabet.length)];
            }
            return code;
        };
        const uniquePart = generateCode(5);
        return `${prefix}-${ymd}-${uniquePart}`;
    }
    // 大件原料工號：<SKU前綴>-YYYYMMDD-<5碼>
    function generateLotNumberForSku(sku) {
        const prefix = (sku && sku.split('-')[0] ? sku.split('-')[0] : 'NN').toUpperCase();
        const ymd = new Date().toISOString().slice(0,10).replace(/-/g, "");
        const alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const generateCode = (len = 5) => {
            try {
                if (typeof crypto !== 'undefined' && typeof crypto.getRandomValues === 'function') {
                    const buf = new Uint8Array(len);
                    crypto.getRandomValues(buf);
                    return Array.from(buf).map(b => alphabet[b % alphabet.length]).join('');
                }
            } catch (e) { /* ignore and fallback */ }
            let code = '';
            for (let i = 0; i < len; i++) {
                code += alphabet[Math.floor(Math.random() * alphabet.length)];
            }
            return code;
        };
        const exists = (lotNo) => inventory.some(item => Array.isArray(item.lots) && item.lots.some(l => l.lotNumber === lotNo));
        let lotNumber = `${prefix}-${ymd}-${generateCode(5)}`;
        while (exists(lotNumber)) {
            lotNumber = `${prefix}-${ymd}-${generateCode(5)}`;
        }
        return lotNumber;
    }

    // 自動生成包材 SKU
    function generatePackagingSku(category, name) {
        // 根據包材類別決定前綴
        const categoryPrefixes = {
            'box': 'BOX',
            'strap': 'BND',
            'inner_bag': 'INB',
            'fruit_sleeve': 'SLV',
            'plastic_card': 'CRD',
            'sticker': 'STK',
            'tote_bag': 'BAG',
            'custom_demo': 'CST'
        };
        
        const prefix = categoryPrefixes[category] || 'PKG';
        
        // 從名稱中提取關鍵字
        let keyPart = '';
        if (name.includes('蘋果')) keyPart += 'APP';
        else if (name.includes('櫻桃')) keyPart += 'CHR';
        else if (name.includes('葡萄')) keyPart += 'GRP';
        else if (name.includes('紅')) keyPart += 'RED';
        else if (name.includes('綠')) keyPart += 'GRN';
        else if (name.includes('小')) keyPart += 'S';
        else if (name.includes('中')) keyPart += 'M';
        else if (name.includes('大')) keyPart += 'L';
        else {
            // 如果沒有特殊關鍵字，使用隨機字母
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                keyPart += alphabet[Math.floor(Math.random() * alphabet.length)];
            }
        }
        
        // 生成唯一的數字後綴
        let counter = 1;
        let sku = `${prefix}-${keyPart}-${counter.toString().padStart(2, '0')}`;
        
        // 確保 SKU 唯一
        while (products.some(p => p.sku === sku)) {
            counter++;
            sku = `${prefix}-${keyPart}-${counter.toString().padStart(2, '0')}`;
        }
        
        return sku;
    }

    // 自動生成水果 SKU
    function generateFruitSku(name, country, variety) {
        // 國家代碼對應
        const countryPrefixes = {
            '紐西蘭': 'NZ',
            '加拿大': 'CA',
            '日本': 'JP',
            '美國': 'US',
            '智利': 'CL',
            '澳洲': 'AU',
            '台灣': 'TW',
            '韓國': 'KR',
            '泰國': 'TH'
        };
        
        const countryCode = countryPrefixes[country] || 'XX';
        
        // 從品種或名稱提取縮寫
        let varietyCode = '';
        if (variety) {
            // 如果有品種，使用品種的前3個字符
            varietyCode = variety.replace(/\s/g, '').toUpperCase().substring(0, 3);
        } else {
            // 如果沒有品種，從名稱提取
            if (name.includes('蘋果')) varietyCode = 'APP';
            else if (name.includes('櫻桃')) varietyCode = 'CHR';
            else if (name.includes('葡萄')) varietyCode = 'GRP';
            else if (name.includes('橘子')) varietyCode = 'ORA';
            else if (name.includes('梨')) varietyCode = 'PEA';
            else {
                // 使用名稱的前3個字符
                varietyCode = name.replace(/\s/g, '').substring(0, 3).toUpperCase();
            }
        }
        
        // 生成唯一的後綴
        let counter = 1;
        let sku = `${countryCode}-${varietyCode}-${counter.toString().padStart(2, '0')}`;
        
        // 確保 SKU 唯一
        while (products.some(p => p.sku === sku)) {
            counter++;
            sku = `${countryCode}-${varietyCode}-${counter.toString().padStart(2, '0')}`;
        }
        
        return sku;
    }
    
    // --- Modal Logic ---
    function openModal(contentHtml, size = 'max-w-lg') { 
        modalContent.innerHTML = contentHtml; 
        modalContent.className = `bg-white rounded-lg shadow-xl w-full ${size} modal-content transform -translate-y-10`; 
        modalBackdrop.classList.remove('hidden'); 
        modalContainer.classList.remove('hidden'); 
        
        // 添加點擊外部關閉功能
        modalBackdrop.onclick = (e) => {
            if (e.target === modalBackdrop) {
                closeModal();
            }
        };
        
        setTimeout(() => { 
            modalBackdrop.style.opacity = '1'; 
            modalContent.style.transform = 'translateY(0)'; 
        }, 10); 
    }
    
    function closeModal() { 
        modalBackdrop.style.opacity = '0'; 
        modalContent.style.transform = 'translateY(-40px)'; 
        
        // 移除點擊事件監聽器
        modalBackdrop.onclick = null;
        
        setTimeout(() => { 
            modalBackdrop.classList.add('hidden'); 
            modalContainer.classList.add('hidden'); 
            modalContent.innerHTML = ''; 
        }, 250); 
    }
    
    // --- 通用訊息模態框 ---
    function openErrorModal(message) {
        const modalHtml = `
            <div class="p-6 space-y-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-semibold text-gray-900">錯誤</h3>
                        <p class="text-sm text-gray-500 mt-1">${message}</p>
                    </div>
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="button" class="ok-btn bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition-colors">確定</button>
                </div>
            </div>`;
        
        openModal(modalHtml);
        document.querySelector('.ok-btn').addEventListener('click', closeModal);
    }
    
    function openSuccessModal(message, callback = null) {
        const modalHtml = `
            <div class="p-6 space-y-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-semibold text-gray-900">成功</h3>
                        <p class="text-sm text-gray-500 mt-1">${message}</p>
                    </div>
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="button" class="ok-btn bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">確定</button>
                </div>
            </div>`;
        
        openModal(modalHtml);
        document.querySelector('.ok-btn').addEventListener('click', () => {
            closeModal();
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 100); // 稍微延遲執行回調函數
            }
        });
    }

    // --- UI Update Logic ---
    function updateRoleDisplayAndTabs(role, roleName) {
        if (role) {
            currentRoleDisplay.textContent = `目前角色：${roleName}`;
            currentRoleDisplay.classList.remove('hidden');
        } else {
            currentRoleDisplay.classList.add('hidden');
        }

        const isPrivileged = role === 'retail';
        document.querySelectorAll('.main-tab').forEach(tab => {
            const view = tab.dataset.view;
            if (view === 'dashboard' && !isPrivileged) {
                 tab.classList.add('hidden');
            } else if (!isPrivileged && ['inventory', 'maintenance', 'logs'].includes(view)) {
                // Allow packaging to see locations, but not other non-privileged roles
                tab.classList.add('hidden');
            } else if (role === 'warehouse' && view === 'locations') {
                tab.classList.add('hidden');
            }
            else {
                tab.classList.remove('hidden');
            }
        });

        const currentTab = document.querySelector(`.main-tab[data-view="${currentView}"]`);
        if (currentTab && currentTab.classList.contains('hidden')) {
            currentView = 'work_orders';
        }
    }

    // --- Rendering Logic ---
    function renderApp() {
        updateRoleDisplayAndTabs(currentRole, document.querySelector(`.role-btn[data-role="${currentRole}"]`)?.dataset.roleName);
        document.querySelectorAll('.view-container').forEach(view => view.classList.add('hidden-view'));
        document.getElementById(`view-${currentView}`).classList.remove('hidden-view');
        document.querySelectorAll('.main-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.view === currentView));
        
        if (currentView === 'dashboard') { renderDashboard(); }
        else if (currentView === 'work_orders') { renderWorkOrderList(); renderWorkOrderDetails(); } 
        else if (currentView === 'inventory') { renderInventory(); }
        else if (currentView === 'maintenance') { renderMaintenance(); }
        else if (currentView === 'logs') { renderLogView(); }
        else if (currentView === 'locations') { renderLocations(); }
    }

    function createSubTabs(container, panesContainer, tabsConfig, onTabClick, activeTabId = null) {
        container.innerHTML = '';
        panesContainer.innerHTML = '';
        
        // 找到應該激活的分頁索引
        let activeIndex = 0;
        if (activeTabId) {
            const foundIndex = tabsConfig.findIndex(tab => tab.id === activeTabId);
            if (foundIndex !== -1) {
                activeIndex = foundIndex;
            }
        }
        
        tabsConfig.forEach((tab, index) => {
            const tabButton = document.createElement('button');
            const isActive = index === activeIndex;
            tabButton.className = `sub-tab -mb-px border border-b-0 rounded-t-md py-2 px-4 text-sm font-medium ${isActive ? 'active' : 'bg-gray-100 hover:bg-gray-200'}`;
            tabButton.textContent = tab.title;
            tabButton.dataset.pane = tab.id;
            container.appendChild(tabButton);
            const pane = document.createElement('div');
            pane.id = tab.id;
            pane.className = `sub-pane p-4 border rounded-b-md rounded-r-md ${!isActive ? 'hidden-pane' : ''}`;
            pane.innerHTML = tab.content;
            panesContainer.appendChild(pane);
        });
        
        container.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const paneId = e.target.dataset.pane;
                
                container.querySelectorAll('.sub-tab').forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('bg-gray-100', 'hover:bg-gray-200');
                });
                e.target.classList.add('active');
                e.target.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                panesContainer.querySelectorAll('.sub-pane').forEach(p => p.classList.add('hidden-pane'));
                panesContainer.querySelector(`#${paneId}`).classList.remove('hidden-pane');
                if (onTabClick) onTabClick(paneId);
            }
        });
    }

    function renderInventory() {
        const categories = [
            { id: 'large-items-pane', title: '大件原料', type: 'large_fruit', unit: '箱/串', allowStockIn: true },
            { id: 'packaging-items-pane', title: '包材', type: 'packaging', unit: '個', allowStockIn: true },
            { id: 'small-items-pane', title: '小件成品', type: 'small_fruit', unit: '個', allowStockIn: false }
        ];

        const tabsConfig = categories.map(cat => {
            if (cat.type === 'packaging') {
                // 只放置內層分頁容器，內容由 initPackagingTabs 渲染
                const content = `
                    <div class=\"border-b border-gray-200\">
                        <nav class=\"flex space-x-1\" id=\"packaging-sub-tabs\"></nav>
                    </div>
                    <div id=\"packaging-panes-container\" class=\"mt-4\"></div>
                `;
                return { id: cat.id, title: cat.title, content };
            }
            // 其他類別維持原表格
            let tableHeader, tableRows;
            
            if (cat.type === 'large_fruit') {
                // 大件原料添加單位成本欄位，新增狐狸頭@水果品名和檢視功能
                tableHeader = `<tr>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">品項</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="min-width: 200px; max-width: 300px;">狐狸頭@水果品名</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">庫存數量 (${cat.unit})</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">大件單位成本</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">檢視</th>
                    </tr>`;
                tableRows = inventory.filter(i => findProduct(i.sku)?.category === cat.type).map(stockItem => {
                const product = findProduct(stockItem.sku);
                    if (!product) return '';
                    const unitCost = stockItem.unitCost ? `$${stockItem.unitCost.toLocaleString()}` : '未設定';
                    
                    // 檢查是否有狐狸頭匯入資料
                    const foxImportName = product.foxImportData?.originalName || '';
                    const hasFoxData = product.foxImportData ? true : false;
                    
                    return `<tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="text-sm font-medium text-gray-900">${product.name}</div>
                        </td>
                        <td class="px-6 py-4 text-center" style="min-width: 200px; max-width: 300px; white-space: nowrap; overflow: visible;">
                            <div class="text-sm text-gray-600">${foxImportName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold ${getLowStockWarningClass(stockItem.sku, stockItem.quantity, cat.type)}">${getLowStockWarningIcon(stockItem.sku, stockItem.quantity, cat.type)} ${stockItem.quantity.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold text-green-600">${unitCost}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            ${hasFoxData ? `<button onclick="viewFoxImportData('${product.sku}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium" title="檢視狐狸頭匯入資料">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>` : '<span class="text-gray-400 text-sm">-</span>'}
                        </td>
                    </tr>`;
            }).join('');
            } else {
                // 其他類別維持原有結構，隱藏SKU
                tableHeader = `<tr>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">品項</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">庫存數量 (${cat.unit})</th>
                    </tr>`;
                tableRows = inventory.filter(i => findProduct(i.sku)?.category === cat.type).map(stockItem => {
                    const product = findProduct(stockItem.sku);
                    if (!product) return '';
                    // 對小件成品使用水果品名顯示
                    const displayName = product.category === 'small_fruit' ? getSmallItemDisplayName(stockItem.sku) : product.name;
                    return `<tr class="hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-center"><div class="text-sm font-medium text-gray-900">${displayName}</div></td><td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold text-gray-800">${stockItem.quantity.toLocaleString()}</td></tr>`;
                }).join('');
            }
            const foxImportBtn = cat.type === 'large_fruit' ? `<button data-type="${cat.type}" class="fox-import-btn bg-orange-500 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-orange-600">狐狸頭匯入</button>` : '';
            const content = `<div class="flex justify-end gap-2 mb-4">${cat.allowStockIn ? `<button data-type="${cat.type}" class="stock-in-btn bg-green-500 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-green-600">入庫</button>` : ''}${foxImportBtn}<button data-type="${cat.type}" class="adjust-btn bg-yellow-500 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-yellow-600">異動</button></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50">${tableHeader}</thead><tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody></table></div>`;
            return { id: cat.id, title: cat.title, content };
        });

        createSubTabs(inventorySubTabs, inventoryPanesContainer, tabsConfig, (paneId) => {
            if (paneId === 'packaging-items-pane') { initPackagingTabs(); }
            attachInventoryActionListeners();
        });

        // 初次渲染時也建立包材內層分頁
        initPackagingTabs();
        attachInventoryActionListeners();

        function initPackagingTabs() {
            const subNav = document.getElementById('packaging-sub-tabs');
            const panes = document.getElementById('packaging-panes-container');
            if (!subNav || !panes) return;

            const packagingTabsConfig = packagingCategories.map(group => {
                const stocks = inventory.filter(i => {
                    const p = findProduct(i.sku);
                    return p && p.category === 'packaging' && p.details?.type === group.key;
                });
                let rows = '';
                if (stocks.length > 0) {
                    rows = stocks.map(stockItem => {
                        const product = findProduct(stockItem.sku);
                        const locationQuantities = {};
                        inventoryLog.filter(log => log.sku === stockItem.sku && log.storageLocation).forEach(log => {
                            locationQuantities[log.storageLocation] = (locationQuantities[log.storageLocation] || 0) + log.quantity;
                        });
                        const locationDetailHtml = Object.entries(locationQuantities)
                            .filter(([, qty]) => qty > 0)
                            .map(([loc, qty]) => `<div class="text-xs">${loc}: <span class="font-medium">${qty.toLocaleString()}</span></div>`)
                            .join('') || '<span class="text-xs text-gray-400">無儲位資訊</span>';
                        return `<tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="text-sm font-medium text-gray-900">${product.name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold ${getLowStockWarningClass(stockItem.sku, stockItem.quantity, cat.type)}">${getLowStockWarningIcon(stockItem.sku, stockItem.quantity, cat.type)} ${stockItem.quantity.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">${locationDetailHtml}</td>
                        </tr>`;
                    }).join('');
                } else {
                    rows = `<tr><td class="px-6 py-4 text-center text-sm text-gray-500" colspan="3">此類別尚無品項</td></tr>`;
                }
                const header = `<tr>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">品項</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">總庫存 (個)</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">儲位庫存詳情</th>
                </tr>`;
                const content = `<div class="flex justify-end gap-2 mb-4">
                    <button data-type="packaging" data-subtype="${group.key}" class="stock-in-btn bg-green-500 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-green-600">入庫</button>
                    <button data-type="packaging" data-subtype="${group.key}" class="adjust-btn bg-yellow-500 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-yellow-600">異動</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">${header}</thead>
                        <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
                    </table>
                </div>`;
                return { id: `pkg-pane-${group.key}`, title: group.name, content };
            });

            createSubTabs(subNav, panes, packagingTabsConfig, () => attachInventoryActionListeners());
        }
        // 讓外部模組（管理類別彈窗）可以重新初始化
        window.initPackagingTabs = initPackagingTabs;
        
        // 只更新特定包材子類型的表格，避免整頁重新渲染
        function updatePackagingSubtypeTable(subtypeKey) {
            const targetPane = document.getElementById(`pkg-pane-${subtypeKey}`);
            if (!targetPane) {
                console.log(`找不到包材分頁: pkg-pane-${subtypeKey}`);
                return;
            }
            
            const tableBody = targetPane.querySelector('tbody');
            if (!tableBody) {
                console.log(`找不到表格 tbody 在分頁: pkg-pane-${subtypeKey}`);
                return;
            }
            
            // 重新生成該子類型的表格內容
            const stocks = inventory.filter(i => {
                const p = findProduct(i.sku);
                return p && p.category === 'packaging' && p.details?.type === subtypeKey;
            });
            
            let rows = '';
            if (stocks.length > 0) {
                rows = stocks.map(stockItem => {
                    const product = findProduct(stockItem.sku);
                    const locationQuantities = {};
                    inventoryLog.filter(log => log.sku === stockItem.sku && log.storageLocation).forEach(log => {
                        locationQuantities[log.storageLocation] = (locationQuantities[log.storageLocation] || 0) + log.quantity;
                    });
                    const locationDetailHtml = Object.entries(locationQuantities)
                        .filter(([, qty]) => qty > 0)
                        .map(([loc, qty]) => `<div class="text-xs">${loc}: <span class="font-medium">${qty.toLocaleString()}</span></div>`)
                        .join('') || '<span class="text-xs text-gray-400">無儲位資訊</span>';
                    return `<tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="text-sm font-medium text-gray-900">${product.name}</div>
                            <div class="text-xs text-gray-500">${product.sku}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold ${getLowStockWarningClass(stockItem.sku, stockItem.quantity, 'packaging')}">${getLowStockWarningIcon(stockItem.sku, stockItem.quantity, 'packaging')} ${stockItem.quantity.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${locationDetailHtml}</td>
                    </tr>`;
                }).join('');
            } else {
                rows = `<tr><td class="px-6 py-4 text-center text-sm text-gray-500" colspan="3">此類別尚無品項</td></tr>`;
            }
            
            // 直接更新表格內容，不重新渲染整個分頁
            tableBody.innerHTML = rows;
            console.log(`已更新包材表格: ${subtypeKey}`);
        }
        
        // 將函數設為全域，供其他地方調用
        window.updatePackagingSubtypeTable = updatePackagingSubtypeTable;
    }
    function renderMaintenance() {
        const fruitTable = products.filter(p => p.category === 'large_fruit').map(p => `<tr class="hover:bg-gray-50"><td class="px-4 py-4 text-center text-sm font-medium text-gray-900">${p.name}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.category || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.fruitType || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.variety || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.country || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.region || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.size || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.grade || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.brand || 'N/A'}</td></tr>`).join('');
        const boxTable = products.filter(p => p.category === 'packaging').map(p => `<tr class="hover:bg-gray-50"><td class="px-4 py-4"><div class="text-sm font-medium text-gray-900">${p.name}</div><div class="text-xs text-gray-500">${p.sku}</div></td><td class="px-4 py-4 text-sm text-gray-700">${p.details.spec}</td><td class="px-4 py-4 text-right text-sm font-medium text-gray-900">$${p.details.price.toLocaleString()}</td></tr>`).join('');
        
        // 在渲染前先清理無效的包材
        cleanupInvalidPackagingInCombos();
        
        // 常用包材組合表格
        const favoriteComboTable = favoritePackagingCombos.map(combo => {
            const boxProduct = findProduct(combo.boxSku);
            const additionalProducts = combo.additionalSkus.map(sku => findProduct(sku)).filter(Boolean);
            const additionalNames = additionalProducts.map(p => p.name).join('、') || '無';
            
            // 計算總價格
            const totalPrice = calculateComboTotalPrice(combo.boxSku, combo.additionalSkus);
            
            // 使用 Heroicons 的眼睛圖示
            const visibilityIcon = combo.visible 
                ? `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`
                : `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path></svg>`;
            
            // 使用 Heroicons 的編輯和刪除圖示
            const editNameIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`;
            const editPackagingIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path></svg>`;
            const deleteIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            
            return `<tr class="hover:bg-gray-50">
                <td class="px-4 py-4 text-center">
                    <div class="text-sm font-medium text-gray-900">${combo.name}</div>
                    <div class="text-xs text-gray-500">建立於: ${combo.createdAt.toLocaleDateString()}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="text-sm text-gray-900">${boxProduct ? boxProduct.name : '未知盒子'}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="text-sm text-gray-700">${additionalNames}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="text-sm font-medium text-gray-900">$${totalPrice.toLocaleString()}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <button data-combo-id="${combo.id}" class="toggle-visibility-btn hover:bg-gray-100 rounded p-2 transition-colors" title="${combo.visible ? '點擊隱藏' : '點擊顯示'}">${visibilityIcon}</button>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="flex justify-center gap-2">
                        <button data-combo-id="${combo.id}" class="rename-combo-btn text-blue-600 hover:bg-blue-50 rounded p-2 transition-colors" title="重新命名">${editNameIcon}</button>
                        <button data-combo-id="${combo.id}" class="edit-packaging-btn text-purple-600 hover:bg-purple-50 rounded p-2 transition-colors" title="編輯包材選項">${editPackagingIcon}</button>
                        <button data-combo-id="${combo.id}" class="delete-combo-btn text-red-600 hover:bg-red-50 rounded p-2 transition-colors" title="刪除">${deleteIcon}</button>
                    </div>
                </td>
            </tr>`;
        }).join('');
        
        const tabsConfig = [
            { id: 'fruit-pane', title: '水果品項', content: `<div class="flex justify-end mb-4"><button id="add-fruit-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">新增水果品項</button></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">水果種類(Series)</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">品種(Variety)</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">國家</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">區域</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">大小(Size)</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">等級</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">品牌</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${fruitTable}</tbody></table></div>` },
            { 
                id: 'box-pane', 
                title: '包材品項', 
                content: `
                    <div class="border-b border-gray-200 flex items-center justify-between">
                        <nav class="flex space-x-1" id="maintenance-packaging-sub-tabs"></nav>
                        <button id="manage-maintenance-packaging-categories-btn" title="管理包材類別" class="p-2 text-gray-600 hover:text-gray-900">⚙️</button>
                    </div>
                    <div id="maintenance-packaging-panes-container" class="mt-4"></div>
                `
            },
            { id: 'favorite-combo-pane', title: '常用包材組合', content: `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">組合名稱</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">盒子</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">其他包材</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">總價格</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">顯示狀態</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${favoriteComboTable}</tbody></table></div>` }
        ];
        // 不調整分頁順序，而是在 createSubTabs 中指定活動分頁索引
        
        createSubTabs(maintenanceSubTabs, maintenancePanesContainer, tabsConfig, (paneId) => {
            // 更新當前記住的分頁
            currentMaintenanceTab = paneId;
            console.log('資料維護分頁切換到:', paneId);
            
            attachMaintenanceListeners();
            if (paneId === 'favorite-combo-pane') {
                attachFavoriteComboListeners();
            }
            if (paneId === 'box-pane') {
                initMaintenancePackagingTabs();
            }
        }, currentMaintenanceTab); // 傳入記住的活動分頁ID
        attachMaintenanceListeners();
        
        // 初次渲染時也建立包材內層分頁
        initMaintenancePackagingTabs();
        
        // 總是嘗試綁定常用包材組合的事件監聽器，因為 DOM 已經存在
        // 這樣可以確保即使用戶從其他頁面回來，事件監聽器也會被正確綁定
        setTimeout(() => {
            attachFavoriteComboListeners();
        }, 100);
        
        // 初始化資料維護中的包材分類子分頁
        function initMaintenancePackagingTabs(activeCategory = null) {
            const maintenancePackagingSubTabs = document.getElementById('maintenance-packaging-sub-tabs');
            const maintenancePackagingPanesContainer = document.getElementById('maintenance-packaging-panes-container');
            
            if (!maintenancePackagingSubTabs || !maintenancePackagingPanesContainer) return;
            
            const packagingTabsConfig = packagingCategories.map(cat => {
                const categoryProducts = products.filter(p => p.category === 'packaging' && p.details?.type === cat.key);
                const tableRows = categoryProducts.map(p => 
                    `<tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 text-center">
                            <div class="text-sm font-medium text-gray-900">${p.name}</div>
                            <div class="text-xs text-gray-500">${p.sku}</div>
                        </td>
                        <td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.spec}</td>
                        <td class="px-4 py-4 text-center text-sm font-medium text-gray-900">$${p.details.price.toLocaleString()}</td>
                        <td class="px-4 py-4 text-center text-sm text-gray-700">${p.details.defaultStorageLocation || '<span class="text-gray-400">未設定</span>'}</td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button data-sku="${p.sku}" class="rename-packaging-btn text-blue-600 hover:bg-blue-50 rounded p-2 transition-colors" title="重新命名">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button data-sku="${p.sku}" class="edit-packaging-btn text-purple-600 hover:bg-purple-50 rounded p-2 transition-colors" title="編輯包材">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                    </svg>
                                </button>
                                <button data-sku="${p.sku}" class="delete-packaging-btn text-red-600 hover:bg-red-50 rounded p-2 transition-colors" title="刪除包材">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>`
                ).join('');
                
                const content = `
                    <div class="flex justify-end mb-4">
                        <button data-category="${cat.key}" class="add-packaging-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">新增${cat.name}</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">包材名稱</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">適用規格</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">價格</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">預設儲位</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                return { id: `maintenance-${cat.key}-pane`, title: cat.name, content };
            });
            
            // 確定活躍分頁ID
            let activeTabId = null;
            if (activeCategory) {
                activeTabId = `maintenance-${activeCategory}-pane`;
            }
            
            createSubTabs(maintenancePackagingSubTabs, maintenancePackagingPanesContainer, packagingTabsConfig, () => {
                attachMaintenancePackagingListeners();
            }, activeTabId);
            
            attachMaintenancePackagingListeners();
        }
        
        // 綁定資料維護包材分頁的事件監聽器
        function attachMaintenancePackagingListeners() {
            // 新增包材按鈕
            document.querySelectorAll('.add-packaging-btn').forEach(btn => {
                btn.onclick = () => {
                    const category = btn.dataset.category;
                    openAddPackagingModal(category);
                };
            });
            
            // 重新命名包材按鈕
            document.querySelectorAll('.rename-packaging-btn').forEach(btn => {
                btn.onclick = () => {
                    const sku = btn.dataset.sku;
                    const product = findProduct(sku);
                    if (product) {
                        openRenamePackagingItemModal(product);
                    }
                };
            });
            
            // 編輯包材按鈕
            document.querySelectorAll('.edit-packaging-btn').forEach(btn => {
                btn.onclick = () => {
                    const sku = btn.dataset.sku;
                    const product = findProduct(sku);
                    if (product) {
                        openEditPackagingItemModal(product);
                    }
                };
            });
            
            // 刪除包材按鈕
            document.querySelectorAll('.delete-packaging-btn').forEach(btn => {
                btn.onclick = () => {
                    const sku = btn.dataset.sku;
                    const product = findProduct(sku);
                    if (product) {
                        openDeletePackagingItemModal(product);
                    }
                };
            });
            
            // 管理包材類別按鈕
            const manageCategoriesBtn = document.getElementById('manage-maintenance-packaging-categories-btn');
            if (manageCategoriesBtn) {
                manageCategoriesBtn.onclick = () => {
                    openManagePackagingCategoriesModal();
                };
            }
        }
        
        // 全域化函數以便其他地方呼叫
        window.initMaintenancePackagingTabs = initMaintenancePackagingTabs;
    }

    // 重新命名包材的模態框
    function openRenamePackagingItemModal(product) {
        const modalHtml = `
            <form id="rename-packaging-form" class="p-6 space-y-4">
                <h3 class="text-lg font-medium text-gray-900">重新命名包材</h3>
                
                <div>
                    <label for="rename-packaging-name" class="block text-sm font-medium text-gray-700">包材名稱</label>
                    <input type="text" id="rename-packaging-name" name="name" value="${product.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">確認修改</button>
                </div>
            </form>
        `;
        
        openModal(modalHtml);
        
        // 綁定事件
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        
        document.getElementById('rename-packaging-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('rename-packaging-name').value.trim();
            const inputElement = document.getElementById('rename-packaging-name');
            
            // 清除之前的錯誤樣式
            inputElement.classList.remove('border-red-500', 'ring-red-500');
            let errorElement = document.getElementById('rename-packaging-error-message');
            if (errorElement) {
                errorElement.remove();
            }
            
            if (!newName) {
                // 在表單內顯示錯誤訊息
                inputElement.classList.add('border-red-500', 'ring-red-500');
                const errorHtml = `<p id="rename-packaging-error-message" class="text-red-600 text-sm mt-1">請輸入包材名稱</p>`;
                inputElement.parentNode.insertAdjacentHTML('beforeend', errorHtml);
                inputElement.focus();
                return;
            }
            
            // 檢查名稱是否重複
            if (products.some(p => p.sku !== product.sku && p.name === newName && p.category === 'packaging')) {
                inputElement.classList.add('border-red-500', 'ring-red-500');
                const errorHtml = `<p id="rename-packaging-error-message" class="text-red-600 text-sm mt-1">此名稱已存在，請使用其他名稱</p>`;
                inputElement.parentNode.insertAdjacentHTML('beforeend', errorHtml);
                inputElement.focus();
                inputElement.select();
                return;
            }
            
            // 更新產品名稱
            product.name = newName;
            closeModal();
            
            // 重新渲染包材分頁
            initMaintenancePackagingTabs();
        });
    }

    // 新增包材的模態框
    function openAddPackagingModal(category) {
        const categoryInfo = packagingCategories.find(cat => cat.key === category);
        const categoryName = categoryInfo ? categoryInfo.name : category;
        
        const modalHtml = `
            <form id="add-packaging-form" class="p-6 space-y-4">
                <h3 class="text-lg font-medium text-gray-900">新增${categoryName}</h3>
                
                <div class="relative">
                    <label for="packaging-name" class="block text-sm font-medium text-gray-700">包裝</label>
                    <input type="text" id="packaging-name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" autocomplete="off">
                    <div id="packaging-name-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div>
                </div>
                
                <div>
                    <label for="packaging-sku" class="block text-sm font-medium text-gray-700">SKU (系統自動生成)</label>
                    <input type="text" id="packaging-sku" name="sku" class="mt-1 block w-full rounded-md border-gray-200 bg-gray-100 shadow-sm" readonly>
                    <p class="text-xs text-gray-500 mt-1">SKU 會根據包裝名稱自動生成</p>
                </div>
                
                <div class="relative">
                    <label for="packaging-spec" class="block text-sm font-medium text-gray-700">規格(容量) <span class="text-red-500">*</span></label>
                    <input type="text" id="packaging-spec" name="spec" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required autocomplete="off">
                    <div id="packaging-spec-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div>
                </div>
                
                <div>
                    <label for="packaging-price" class="block text-sm font-medium text-gray-700">價格</label>
                    <input type="number" id="packaging-price" name="price" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="packaging-storage-location" class="block text-sm font-medium text-gray-700">預設儲位</label>
                    ${storageLocations.length > 0 
                        ? `<select id="packaging-storage-location" name="storageLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">請選擇預設儲位（可選）</option>
                            ${storageLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                           </select>`
                        : `<select id="packaging-storage-location" name="storageLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled>
                            <option value="">請先至「儲位」分頁新增儲位</option>
                           </select>
                           <p class="text-xs text-gray-500 mt-1">預設儲位為可選項目，可稍後在儲位管理中設定</p>`
                    }
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">新增</button>
                </div>
            </form>
        `;
        
        openModal(modalHtml);
        
        // 綁定事件
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        
        // 初始化智能輸入功能，傳入包材類別
        initSmartInput('packaging-name', 'packaging', category);
        initSmartInput('packaging-spec', 'packaging', category);
        
        // 設置包材名稱和規格的聯動功能
        setupPackagingNameSpecLink();
        
        // 監聽包材名稱輸入，自動生成 SKU
        const nameInput = document.getElementById('packaging-name');
        const skuInput = document.getElementById('packaging-sku');
        
        const updateSku = () => {
            const name = nameInput.value.trim();
            if (name) {
                const generatedSku = generatePackagingSku(category, name);
                skuInput.value = generatedSku;
            } else {
                skuInput.value = '';
            }
        };
        
        nameInput.addEventListener('input', updateSku);
        // 初始生成 SKU
        updateSku();
        
        document.getElementById('add-packaging-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // 檢查是否有重複的包材
            const newItem = {
                name: formData.get('name'),
                spec: formData.get('spec'),
                type: category
            };
            
            // 檢查關鍵欄位組合是否重複
            const isDuplicate = products.some(p => 
                p.category === 'packaging' &&
                p.name === newItem.name &&
                p.details?.spec === newItem.spec &&
                p.details?.type === newItem.type
            );
            
            if (isDuplicate) {
                // 顯示重複警告，讓用戶選擇
                const categoryName = packagingCategories.find(cat => cat.key === category)?.name || category;
                const confirmMessage = `偵測到相似的${categoryName}已存在：\n\n包材名稱: ${newItem.name}\n適用規格: ${newItem.spec}\n類別: ${categoryName}\n\n是否仍要新增此包材？`;
                
                if (!confirm(confirmMessage)) {
                    return; // 用戶取消新增
                }
            }
            
            // 使用自動生成的 SKU
            const generatedSku = generatePackagingSku(category, formData.get('name'));
            
            const newPackaging = {
                name: formData.get('name'),
                sku: generatedSku,
                category: 'packaging',
                details: {
                    type: category,
                    spec: formData.get('spec'),
                    price: parseFloat(formData.get('price')),
                    defaultStorageLocation: formData.get('storageLocation') || null
                }
            };
            
            // SKU 由系統自動生成，確保唯一性，不需要重複檢查
            
            // 新增到產品清單
            products.push(newPackaging);
            
            // 新增庫存記錄
            inventory.push({
                sku: newPackaging.sku,
                quantity: 0,
                lots: []
            });
            
            closeModal();
            
            // 重新渲染包材分頁，並保持在當前類別分頁
            initMaintenancePackagingTabs(category);
        });
    }
    // 編輯包材的模態框
    function openEditPackagingItemModal(product) {
        const modalHtml = `
            <form id="edit-packaging-form" class="p-6 space-y-4">
                <h3 class="text-lg font-medium text-gray-900">編輯包材 - ${product.name}</h3>
                
                <div>
                    <label for="edit-packaging-name" class="block text-sm font-medium text-gray-700">包材名稱</label>
                    <input type="text" id="edit-packaging-name" name="name" value="${product.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="edit-packaging-sku" class="block text-sm font-medium text-gray-700">SKU</label>
                    <input type="text" id="edit-packaging-sku" name="sku" value="${product.sku}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" readonly>
                    <p class="text-xs text-gray-500 mt-1">SKU 無法修改</p>
                </div>
                
                <div>
                    <label for="edit-packaging-spec" class="block text-sm font-medium text-gray-700">適用規格</label>
                    <input type="text" id="edit-packaging-spec" name="spec" value="${product.details.spec}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="edit-packaging-price" class="block text-sm font-medium text-gray-700">價格</label>
                    <input type="number" id="edit-packaging-price" name="price" value="${product.details.price}" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="edit-packaging-storage-location" class="block text-sm font-medium text-gray-700">預設儲位</label>
                    ${storageLocations.length > 0 
                        ? `<select id="edit-packaging-storage-location" name="storageLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">無預設儲位</option>
                            ${storageLocations.map(loc => `<option value="${loc}" ${product.details.defaultStorageLocation === loc ? 'selected' : ''}>${loc}</option>`).join('')}
                           </select>`
                        : `<select id="edit-packaging-storage-location" name="storageLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled>
                            <option value="">請先至「儲位」分頁新增儲位</option>
                           </select>`
                    }
                    <p class="text-xs text-gray-500 mt-1">預設儲位用於新入庫時的建議儲位</p>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">儲存變更</button>
                </div>
            </form>
        `;
        
        openModal(modalHtml);
        
        // 綁定事件
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        
        document.getElementById('edit-packaging-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // 更新產品資料
            product.name = formData.get('name');
            product.details.spec = formData.get('spec');
            product.details.price = parseFloat(formData.get('price'));
            product.details.defaultStorageLocation = formData.get('storageLocation') || null;
            
            closeModal();
            
            // 重新渲染包材分頁
            initMaintenancePackagingTabs();
        });
    }

    // 刪除包材的模態框
    function openDeletePackagingItemModal(product) {
        // 檢查哪些常用組合使用了這個包材
        const affectedCombos = findCombosUsingSku(product.sku);
        
        let warningMessage = `您確定要刪除包材「<span class="font-semibold">${product.name}</span>」(${product.sku}) 嗎？<br><span class="text-red-600 font-medium">此操作無法復原。</span>`;
        
        if (affectedCombos.length > 0) {
            const comboNames = affectedCombos.map(combo => `「${combo.name}」`).join('、');
            warningMessage += `<br><br><div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mt-3">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-yellow-800">⚠️ 影響警告</p>
                        <p class="text-sm text-yellow-700 mt-1">此包材被以下 <span class="font-medium text-red-600">${affectedCombos.length}</span> 個常用組合使用：</p>
                        <p class="text-sm text-yellow-700 mt-1">${comboNames}</p>
                        <p class="text-sm text-yellow-700 mt-2 font-medium">刪除後，這些組合將自動移除此包材。</p>
                    </div>
                </div>
            </div>`;
        }
        
        const modalHtml = `
            <div class="p-6 space-y-4">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900">確認刪除包材</h3>
                </div>
                
                <div class="text-sm text-gray-600">
                    ${warningMessage}
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">取消</button>
                    <button type="button" class="confirm-delete-btn px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">確認刪除</button>
                </div>
            </div>
        `;
        
        openModal(modalHtml, 'max-w-2xl');
        
        // 綁定事件
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        
        document.querySelector('.confirm-delete-btn').addEventListener('click', () => {
            // 從產品清單中移除
            const productIndex = products.findIndex(p => p.sku === product.sku);
            if (productIndex !== -1) {
                products.splice(productIndex, 1);
            }
            
            // 從庫存清單中移除
            const inventoryIndex = inventory.findIndex(i => i.sku === product.sku);
            if (inventoryIndex !== -1) {
                inventory.splice(inventoryIndex, 1);
            }
            
            // 清理常用組合中的已刪除包材
            const removedEmptyCombos = cleanupComboAfterDeletion([product.sku]);
            
            // 立即清理並更新界面
            console.log('立即清理無效包材...');
            cleanupInvalidPackagingInCombos();
            
            // 記住用戶當前在包材品項分頁
            if (currentView === 'maintenance') {
                currentMaintenanceTab = 'box-pane';
                console.log('設置當前分頁為包材品項，立即重新渲染資料維護頁面');
                renderMaintenance();
                
                // 立即更新常用組合分頁
                setTimeout(() => {
                    if (typeof updateFavoriteComboPane === 'function') {
                        updateFavoriteComboPane();
                    }
                }, 10);
            }
            
            closeModal();
            
            // 顯示成功訊息，包含受影響的組合資訊
            let successMessage = `包材「${product.name}」已成功刪除。`;
            if (affectedCombos.length > 0) {
                successMessage += `<br><br>已自動更新 ${affectedCombos.length} 個常用組合。`;
                if (removedEmptyCombos > 0) {
                    successMessage += `<br>其中 ${removedEmptyCombos} 個組合因為沒有任何包材而被移除。`;
                }
            }
            
            openSuccessModal(successMessage, () => {
                console.log('成功訊息確認後，再次確保界面更新');
                
                // 再次確保界面更新，保持在包材品項分頁
                if (currentView === 'maintenance') {
                    currentMaintenanceTab = 'box-pane';
                    console.log('成功訊息確認後，確保停留在包材品項分頁');
                    renderMaintenance();
                } else {
                    // 重新渲染包材分頁
                    initMaintenancePackagingTabs();
                }
            });
        });
    }

    function setupDateFilters(prefix, renderFunc) {
        const yearFilter = document.getElementById(`${prefix}-year-filter`);
        const monthFilter = document.getElementById(`${prefix}-month-filter`);
        const startDateInput = document.getElementById(`${prefix}-start-date`);
        const endDateInput = document.getElementById(`${prefix}-end-date`);
        const clearBtn = document.getElementById(`${prefix}-clear-filter-btn`);

        if (!yearFilter) return;

        const years = [...new Set(inventoryLog.map(log => log.timestamp.getFullYear()))].sort((a,b) => b-a);
        yearFilter.innerHTML = '<option value="">所有年份</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
        
        const months = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
        monthFilter.innerHTML = '<option value="">所有月份</option>' + months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
        
        yearFilter.addEventListener('change', renderFunc);
        monthFilter.addEventListener('change', renderFunc);
        startDateInput.addEventListener('change', renderFunc);
        endDateInput.addEventListener('change', renderFunc);
        clearBtn.addEventListener('click', () => {
            yearFilter.value = '';
            monthFilter.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            renderFunc();
        });
    }

    function getFilteredLogs(prefix) {
        const selectedYear = document.getElementById(`${prefix}-year-filter`)?.value;
        const selectedMonth = document.getElementById(`${prefix}-month-filter`)?.value;
        const startDate = document.getElementById(`${prefix}-start-date`)?.value;
        const endDate = document.getElementById(`${prefix}-end-date`)?.value;

        return inventoryLog.filter(log => {
            const logDate = log.timestamp;
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                return logDate >= start && logDate <= end;
            } else if (selectedYear || selectedMonth) {
                const yearMatch = !selectedYear || logDate.getFullYear() == selectedYear;
                const monthMatch = !selectedMonth || logDate.getMonth() == selectedMonth;
                return yearMatch && monthMatch;
            }
            return true;
        });
    }
    
    function getFilteredWorkOrders(prefix) {
        const selectedYear = document.getElementById(`${prefix}-year-filter`)?.value;
        const selectedMonth = document.getElementById(`${prefix}-month-filter`)?.value;
        const startDate = document.getElementById(`${prefix}-start-date`)?.value;
        const endDate = document.getElementById(`${prefix}-end-date`)?.value;

        return workOrders.filter(wo => {
            const woDate = wo.packagingResult.completedAt || wo.warehouseInfo.dispatchedAt;
            if (!woDate) return false;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                return woDate >= start && woDate <= end;
            } else if (selectedYear || selectedMonth) {
                const yearMatch = !selectedYear || woDate.getFullYear() == selectedYear;
                const monthMatch = !selectedMonth || woDate.getMonth() == selectedMonth;
                return yearMatch && monthMatch;
            }
            return true;
        });
    }

    function renderLogView() {
        if (!logContentContainer) return;
        logContentContainer.innerHTML = `
            <div class="flex flex-wrap gap-4 items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 sr-only">篩選器</h2>
                <div class="flex items-center gap-2"><label for="log-year-filter" class="text-sm font-medium">年份:</label><select id="log-year-filter" class="rounded-md border-gray-300 shadow-sm"></select></div>
                <div class="flex items-center gap-2"><label for="log-month-filter" class="text-sm font-medium">月份:</label><select id="log-month-filter" class="rounded-md border-gray-300 shadow-sm"></select></div>
                <div class="flex items-center gap-2"><label for="log-start-date" class="text-sm font-medium">從:</label><input type="date" id="log-start-date" class="rounded-md border-gray-300 shadow-sm"></div>
                <div class="flex items-center gap-2"><label for="log-end-date" class="text-sm font-medium">到:</label><input type="date" id="log-end-date" class="rounded-md border-gray-300 shadow-sm"></div>
                <button id="log-clear-filter-btn" class="text-sm text-blue-600 hover:underline">清除篩選</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">時間</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">品項</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">工號/來源</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作類型</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">數量變化</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">單位成本</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">儲位</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th></tr></thead>
                    <tbody id="inventory-log-table"></tbody>
                </table>
            </div>
        `;
        
        const categories = [
            { id: 'large_fruit', title: '大件原料' },
            { id: 'packaging', title: '包材' },
            { id: 'small_fruit', title: '小件成品' }
        ];
        logSubTabsContainer.innerHTML = '';
        categories.forEach((cat, index) => {
            const tabButton = document.createElement('button');
            tabButton.className = `sub-tab -mb-px border border-b-0 rounded-t-md py-2 px-4 text-sm font-medium`;
            if (index === 0) {
                tabButton.classList.add('active');
            } else {
                tabButton.classList.add('bg-gray-100', 'hover:bg-gray-200');
            }
            tabButton.textContent = cat.title;
            tabButton.dataset.category = cat.id;
            logSubTabsContainer.appendChild(tabButton);
        });

        logSubTabsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                logSubTabsContainer.querySelectorAll('.sub-tab').forEach(t => { t.classList.remove('active'); t.classList.add('bg-gray-100', 'hover:bg-gray-200'); });
                e.target.classList.add('active');
                e.target.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                displayFilteredLogs();
            }
        });

        setupDateFilters('log', displayFilteredLogs);
        displayFilteredLogs();
    }

    function displayFilteredLogs() {
        const activeCategory = logSubTabsContainer.querySelector('.sub-tab.active')?.dataset.category || 'large_fruit';
        const filteredByDate = getFilteredLogs('log');
        
        const finalFiltered = filteredByDate.filter(log => {
            const product = findProduct(log.sku);
            return product && product.category === activeCategory;
        });

        const tableBody = document.getElementById('inventory-log-table');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        finalFiltered.forEach(log => {
            const quantityClass = log.quantity > 0 ? 'text-green-600' : 'text-red-600';
            const quantitySign = log.quantity > 0 ? '+' : '';
            const costDisplay = log.unitCost > 0 ? `$${Math.round(log.unitCost).toLocaleString()}` : 'N/A';
            // 為小件成品添加資訊圖示
            const product = findProduct(log.sku);
            const isSmallFruit = product && product.category === 'small_fruit';
            const infoIcon = isSmallFruit ? `<button class="info-btn ml-2 text-blue-500 hover:text-blue-700" data-sku="${log.sku}" title="查看詳細資訊">ℹ️</button>` : '';
            
            tableBody.innerHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-4 text-center text-sm text-gray-500">${log.timestamp.toLocaleString('sv-SE')}</td><td class="px-4 py-4 text-center"><div class="text-sm font-medium text-gray-900 flex items-center justify-center">${log.productName}${infoIcon}</div></td><td class="px-4 py-4 text-center text-sm text-gray-700">${log.lotNumber || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${log.type}</td><td class="px-4 py-4 text-center text-sm font-bold ${quantityClass}">${quantitySign}${log.quantity.toLocaleString()}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${costDisplay}</td><td class="px-4 py-4 text-center text-sm text-gray-700">${log.storageLocation || 'N/A'}</td><td class="px-4 py-4 text-center text-sm text-gray-500">${log.remark || ''}</td></tr>`;
        });
        
        // 為資訊按鈕添加事件監聽器
        document.querySelectorAll('.info-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const sku = btn.getAttribute('data-sku');
                showProductDetailModal(sku);
            });
        });
    }
    
    // 顯示產品詳細資訊模態框
    function showProductDetailModal(sku) {
        const product = findProduct(sku);
        if (!product || product.category !== 'small_fruit') return;
        
        // 根據工單找到對應的大件原料和包裝信息
        const workOrder = workOrders.find(wo => wo.smallItemSku === sku);
        if (!workOrder) return;
        
        const largeProduct = findProduct(workOrder.largeItemSku);
        const boxProduct = findProduct(workOrder.boxSku);
        
        if (!largeProduct || !boxProduct) return;
        
        const modalHtml = `
            <div class="p-6 max-w-md mx-auto">
                <h3 class="text-lg font-semibold mb-4 text-center border-b pb-2">產品詳細資訊</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="font-medium text-gray-600">水果名稱:</span></div>
                        <div class="text-gray-900">${largeProduct.name || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">品種:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.variety || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">大小:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.size || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">等級:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.grade || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">品牌:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.brand || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">國家:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.country || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">區域:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.region || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">規格:</span></div>
                        <div class="text-gray-900">${largeProduct.details?.size || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">盒子:</span></div>
                        <div class="text-gray-900">${boxProduct.name || 'N/A'}</div>
                        
                        <div><span class="font-medium text-gray-600">其他包材:</span></div>
                        <div class="text-gray-900">${workOrder.additionalPackagingSkus && workOrder.additionalPackagingSkus.length > 0 ? workOrder.additionalPackagingSkus.map(sku => findProduct(sku)?.name || sku).join(', ') : '無'}</div>
                    </div>
                </div>
                <div class="mt-6 flex justify-center">
                    <button class="cancel-btn bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">關閉</button>
                </div>
            </div>
        `;
        
        openModal(modalHtml);
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
    }
    
    // 浮動提醒功能
    function showFloatingTooltip(element, message) {
        // 移除現有的提醒
        const existingTooltip = document.getElementById('floating-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        
        // 創建新的浮動提醒
        const tooltip = document.createElement('div');
        tooltip.id = 'floating-tooltip';
        tooltip.className = 'absolute z-[9999] bg-red-500 text-white text-xs px-2 py-1 rounded shadow-lg pointer-events-none';
        tooltip.textContent = message;
        
        // 添加到body
        document.body.appendChild(tooltip);
        
        // 計算位置
        const rect = element.getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 5) + 'px';
        
        // 3秒後自動消失
        setTimeout(() => {
            if (tooltip && tooltip.parentNode) {
                tooltip.remove();
            }
        }, 3000);
    }
    // 水果品項分層輸入控制
    function initFruitHierarchyControl() {
        const categoryInput = document.getElementById('category-input');
        const fruitTypeInput = document.getElementById('fruitType-input');
        const varietyInput = document.getElementById('variety-input');
        const countryInput = document.getElementById('country-input');
        const regionInput = document.getElementById('region-input');
        const sizeInput = document.getElementById('size-input');
        const gradeInput = document.getElementById('grade-input');
        const brandInput = document.getElementById('brand-input');
        
        // 檢查並更新欄位狀態
        const updateFieldStates = () => {
            const categoryValue = categoryInput.value.trim();
            const fruitTypeValue = fruitTypeInput.value.trim();
            const varietyValue = varietyInput.value.trim();
            
            // 第二層：水果種類(Series)
            if (categoryValue) {
                enableField(fruitTypeInput, '請輸入水果種類');
            } else {
                disableField(fruitTypeInput, '請先完成Category');
            }
            
            // 第三層：品種(Variety)
            if (categoryValue && fruitTypeValue) {
                enableField(varietyInput, '請輸入品種');
            } else {
                disableField(varietyInput, '請先完成水果種類(Series)');
            }
            
            // 第四層：國家
            if (categoryValue && fruitTypeValue && varietyValue) {
                enableField(countryInput, '請輸入國家');
            } else {
                disableField(countryInput, '請先完成品種(Variety)');
            }
            
            // 第五層：區域
            const countryValue = countryInput.value.trim();
            if (categoryValue && fruitTypeValue && varietyValue && countryValue) {
                enableField(regionInput, '請輸入區域（選填）');
            } else {
                disableField(regionInput, '請先完成國家');
            }
            
            // 第六層：大小、等級、品牌
            const regionValue = regionInput.value.trim();
            const allFiveCompleted = categoryValue && fruitTypeValue && varietyValue && countryValue && regionValue;
            const lastFields = [sizeInput, gradeInput, brandInput];
            const lastPlaceholders = ['請輸入大小', '請輸入等級（選填）', '請輸入品牌（選填）'];
            
            lastFields.forEach((field, index) => {
                if (allFiveCompleted) {
                    enableField(field, lastPlaceholders[index]);
                } else {
                    disableField(field, '請先完成區域');
                }
            });
        };
        
        // 啟用欄位
        const enableField = (field, placeholder) => {
            field.disabled = false;
            field.classList.remove('bg-gray-100');
            field.classList.add('bg-white');
            field.placeholder = placeholder;
        };
        
        // 禁用欄位
        const disableField = (field, placeholder) => {
            field.disabled = true;
            field.classList.remove('bg-white');
            field.classList.add('bg-gray-100');
            field.placeholder = placeholder;
            field.value = ''; // 清空值
        };
        
        // 監聽點擊事件，顯示提醒
        const addClickListener = (field, requiredField, message) => {
            field.addEventListener('click', (e) => {
                if (field.disabled) {
                    e.preventDefault();
                    showFloatingTooltip(field, message);
                }
            });
            
            field.addEventListener('focus', (e) => {
                if (field.disabled) {
                    e.preventDefault();
                    field.blur();
                    showFloatingTooltip(field, message);
                }
            });
        };
        
        // 為各欄位添加點擊監聽
        addClickListener(fruitTypeInput, categoryInput, '請先輸入Category');
        addClickListener(varietyInput, fruitTypeInput, '請先輸入水果種類(Series)');
        addClickListener(countryInput, varietyInput, '請先輸入品種(Variety)');
        addClickListener(regionInput, countryInput, '請先輸入國家');
        addClickListener(sizeInput, regionInput, '請先輸入區域');
        addClickListener(gradeInput, regionInput, '請先輸入區域');
        addClickListener(brandInput, regionInput, '請先輸入區域');
        
        // 監聽輸入變化
        categoryInput.addEventListener('input', () => {
            updateFieldStates();
            // 清空下層欄位
            fruitTypeInput.value = '';
            varietyInput.value = '';
            countryInput.value = '';
            regionInput.value = '';
            sizeInput.value = '';
            gradeInput.value = '';
            brandInput.value = '';
            // 更新下層智能輸入選項
            updateSmartInputOptions('fruitType');
        });
        categoryInput.addEventListener('change', () => {
            updateFieldStates();
            updateSmartInputOptions('fruitType');
        });
        
        fruitTypeInput.addEventListener('input', () => {
            updateFieldStates();
            // 清空下層欄位
            varietyInput.value = '';
            countryInput.value = '';
            regionInput.value = '';
            sizeInput.value = '';
            gradeInput.value = '';
            brandInput.value = '';
            // 更新下層智能輸入選項
            updateSmartInputOptions('variety');
        });
        fruitTypeInput.addEventListener('change', () => {
            updateFieldStates();
            updateSmartInputOptions('variety');
        });
        
        varietyInput.addEventListener('input', () => {
            updateFieldStates();
            // 清空下層欄位
            countryInput.value = '';
            regionInput.value = '';
            sizeInput.value = '';
            gradeInput.value = '';
            brandInput.value = '';
            // 更新下層智能輸入選項
            updateSmartInputOptions('country');
        });
        varietyInput.addEventListener('change', () => {
            updateFieldStates();
            updateSmartInputOptions('country');
        });
        
        countryInput.addEventListener('input', () => {
            updateFieldStates();
            // 清空下層欄位
            regionInput.value = '';
            sizeInput.value = '';
            gradeInput.value = '';
            brandInput.value = '';
            // 更新下層智能輸入選項
            updateSmartInputOptions('region');
        });
        countryInput.addEventListener('change', () => {
            updateFieldStates();
            updateSmartInputOptions('region');
        });
        
        regionInput.addEventListener('input', () => {
            updateFieldStates();
            // 清空下層欄位
            sizeInput.value = '';
            gradeInput.value = '';
            brandInput.value = '';
            // 更新下層智能輸入選項
            updateSmartInputOptions('size');
            updateSmartInputOptions('grade');
            updateSmartInputOptions('brand');
        });
        regionInput.addEventListener('change', () => {
            updateFieldStates();
            updateSmartInputOptions('size');
            updateSmartInputOptions('grade');
            updateSmartInputOptions('brand');
        });
        
        // 更新智能輸入選項
        const updateSmartInputOptions = (fieldName) => {
            const input = document.getElementById(`${fieldName}-input`);
            const dropdown = document.getElementById(`${fieldName}-dropdown`);
            
            if (input && dropdown) {
                // 隱藏下拉選單
                dropdown.classList.add('hidden');
                // 只有在用戶真正聚焦在該欄位時才觸發重新計算選項
                setTimeout(() => {
                    if (document.activeElement === input && !input.value.trim()) {
                        input.dispatchEvent(new Event('click'));
                    }
                }, 50);
            }
        };
        
        // 初始化狀態
        updateFieldStates();
    }
    
    // 智能輸入功能
    function initSmartInput(fieldName, category = 'large_fruit', packagingType = null) {
        let isOptionClicked = false;
        let inputId, dropdownId;
        
        // 根據不同的欄位類型設定ID
        if (fieldName.startsWith('packaging-')) {
            inputId = fieldName;
            dropdownId = `${fieldName}-dropdown`;
        } else {
            inputId = `${fieldName}-input`;
            dropdownId = `${fieldName}-dropdown`;
        }
        
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        
        if (!input || !dropdown) return;
        
        // 獲取該欄位的所有現有值
        const getExistingValues = () => {
            let values = [];
            
            if (fieldName === 'packaging-name') {
                // 包材名稱：只從相同類別的包材產品中獲取名稱
                values = products
                    .filter(p => p.category === 'packaging' && 
                                (!packagingType || p.details?.type === packagingType))
                    .map(p => p.name)
                    .filter(v => v && v.trim() !== '');
            } else if (fieldName === 'packaging-spec') {
                // 包材規格：根據當前輸入的包材名稱來過濾規格
                const nameInput = document.getElementById('packaging-name');
                const currentName = nameInput ? nameInput.value.trim() : '';
                
                if (currentName) {
                    // 如果有輸入包材名稱，只顯示該名稱相關的規格
                    values = products
                        .filter(p => p.category === 'packaging' && 
                                    p.details && p.details.spec &&
                                    (!packagingType || p.details.type === packagingType) &&
                                    p.name.includes(currentName))
                        .map(p => p.details.spec)
                        .filter(v => v && v.trim() !== '');
                } else {
                    // 如果沒有輸入包材名稱，顯示該類別的所有規格
                    values = products
                        .filter(p => p.category === 'packaging' && 
                                    p.details && p.details.spec &&
                                    (!packagingType || p.details.type === packagingType))
                        .map(p => p.details.spec)
                        .filter(v => v && v.trim() !== '');
                }
            } else if (fieldName === 'name') {
                // 水果名稱：從水果產品中獲取名稱
                values = products
                    .filter(p => p.category === category && p.name)
                    .map(p => p.name)
                    .filter(v => v && v.trim() !== '');
            } else if (fieldName === 'category') {
                // Category：從水果產品的details中獲取
                values = products
                    .filter(p => p.category === 'large_fruit' && p.details && p.details.category)
                    .map(p => p.details.category)
                    .filter(v => v && v.trim() !== '');
            } else if (fieldName === 'fruitType') {
                // 水果種類：根據已選擇的Category過濾
                const categoryInput = document.getElementById('category-input');
                const selectedCategory = categoryInput ? categoryInput.value.trim() : '';
                
                if (selectedCategory) {
                    values = products
                        .filter(p => p.category === 'large_fruit' && 
                                    p.details && p.details.fruitType &&
                                    p.details.category === selectedCategory)
                        .map(p => p.details.fruitType)
                        .filter(v => v && v.trim() !== '');
                } else {
                    // 如果沒有選擇Category，顯示所有水果種類
                    values = products
                        .filter(p => p.category === 'large_fruit' && p.details && p.details.fruitType)
                        .map(p => p.details.fruitType)
                        .filter(v => v && v.trim() !== '');
                }
            } else if (fieldName === 'variety') {
                // 品種：根據已選擇的Category和水果種類過濾
                const categoryInput = document.getElementById('category-input');
                const fruitTypeInput = document.getElementById('fruitType-input');
                const selectedCategory = categoryInput ? categoryInput.value.trim() : '';
                const selectedFruitType = fruitTypeInput ? fruitTypeInput.value.trim() : '';
                
                if (selectedCategory && selectedFruitType) {
                    values = products
                        .filter(p => p.category === 'large_fruit' && 
                                    p.details && p.details.variety &&
                                    p.details.category === selectedCategory &&
                                    p.details.fruitType === selectedFruitType)
                        .map(p => p.details.variety)
                        .filter(v => v && v.trim() !== '');
                } else {
                    // 如果前兩層未完成，顯示所有品種
                    values = products
                        .filter(p => p.category === 'large_fruit' && p.details && p.details.variety)
                        .map(p => p.details.variety)
                        .filter(v => v && v.trim() !== '');
                }
            } else if (fieldName === 'country') {
                // 國家：根據已選擇的Category、水果種類、品種過濾
                const categoryInput = document.getElementById('category-input');
                const fruitTypeInput = document.getElementById('fruitType-input');
                const varietyInput = document.getElementById('variety-input');
                const selectedCategory = categoryInput ? categoryInput.value.trim() : '';
                const selectedFruitType = fruitTypeInput ? fruitTypeInput.value.trim() : '';
                const selectedVariety = varietyInput ? varietyInput.value.trim() : '';
                
                if (selectedCategory && selectedFruitType && selectedVariety) {
                    values = products
                        .filter(p => p.category === 'large_fruit' && 
                                    p.details && p.details.country &&
                                    p.details.category === selectedCategory &&
                                    p.details.fruitType === selectedFruitType &&
                                    p.details.variety === selectedVariety)
                        .map(p => p.details.country)
                        .filter(v => v && v.trim() !== '');
                } else {
                    // 如果前三層未完成，顯示所有國家
                    values = products
                        .filter(p => p.category === 'large_fruit' && p.details && p.details.country)
                        .map(p => p.details.country)
                        .filter(v => v && v.trim() !== '');
                }
            } else if (fieldName === 'region') {
                // 區域：根據已選擇的Category、水果種類、品種、國家過濾
                const categoryInput = document.getElementById('category-input');
                const fruitTypeInput = document.getElementById('fruitType-input');
                const varietyInput = document.getElementById('variety-input');
                const countryInput = document.getElementById('country-input');
                const selectedCategory = categoryInput ? categoryInput.value.trim() : '';
                const selectedFruitType = fruitTypeInput ? fruitTypeInput.value.trim() : '';
                const selectedVariety = varietyInput ? varietyInput.value.trim() : '';
                const selectedCountry = countryInput ? countryInput.value.trim() : '';
                
                if (selectedCategory && selectedFruitType && selectedVariety && selectedCountry) {
                    values = products
                        .filter(p => p.category === 'large_fruit' && 
                                    p.details && p.details.region &&
                                    p.details.category === selectedCategory &&
                                    p.details.fruitType === selectedFruitType &&
                                    p.details.variety === selectedVariety &&
                                    p.details.country === selectedCountry)
                        .map(p => p.details.region)
                        .filter(v => v && v.trim() !== '');
                } else {
                    // 如果前四層未完成，顯示所有區域
                    values = products
                        .filter(p => p.category === 'large_fruit' && p.details && p.details.region)
                        .map(p => p.details.region)
                        .filter(v => v && v.trim() !== '');
                }
            } else if (fieldName === 'size' || fieldName === 'grade' || fieldName === 'brand') {
                // 第6層：大小、等級、品牌：根據前5層過濾
                const categoryInput = document.getElementById('category-input');
                const fruitTypeInput = document.getElementById('fruitType-input');
                const varietyInput = document.getElementById('variety-input');
                const countryInput = document.getElementById('country-input');
                const regionInput = document.getElementById('region-input');
                const selectedCategory = categoryInput ? categoryInput.value.trim() : '';
                const selectedFruitType = fruitTypeInput ? fruitTypeInput.value.trim() : '';
                const selectedVariety = varietyInput ? varietyInput.value.trim() : '';
                const selectedCountry = countryInput ? countryInput.value.trim() : '';
                const selectedRegion = regionInput ? regionInput.value.trim() : '';
                
                if (selectedCategory && selectedFruitType && selectedVariety && selectedCountry && selectedRegion) {
                    values = products
                        .filter(p => p.category === 'large_fruit' && 
                                    p.details && p.details[fieldName] &&
                                    p.details.category === selectedCategory &&
                                    p.details.fruitType === selectedFruitType &&
                                    p.details.variety === selectedVariety &&
                                    p.details.country === selectedCountry &&
                                    p.details.region === selectedRegion)
                        .map(p => p.details[fieldName])
                        .filter(v => v && v.trim() !== '');
                } else {
                    // 如果前五層未完成，顯示所有選項
                    values = products
                        .filter(p => p.category === 'large_fruit' && p.details && p.details[fieldName])
                        .map(p => p.details[fieldName])
                        .filter(v => v && v.trim() !== '');
                }
            } else {
                // 水果其他欄位：從水果產品中獲取對應欄位
                values = products
                    .filter(p => p.category === category && p.details && p.details[fieldName])
                    .map(p => p.details[fieldName])
                    .filter(v => v && v.trim() !== '');
            }
            
            // 去重並排序
            return [...new Set(values)].sort((a, b) => {
                // 中文和英文混合排序
                return a.localeCompare(b, 'zh-TW', { numeric: true, caseFirst: 'lower' });
            });
        };
        
        // 渲染下拉選項
        const renderOptions = (options) => {
            if (options.length === 0) {
                dropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">無相關選項</div>';
                return;
            }
            
            dropdown.innerHTML = options.map(option => 
                `<div class="dropdown-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0" data-value="${option}">${option}</div>`
            ).join('');
            
            // 為每個選項添加點擊事件
            dropdown.querySelectorAll('.dropdown-option').forEach(option => {
                option.addEventListener('click', () => {
                    isOptionClicked = true;
                    input.value = option.dataset.value;
                    dropdown.classList.add('hidden');
                    
                    // 觸發 input 和 change 事件，以便分層控制能夠更新
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // 延遲focus並重設標誌
                    setTimeout(() => {
                        input.focus();
                        // 延長標誌重設時間，確保所有相關事件都處理完畢
                        setTimeout(() => {
                            isOptionClicked = false;
                        }, 200);
                    }, 100);
                });
            });
        };
        
        // 搜尋功能
        const filterOptions = (searchTerm) => {
            const allValues = getExistingValues();
            if (!searchTerm.trim()) {
                return allValues;
            }
            
            return allValues.filter(value => 
                value.toLowerCase().includes(searchTerm.toLowerCase())
            );
        };
        
        // 防抖功能
        let debounceTimer;
        const debounce = (func, delay) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        };
        
        // 輸入事件監聽
        input.addEventListener('input', (e) => {
            // 如果欄位被禁用，不處理
            if (input.disabled) return;
            
            // 如果是因為點擊選項而觸發的input事件，不顯示下拉選單
            if (isOptionClicked) return;
            
            // 如果事件不是由用戶輸入觸發的（即程式觸發），不顯示下拉選單
            if (!e.isTrusted) return;
            
            const searchTerm = e.target.value;
            
            debounce(() => {
                const filteredOptions = filterOptions(searchTerm);
                renderOptions(filteredOptions);
                
                if (filteredOptions.length > 0) {
                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
            }, 150);
        });
        // 點擊輸入框展開全部選項
        input.addEventListener('click', () => {
            // 如果欄位被禁用，不處理
            if (input.disabled) return;
            
            // 如果是因為點擊選項而觸發的click，不重新顯示下拉選單
            if (isOptionClicked) return;
            
            const allValues = getExistingValues();
            renderOptions(allValues);
            
            if (allValues.length > 0) {
                dropdown.classList.remove('hidden');
            }
        });
        
        // 獲得焦點時的處理
        input.addEventListener('focus', () => {
            // 如果欄位被禁用，不處理
            if (input.disabled) return;
            
            // 如果是因為點擊選項而獲得焦點，不重新顯示下拉選單
            if (isOptionClicked) return;
            
            if (input.value.trim() === '') {
                const allValues = getExistingValues();
                renderOptions(allValues);
                
                if (allValues.length > 0) {
                    dropdown.classList.remove('hidden');
                }
            }
        });
        
        // 失去焦點時隱藏下拉選單（延遲以允許點擊選項）
        input.addEventListener('blur', () => {
            setTimeout(() => {
                dropdown.classList.add('hidden');
            }, 200);
        });
        
        // ESC 鍵關閉下拉選單
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
                input.blur();
            }
        });
        
        // 點擊其他地方關閉下拉選單
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }
    
    // 設置包材名稱和規格的聯動功能
    function setupPackagingNameSpecLink() {
        const nameInput = document.getElementById('packaging-name');
        const specInput = document.getElementById('packaging-spec');
        const specDropdown = document.getElementById('packaging-spec-dropdown');
        
        if (!nameInput || !specInput || !specDropdown) return;
        
        // 當包材名稱改變時，更新規格選項
        const updateSpecOptions = () => {
            // 觸發規格欄位的智能輸入更新
            const currentSpecValue = specInput.value;
            
            // 清空當前規格下拉選單
            specDropdown.classList.add('hidden');
            
            // 如果規格欄位有焦點，重新顯示選項
            if (document.activeElement === specInput) {
                setTimeout(() => {
                    // 模擬點擊規格欄位來更新選項
                    specInput.dispatchEvent(new Event('click'));
                }, 100);
            }
        };
        
        // 監聽包材名稱的輸入和選擇
        nameInput.addEventListener('input', updateSpecOptions);
        nameInput.addEventListener('change', updateSpecOptions);
        
        // 監聽下拉選項的選擇
        const observer = new MutationObserver(() => {
            const nameDropdown = document.getElementById('packaging-name-dropdown');
            if (nameDropdown) {
                nameDropdown.querySelectorAll('.dropdown-option').forEach(option => {
                    option.addEventListener('click', () => {
                        setTimeout(updateSpecOptions, 50);
                    });
                });
            }
        });
        
        const nameDropdown = document.getElementById('packaging-name-dropdown');
        if (nameDropdown) {
            observer.observe(nameDropdown, { childList: true, subtree: true });
        }
    }
    
    function renderDashboard() {
        dashboardContainer.innerHTML = '';
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        // KPIs (Not affected by filters)
        const pendingWOs = workOrders.filter(wo => wo.status === '待處理').length;
        const inProgressWOs = workOrders.filter(wo => wo.status === '包裝中').length;
        const lowStockItems = getLowStockCount();
        const kpiHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="bg-yellow-100 p-4 rounded-lg shadow-sm"><p class="text-sm text-yellow-800 font-semibold">待處理工單</p><p class="text-3xl font-bold text-yellow-900">${pendingWOs}</p></div><div class="bg-blue-100 p-4 rounded-lg shadow-sm"><p class="text-sm text-blue-800 font-semibold">包裝中工單</p><p class="text-3xl font-bold text-blue-900">${inProgressWOs}</p></div><div class="bg-red-100 p-4 rounded-lg shadow-sm cursor-pointer hover:bg-red-200 transition-colors" onclick="showLowStockDetails()"><p class="text-sm text-red-800 font-semibold">低庫存警告</p><p class="text-3xl font-bold text-red-900">${lowStockItems}</p><p class="text-xs text-red-600 mt-1">點擊查看詳情</p></div></div>`;
        dashboardContainer.innerHTML += kpiHtml;

        // Quick Actions
        const actionsHtml = `<div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold mb-3">快捷功能</h3><div class="flex gap-4"><button id="dash-check-inv-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">庫存查詢</button></div></div>`;
        dashboardContainer.innerHTML += actionsHtml;
        document.getElementById('dash-check-inv-btn').addEventListener('click', openInventoryLookupModal);

        // Charts (Affected by filters)
        const chartsHtml = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold mb-4">工單狀態分析</h3><canvas id="monthlyStatusChart"></canvas></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold mb-4">成品產量佔比</h3><canvas id="productionPieChart"></canvas></div></div>`;
        dashboardContainer.innerHTML += chartsHtml;

        const filteredWO = getFilteredWorkOrders('dashboard');
        
        // Bar Chart: Mix of filtered and unfiltered data
        const statusCounts = { '待處理': pendingWOs, '包裝中': inProgressWOs, '已完成': filteredWO.length };
        const barCtx = document.getElementById('monthlyStatusChart').getContext('2d');
        charts.bar = new Chart(barCtx, {
            type: 'bar',
            data: { labels: Object.keys(statusCounts), datasets: [{ label: '工單數量', data: Object.values(statusCounts), backgroundColor: ['#fbbf24', '#60a5fa', '#34d399'] }] },
            options: { indexAxis: 'y', elements: { bar: { borderWidth: 2, } }, responsive: true, plugins: { legend: { display: false } } }
        });

        // Pie Chart
        const pieData = {};
        filteredWO.filter(wo => wo.status === '已完成').forEach(wo => {
            const productName = findProduct(wo.smallItemSku).name;
            pieData[productName] = (pieData[productName] || 0) + wo.packagingResult.producedCount;
        });
        
        if (Object.keys(pieData).length > 0) {
            const pieCtx = document.getElementById('productionPieChart').getContext('2d');
            charts.pie = new Chart(pieCtx, {
                type: 'pie',
                data: { labels: Object.keys(pieData), datasets: [{ label: '生產數量', data: Object.values(pieData), backgroundColor: ['#34d399', '#60a5fa', '#f87171', '#fbbf24', '#a78bfa', '#f472b6'], hoverOffset: 4 }] }
            });
        } else { document.getElementById('productionPieChart').outerHTML = `<p class="text-center text-gray-500 py-8">此篩選範圍無已完成工單資料</p>` }
    }

    // --- Action Listeners ---
    function attachActionListeners(wo) { /* ... same as before ... */ }
    function attachInventoryActionListeners() { /* ... same as before ... */ }
    function attachMaintenanceListeners() { /* ... same as before ... */ }
    function renderLocations() {
        const container = document.getElementById('view-locations');
        if (!container) return;
        const listEl = container.querySelector('#locations-list');
        const addBtn = container.querySelector('#add-location-btn');
        if (!listEl || !addBtn) return;

        const renderList = () => {
            if (storageLocations.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500">尚無儲位資料，請點擊「新增儲位」。</p>`;
                return;
            }
            
            const rows = storageLocations.map((loc, idx) => {
                // 計算該儲位的包材庫存
                const locationInventory = {};
                inventoryLog.filter(log => log.sku && log.storageLocation === loc).forEach(log => {
                    const product = findProduct(log.sku);
                    if (product && product.category === 'packaging') {
                        if (!locationInventory[log.sku]) {
                            locationInventory[log.sku] = {
                                product: product,
                                quantity: 0
                            };
                        }
                        locationInventory[log.sku].quantity += log.quantity;
                    }
                });
                
                // 過濾掉數量為 0 或負數的項目
                const validItems = Object.values(locationInventory).filter(item => item.quantity > 0);
                
                // 生成包材清單 HTML
                let packagingListHtml = '';
                if (validItems.length > 0) {
                    packagingListHtml = validItems.map(item => 
                        `<div class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded mb-1">
                            <span class="font-medium">${item.product.name}</span>
                            <span class="text-blue-600 ml-1">(${item.quantity.toLocaleString()})</span>
                        </div>`
                    ).join('');
                } else {
                    packagingListHtml = '<span class="text-xs text-gray-400">無包材</span>';
                }
                
                return `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-center text-sm text-gray-900">${loc}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="max-w-xs mx-auto">
                            ${packagingListHtml}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex justify-center gap-2">
                            <button data-idx="${idx}" class="edit-location-btn text-blue-600 hover:bg-blue-50 rounded p-2 transition-colors" title="編輯儲位">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button data-idx="${idx}" class="delete-location-btn text-red-600 hover:bg-red-50 rounded p-2 transition-colors" title="刪除儲位">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            
            listEl.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">儲位名稱</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">存放包材</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            
            // 編輯儲位按鈕事件
            listEl.querySelectorAll('.edit-location-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const i = parseInt(button.dataset.idx);
                    if (!Number.isNaN(i)) { 
                        openEditLocationModal(storageLocations[i], i); 
                    }
                });
            });
            
            // 刪除儲位按鈕事件
            listEl.querySelectorAll('.delete-location-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // 確保我們獲取的是按鈕元素，而不是內部的 SVG
                    const button = e.currentTarget;
                    const i = parseInt(button.dataset.idx);
                    if (!Number.isNaN(i)) { storageLocations.splice(i, 1); renderList(); }
                });
            });
        };

        addBtn.onclick = () => {
            const formHtml = `<form id=\"add-location-form\" class=\"p-6 space-y-4\"><h3 class=\"text-lg font-semibold border-b pb-3\">新增儲位</h3><div><label class=\"block text-sm font-medium\">儲位名稱</label><input name=\"name\" required class=\"mt-1 w-full rounded-md border-gray-300 shadow-sm\" placeholder=\"例如：主倉-A1\"></div><div class=\"pt-4 flex justify-end gap-3\"><button type=\"button\" class=\"cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300\">取消</button><button type=\"submit\" class=\"bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700\">儲存</button></div></form>`;
            openModal(formHtml);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            document.getElementById('add-location-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const name = (formData.get('name') || '').toString().trim();
                if (!name) return;
                if (storageLocations.includes(name)) { alert('此儲位名稱已存在'); return; }
                storageLocations.push(name);
                closeModal();
                renderList();
            });
        };

        renderList();
        
        // 編輯儲位的模態框
        function openEditLocationModal(currentName, index) {
            const formHtml = `<form id="edit-location-form" class="p-6 space-y-4"><h3 class="text-lg font-semibold border-b pb-3">編輯儲位</h3><div><label class="block text-sm font-medium">儲位名稱</label><input name="name" value="${currentName}" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div><div class="pt-4 flex justify-end gap-3"><button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">儲存</button></div></form>`;
            openModal(formHtml);
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            document.getElementById('edit-location-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newName = (formData.get('name') || '').toString().trim();
                if (!newName) return;
                if (storageLocations.includes(newName) && newName !== currentName) { 
                    alert('此儲位名稱已存在'); 
                    return; 
                }
                storageLocations[index] = newName;
                closeModal();
                renderList();
            });
        }
        
        // 將 renderList 函數設為全域，供其他頁面調用
        window.updateStorageLocationDisplay = renderList;
    }
    
    // --- Re-implementations ---
    attachActionListeners = function(wo) {
        const dispatchBtn = document.getElementById('dispatch-btn');
        if (dispatchBtn) { dispatchBtn.addEventListener('click', () => { const dispatchedUnits = wo.warehouseInfo.requestUnits; if (!dispatchedUnits || dispatchedUnits <= 0) { alert('需求數量無效！'); return; } const stockItem = findStock(wo.largeItemSku); const lot = stockItem.lots.find(l => l.lotNumber === wo.sourceLotNumber); if (!lot || lot.quantity < dispatchedUnits) { alert(`工號 ${wo.sourceLotNumber} 庫存不足！\n需求數量: ${dispatchedUnits}\n該工號庫存: ${lot ? lot.quantity : 0}`); return; } lot.quantity -= dispatchedUnits; stockItem.quantity -= dispatchedUnits; addInventoryLog(wo.largeItemSku, '工單領料', -dispatchedUnits, `工單: ${wo.id}`, wo.sourceLotNumber); wo.status = '包裝中'; wo.warehouseInfo.dispatchedUnits = dispatchedUnits; wo.packagingResult.receivedUnits = dispatchedUnits; wo.warehouseInfo.dispatchedBy = `倉儲-${currentRole || '人員'}`; wo.warehouseInfo.dispatchedAt = new Date(); renderApp(); }); }
        const completePackagingBtn = document.getElementById('complete-packaging-btn');
                if (completePackagingBtn) {
            completePackagingBtn.addEventListener('click', () => {
                const producedCount = parseInt(document.getElementById('producedCount').value);
                if (!producedCount || producedCount < 0) { alert('請輸入有效的成品數量！'); return; }

                const materialsToCheck = [{sku: wo.boxSku, name: findProduct(wo.boxSku)?.name || wo.boxSku}];
                if (wo.additionalPackagingSkus && Array.isArray(wo.additionalPackagingSkus)) {
                    wo.additionalPackagingSkus.forEach(sku => {
                        materialsToCheck.push({sku: sku, name: findProduct(sku)?.name || sku});
                    });
                }

                for (const material of materialsToCheck) {
                    const stockItem = findStock(material.sku);
                    if (!stockItem || stockItem.quantity < producedCount) {
                        alert(`包材庫存不足！\n品項: ${material.name}\n需求數量: ${producedCount}\n現有庫存: ${stockItem ? stockItem.quantity : 0}`);
                        return;
                    }
                }

                const returnedUnits = parseInt(document.getElementById('returnedUnits').value) || 0;
                const ngCount = parseInt(document.getElementById('ngCount').value) || 0;

                materialsToCheck.forEach(material => {
                    const stockItem = findStock(material.sku);
                    stockItem.quantity -= producedCount;
                    addInventoryLog(material.sku, '工單耗用', -producedCount, `工單: ${wo.id}`);
                });

                let finalCost = 0;
                if (producedCount > 0) {
                    let totalPackagingCost = 0;
                    materialsToCheck.forEach(material => {
                        const product = findProduct(material.sku);
                        if (product?.details?.price) {
                            totalPackagingCost += product.details.price;
                        }
                    });
                    const totalMaterialCost = wo.costing.unitCost * (wo.warehouseInfo.dispatchedUnits - returnedUnits);
                    // 公式: (大件成本 * (出庫-退庫)件數 / 小件成品數) + 盒子費用 + 其他包材費用
                    // 最終成本四捨五入，不要小數點
                    finalCost = Math.round((totalMaterialCost / producedCount) + totalPackagingCost);
                }
                
                const smallStockItem = findStock(wo.smallItemSku); 
                if (smallStockItem) { 
                    smallStockItem.quantity += producedCount; 
                    addInventoryLog(wo.smallItemSku, '成品入庫', producedCount, `工單: ${wo.id}`, wo.sourceLotNumber, finalCost); 
                } 
                if (returnedUnits > 0) { 
                    const largeStockItem = findStock(wo.largeItemSku); 
                    const lot = largeStockItem.lots.find(l => l.lotNumber === wo.sourceLotNumber); 
                    if (lot) { 
                        lot.quantity += returnedUnits; 
                        largeStockItem.quantity += returnedUnits; 
                        addInventoryLog(wo.largeItemSku, '工單退料', returnedUnits, `工單: ${wo.id}`, wo.sourceLotNumber);
                    } 
                } 
                wo.status = '已完成'; 
                wo.packagingResult.producedCount = producedCount; 
                wo.packagingResult.ngCount = ngCount; 
                wo.warehouseInfo.returnedUnits = returnedUnits; 
                wo.packagingResult.completedBy = `包裝-${currentRole || '人員'}`; 
                wo.packagingResult.completedAt = new Date(); 
                wo.costing.finalCostPerPackage = finalCost; 
                renderApp();
            });
        }

    };
    attachInventoryActionListeners = function() {
        // 狐狸頭匯入按鈕事件監聽
        document.querySelectorAll('.fox-import-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                openFoxImportModal();
            });
        });
        
        document.querySelectorAll('.stock-in-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = e.target.dataset.type;
                const subtype = e.target.dataset.subtype;
                const items = products.filter(p => p.category === type && (!subtype || p.details?.type === subtype));
                let options = items.map(p => {
                    const displayName = p.category === 'small_fruit' ? getSmallItemDisplayName(p.sku) : p.name;
                    return `<option value="${p.sku}">${displayName}</option>`;
                }).join('');
                const initialLot = type === 'large_fruit' ? generateLotNumberForSku(items[0]?.sku || 'NN') : '';
                const lotInputHtml = type === 'large_fruit' ? `<div><label class="block text-sm font-medium">工號 (系統自動生成)</label><input name="lotNumber" readonly value="${initialLot}" class="mt-1 w-full rounded-md border-gray-200 bg-gray-100 shadow-sm"></div>` : '';
                const getDefaultLocationForSku = (sku) => {
                    const product = findProduct(sku);
                    return product?.details?.defaultStorageLocation || null;
                };
                const locationSelectHtml = type === 'packaging' ? `<div><label class="block text-sm font-medium">儲位</label>${storageLocations.length > 0 ? `<select name=\"storageLocation\" required class=\"mt-1 w-full rounded-md border-gray-300 shadow-sm\" id=\"storage-location-select\">${storageLocations.map(loc => `<option value=\"${loc}\">${loc}</option>`).join('')}</select><p class=\"text-xs text-gray-500 mt-1\">系統會根據選擇的品項自動設定預設儲位</p>` : `<select name=\"storageLocation\" required class=\"mt-1 w-full rounded-md border-gray-300 shadow-sm\"><option value=\"\" disabled selected>請先至「儲位」分頁新增</option></select><p class=\"text-xs text-red-600 mt-1\">尚無儲位資料，請先新增。</p>`}</div>` : '';
                const formHtml = `<form id="stock-in-form" class="p-6 space-y-4"><h3 class="text-lg font-semibold border-b pb-3">庫存入庫</h3><div><label class="block text-sm font-medium">品項</label><select name="sku" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${options}</select></div>${lotInputHtml}${locationSelectHtml}<div><label class="block text-sm font-medium">入庫數量</label><input name="quantity" type="number" min="1" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div><div class="pt-4 flex justify-end gap-3"><button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">確認入庫</button></div></form>`;
                openModal(formHtml);
                document.querySelector('.cancel-btn').addEventListener('click', closeModal);
                const formEl = document.getElementById('stock-in-form');
                const skuSelect = formEl.querySelector('select[name="sku"]');
                const lotInput = formEl.querySelector('input[name="lotNumber"]');
                const locationSelect = formEl.querySelector('#storage-location-select');
                
                // 設定初始預設儲位
                if (skuSelect && locationSelect && type === 'packaging') {
                    const setDefaultLocation = (sku) => {
                        const defaultLocation = getDefaultLocationForSku(sku);
                        if (defaultLocation && storageLocations.includes(defaultLocation)) {
                            locationSelect.value = defaultLocation;
                        }
                    };
                    // 設定初始值
                    if (skuSelect.value) {
                        setDefaultLocation(skuSelect.value);
                    }
                }
                
                if (skuSelect && lotInput) { 
                    skuSelect.addEventListener('change', () => { 
                        lotInput.value = generateLotNumberForSku(skuSelect.value); 
                    }); 
                }
                
                if (skuSelect && locationSelect && type === 'packaging') {
                    skuSelect.addEventListener('change', () => {
                        const defaultLocation = getDefaultLocationForSku(skuSelect.value);
                        if (defaultLocation && storageLocations.includes(defaultLocation)) {
                            locationSelect.value = defaultLocation;
                        }
                    });
                }
                formEl.addEventListener('submit', (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    const sku = formData.get('sku');
                    const quantity = parseInt(formData.get('quantity'));
                    let lotNumber = formData.get('lotNumber');
                    const storageLocation = type === 'packaging' ? formData.get('storageLocation') : undefined;
                    if (type === 'packaging' && (!storageLocation || storageLocation === '')) { alert('請選擇儲位'); return; }
                    const stockItem = findStock(sku);
                                            if (stockItem && quantity > 0) {
                            stockItem.quantity += quantity;
                            if (lotNumber) {
                                const exists = inventory.some(item => Array.isArray(item.lots) && item.lots.some(l => l.lotNumber === lotNumber));
                                if (exists) { lotNumber = generateLotNumberForSku(sku); }
                                if (!stockItem.lots) stockItem.lots = [];
                                let lot = stockItem.lots.find(l => l.lotNumber === lotNumber);
                                if (lot) { lot.quantity += quantity; } else { stockItem.lots.push({ lotNumber, quantity }); }
                                addInventoryLog(sku, '手動入庫', quantity, '採購/到貨', lotNumber, 0, storageLocation);
                            } else {
                                addInventoryLog(sku, '手動入庫', quantity, '採購/到貨', null, 0, storageLocation);
                            }
                            
                            // 如果是包材，只更新對應的包材表格，避免整頁重新渲染
                            if (type === 'packaging' && subtype) {
                                updatePackagingSubtypeTable(subtype);
                                // 同時更新儲位顯示（如果儲位頁面已載入）
                                if (typeof window.updateStorageLocationDisplay === 'function') {
                                    window.updateStorageLocationDisplay();
                                }
                            } else {
                                renderInventory();
                            }
                        }
                    closeModal();
                });
            });
        });
        document.querySelectorAll('.adjust-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = e.target.dataset.type;
                const subtype = e.target.dataset.subtype;
                const items = products.filter(p => p.category === type && (!subtype || p.details?.type === subtype));
                let options = items.map(p => {
                    const displayName = p.category === 'small_fruit' ? getSmallItemDisplayName(p.sku) : p.name;
                    return `<option value="${p.sku}">${displayName}</option>`;
                }).join('');
                const formHtml = `<form id="adjust-form" class="p-6 space-y-4"><h3 class="text-lg font-semibold border-b pb-3">庫存異動 (減損)</h3><div><label class="block text-sm font-medium">品項</label><select name="sku" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${options}</select></div><div><label class="block text-sm font-medium">減損數量 (請輸入正數)</label><input name="quantity" type="number" min="1" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div><div><label class="block text-sm font-medium">備註 (原因)</label><input name="remark" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm" placeholder="例如：盤點損毀"></div><div class="pt-4 flex justify-end gap-3"><button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">確認異動</button></div></form>`;
                openModal(formHtml);
                document.querySelector('.cancel-btn').addEventListener('click', closeModal);
                document.getElementById('adjust-form').addEventListener('submit', (ev) => {
                    ev.preventDefault();
                    const formData = new FormData(ev.target);
                    const sku = formData.get('sku');
                    const quantity = parseInt(formData.get('quantity'));
                    const remark = formData.get('remark');
                    const stockItem = findStock(sku);
                    if (stockItem && quantity > 0) {
                        if (stockItem.quantity - quantity < 0) { alert('錯誤：庫存不足以減損！'); return; }
                        stockItem.quantity -= quantity;
                        if (stockItem.lots && stockItem.lots.length > 0) { stockItem.lots[0].quantity -= quantity; }
                        addInventoryLog(sku, '庫存異動', -quantity, remark);
                        
                        // 如果是包材，只更新對應的包材表格，避免整頁重新渲染
                        if (type === 'packaging' && subtype) {
                            updatePackagingSubtypeTable(subtype);
                            // 同時更新儲位顯示（如果儲位頁面已載入）
                            if (typeof window.updateStorageLocationDisplay === 'function') {
                                window.updateStorageLocationDisplay();
                            }
                        } else {
                            renderInventory();
                        }
                    }
                    closeModal();
                });
            });
        });
    };
    attachMaintenanceListeners = function() { 
        const addFruitBtn = document.getElementById('add-fruit-btn');
        if (addFruitBtn) {
            addFruitBtn.addEventListener('click', () => { 
                const formHtml = `<form id="add-fruit-form" class="p-6 space-y-4"><h3 class="text-lg font-semibold border-b pb-3">新增水果品項</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative"><label class="block text-sm font-medium">Category <span class="text-red-500">*</span></label><input name="category" id="category-input" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm" autocomplete="off" placeholder="請先輸入Category"><div id="category-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">水果種類(Series) <span class="text-red-500">*</span></label><input name="fruitType" id="fruitType-input" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成Category" disabled><div id="fruitType-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">品種(Variety) <span class="text-red-500">*</span></label><input name="variety" id="variety-input" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成水果種類(Series)" disabled><div id="variety-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">國家 <span class="text-red-500">*</span></label><input name="country" id="country-input" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成前三層" disabled><div id="country-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">區域</label><input name="region" id="region-input" class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成前三層" disabled><div id="region-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">大小(Size) <span class="text-red-500">*</span></label><input name="size" id="size-input" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成前三層" disabled><div id="size-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">等級</label><input name="grade" id="grade-input" class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成前三層" disabled><div id="grade-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div><div class="relative"><label class="block text-sm font-medium">品牌</label><input name="brand" id="brand-input" class="mt-1 w-full rounded-md border-gray-300 shadow-sm bg-gray-100" autocomplete="off" placeholder="請先完成前三層" disabled><div id="brand-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div></div></div><div class="pt-4 flex justify-end gap-3"><button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">儲存</button></div></form>`; 
                openModal(formHtml); 
                document.querySelector('.cancel-btn').addEventListener('click', closeModal); 
                
                // 先初始化分層輸入控制
                initFruitHierarchyControl();
                
                // 然後初始化所有欄位的智能輸入功能
                initSmartInput('category');
                initSmartInput('fruitType');
                initSmartInput('variety');
                initSmartInput('country');
                initSmartInput('region');
                initSmartInput('size');
                initSmartInput('grade');
                initSmartInput('brand');
                 
                document.getElementById('add-fruit-form').addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    const formData = new FormData(e.target); 
                    
                    // 根據新的命名規則生成水果名稱：國家+區域+品種
                    const country = formData.get('country') || '';
                    const region = formData.get('region') || '';
                    const variety = formData.get('variety') || '';
                    const generatedName = `${country}${region}${variety}`.trim();
                    
                    // 檢查是否有重複的品項
                    const newItem = {
                        name: generatedName,
                        category: formData.get('category'),
                        fruitType: formData.get('fruitType'),
                        variety: formData.get('variety'),
                        country: formData.get('country'),
                        region: formData.get('region'),
                        size: formData.get('size'),
                        grade: formData.get('grade'),
                        brand: formData.get('brand')
                    };
                    
                    // 檢查關鍵欄位組合是否重複
                    const isDuplicate = products.some(p => 
                        p.category === 'large_fruit' &&
                        p.name === newItem.name &&
                        p.details?.category === newItem.category &&
                        p.details?.fruitType === newItem.fruitType &&
                        p.details?.variety === newItem.variety &&
                        p.details?.country === newItem.country &&
                        p.details?.region === newItem.region &&
                        p.details?.size === newItem.size
                    );
                    
                    if (isDuplicate) {
                        // 顯示重複警告，讓用戶選擇
                        const confirmMessage = `偵測到相似的品項已存在：\n\n名稱: ${newItem.name}\n商品種類: ${newItem.category || 'N/A'}\n水果種類: ${newItem.fruitType || 'N/A'}\n品種: ${newItem.variety || 'N/A'}\n國家: ${newItem.country || 'N/A'}\n區域: ${newItem.region || 'N/A'}\n大小: ${newItem.size || 'N/A'}\n\n是否仍要新增此品項？`;
                        
                        if (!confirm(confirmMessage)) {
                            return; // 用戶取消新增
                        }
                    } 
                    // 使用自動生成的 SKU
                    const generatedSku = generateFruitSku(
                        generatedName, 
                        formData.get('country'), 
                        formData.get('variety')
                    );
                    
                    const newFruit = { 
                        sku: generatedSku, 
                        category: 'large_fruit', 
                        name: generatedName, 
                        details: { 
                            category: formData.get('category'),
                            fruitType: formData.get('fruitType'),
                            variety: formData.get('variety'), 
                            country: formData.get('country'), 
                            region: formData.get('region'), 
                            size: formData.get('size'), 
                            grade: formData.get('grade'), 
                            brand: formData.get('brand')
                        } 
                    }; 
                    products.push(newFruit); 
                    inventory.push({ sku: newFruit.sku, quantity: 0, lots: [] }); 
                    renderMaintenance(); 
                    closeModal(); 
                }); 
            }); 
        }
    };

    // 常用包材組合管理功能
    function attachFavoriteComboListeners() {
        // 移除舊的事件監聽器，避免重複綁定
        document.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
            // 創建新的事件處理器
            btn.onclick = null; // 清除舊的事件
        });
        
        // 顯示/隱藏切換
        document.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
            btn.onclick = (e) => {
                // 確保我們獲取的是按鈕元素，而不是內部的 SVG
                const button = e.currentTarget;
                const comboId = button.dataset.comboId;
                const combo = favoritePackagingCombos.find(c => c.id === comboId);
                if (!combo) return;
                
                combo.visible = !combo.visible;
                
                // 直接更新圖示，避免整個分頁重新渲染造成閃爍
                updateVisibilityIconOnly(button, combo.visible);
            };
        });
        
        // 重新命名
        document.querySelectorAll('.rename-combo-btn').forEach(btn => {
            btn.onclick = (e) => {
                // 確保我們獲取的是按鈕元素，而不是內部的 SVG
                const button = e.currentTarget;
                const comboId = button.dataset.comboId;
                const combo = favoritePackagingCombos.find(c => c.id === comboId);
                if (!combo) return;
                
                openRenameComboModal(combo);
            };
        });
        
        // 編輯包材選項
        document.querySelectorAll('.edit-packaging-btn').forEach(btn => {
            btn.onclick = (e) => {
                // 確保我們獲取的是按鈕元素，而不是內部的 SVG
                const button = e.currentTarget;
                const comboId = button.dataset.comboId;
                const combo = favoritePackagingCombos.find(c => c.id === comboId);
                if (!combo) return;
                
                openEditPackagingModal(combo);
            };
        });
        
        // 刪除組合
        document.querySelectorAll('.delete-combo-btn').forEach(btn => {
            btn.onclick = (e) => {
                // 確保我們獲取的是按鈕元素，而不是內部的 SVG
                const button = e.currentTarget;
                const comboId = button.dataset.comboId;
                const combo = favoritePackagingCombos.find(c => c.id === comboId);
                if (!combo) return;
                
                openDeleteComboModal(combo);
            };
        });
    }
    
    // 直接更新眼睛圖示，避免重新渲染造成閃爍
    function updateVisibilityIconOnly(button, isVisible) {
        const svg = button.querySelector('svg');
        if (!svg) return;
        
        // 更新 SVG 的 class 和顏色
        if (isVisible) {
            svg.className = 'w-5 h-5 text-green-600';
            // 更新為可見眼睛的 path
            svg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>`;
        } else {
            svg.className = 'w-5 h-5 text-gray-400';
            // 更新為隱藏眼睛的 path
            svg.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>`;
        }
        
        // 更新 title 屬性
        button.title = isVisible ? '點擊隱藏' : '點擊顯示';
    }
    
    // 重新渲染資料維護並保持在指定分頁
    function renderMaintenanceAndStayOnTab(targetPaneId) {
        if (targetPaneId === 'favorite-combo-pane') {
            // 直接更新常用包材組合分頁，避免整頁重新渲染
            updateFavoriteComboPane();
        } else {
            // 其他分頁使用原本的邏輯
            renderMaintenance();
            
            // 切換到指定分頁
            setTimeout(() => {
                const targetTab = maintenanceSubTabs.querySelector(`[data-pane="${targetPaneId}"]`);
                const targetPane = maintenancePanesContainer.querySelector(`#${targetPaneId}`);
                
                if (targetTab && targetPane) {
                    // 移除所有分頁的 active 狀態
                    maintenanceSubTabs.querySelectorAll('.sub-tab').forEach(t => {
                        t.classList.remove('active');
                        t.classList.add('bg-gray-100', 'hover:bg-gray-200');
                    });
                    
                    // 設定目標分頁為 active
                    targetTab.classList.add('active');
                    targetTab.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    
                    // 隱藏所有分頁內容
                    maintenancePanesContainer.querySelectorAll('.sub-pane').forEach(p => p.classList.add('hidden-pane'));
                    
                    // 顯示目標分頁內容
                    targetPane.classList.remove('hidden-pane');
                }
            }, 10);
        }
    }
    
    // 直接更新常用包材組合分頁內容
    function updateFavoriteComboPane() {
        const favoriteComboPane = document.getElementById('favorite-combo-pane');
        if (!favoriteComboPane) {
            console.log('找不到 favorite-combo-pane 元素，嘗試完整重新渲染');
            // 如果找不到元素，嘗試完整重新渲染資料維護頁面
            if (currentView === 'maintenance') {
                renderMaintenance();
            }
            return;
        }
        
        console.log('正在更新常用組合分頁...');
        
        // 在顯示前先清理無效的包材
        const removedCount = cleanupInvalidPackagingInCombos();
        console.log(`清理了 ${removedCount} 個空組合`);
        
        // 重新生成常用包材組合表格
        const favoriteComboTable = favoritePackagingCombos.map(combo => {
            const boxProduct = findProduct(combo.boxSku);
            const additionalProducts = combo.additionalSkus.map(sku => findProduct(sku)).filter(Boolean);
            const additionalNames = additionalProducts.map(p => p.name).join('、') || '無';
            
            // 計算總價格
            const totalPrice = calculateComboTotalPrice(combo.boxSku, combo.additionalSkus);
            
            // 使用 Heroicons 的眼睛圖示
            const visibilityIcon = combo.visible 
                ? `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`
                : `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path></svg>`;
            
            // 使用 Heroicons 的編輯和刪除圖示
            const editNameIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`;
            const editPackagingIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path></svg>`;
            const deleteIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            
            return `<tr class="hover:bg-gray-50">
                <td class="px-4 py-4 text-center">
                    <div class="text-sm font-medium text-gray-900">${combo.name}</div>
                    <div class="text-xs text-gray-500">建立於: ${combo.createdAt.toLocaleDateString()}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="text-sm text-gray-900">${boxProduct ? boxProduct.name : '未知盒子'}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="text-sm text-gray-700">${additionalNames}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="text-sm font-medium text-gray-900">$${totalPrice.toLocaleString()}</div>
                </td>
                <td class="px-4 py-4 text-center">
                    <button data-combo-id="${combo.id}" class="toggle-visibility-btn hover:bg-gray-100 rounded p-2 transition-colors" title="${combo.visible ? '點擊隱藏' : '點擊顯示'}">${visibilityIcon}</button>
                </td>
                <td class="px-4 py-4 text-center">
                    <div class="flex justify-center gap-2">
                        <button data-combo-id="${combo.id}" class="rename-combo-btn text-blue-600 hover:bg-blue-50 rounded p-2 transition-colors" title="重新命名">${editNameIcon}</button>
                        <button data-combo-id="${combo.id}" class="edit-packaging-btn text-purple-600 hover:bg-purple-50 rounded p-2 transition-colors" title="編輯包材選項">${editPackagingIcon}</button>
                        <button data-combo-id="${combo.id}" class="delete-combo-btn text-red-600 hover:bg-red-50 rounded p-2 transition-colors" title="刪除">${deleteIcon}</button>
                    </div>
                </td>
            </tr>`;
        }).join('');
        
        // 更新表格內容
        const tableBody = favoriteComboPane.querySelector('tbody');
        if (tableBody) {
            console.log('更新表格內容，組合數量:', favoritePackagingCombos.length);
            tableBody.innerHTML = favoriteComboTable;
            // 重新綁定事件監聽器
            attachFavoriteComboListeners();
            console.log('常用組合分頁更新完成');
        } else {
            console.log('找不到表格 tbody 元素');
        }
    }
    // 重新命名組合的模態框
    function openRenameComboModal(combo) {
        const modalHtml = `
            <form id="rename-combo-form" class="p-6 space-y-4">
                <h3 class="text-lg font-semibold border-b pb-3">重新命名常用組合</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">組合名稱</label>
                    <input type="text" id="combo-name-input" value="${combo.name}" 
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" 
                           placeholder="請輸入新的組合名稱" required>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">取消</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">確認修改</button>
                </div>
            </form>`;
        
        openModal(modalHtml);
        
        // 聚焦到輸入框並選中文字
        setTimeout(() => {
            const input = document.getElementById('combo-name-input');
            if (input) {
                input.focus();
                input.select();
            }
        }, 100);
        
        document.querySelector('.cancel-btn').addEventListener('click', () => {
            closeModal();
            // 如果目前就在資料維護頁面，直接更新常用包材組合分頁
            if (currentView === 'maintenance') {
                renderMaintenanceAndStayOnTab('favorite-combo-pane');
            } else {
                // 切換到資料維護頁面的常用包材組合分頁
                currentView = 'maintenance';
                renderApp();
                setTimeout(() => {
                    const targetTab = document.querySelector('[data-pane="favorite-combo-pane"]');
                    if (targetTab) {
                        targetTab.click();
                    }
                }, 100);
            }
        });
        document.getElementById('rename-combo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('combo-name-input').value.trim();
            const inputElement = document.getElementById('combo-name-input');
            
            // 清除之前的錯誤樣式
            inputElement.classList.remove('border-red-500', 'ring-red-500');
            let errorElement = document.getElementById('rename-error-message');
            if (errorElement) {
                errorElement.remove();
            }
            
            if (!newName) {
                // 在表單內顯示錯誤訊息，不開啟新的模態框
                inputElement.classList.add('border-red-500', 'ring-red-500');
                const errorHtml = `<p id="rename-error-message" class="text-red-600 text-sm mt-1">請輸入組合名稱</p>`;
                inputElement.parentNode.insertAdjacentHTML('beforeend', errorHtml);
                inputElement.focus();
                return;
            }
            
            // 檢查名稱是否重複
            if (favoritePackagingCombos.some(c => c.id !== combo.id && c.name === newName)) {
                inputElement.classList.add('border-red-500', 'ring-red-500');
                const errorHtml = `<p id="rename-error-message" class="text-red-600 text-sm mt-1">此名稱已存在，請使用其他名稱</p>`;
                inputElement.parentNode.insertAdjacentHTML('beforeend', errorHtml);
                inputElement.focus();
                inputElement.select();
                return;
            }
            
            combo.name = newName;
            closeModal();
            // 如果目前就在資料維護頁面，直接更新常用包材組合分頁
            if (currentView === 'maintenance') {
                renderMaintenanceAndStayOnTab('favorite-combo-pane');
            } else {
                // 切換到資料維護頁面的常用包材組合分頁
                currentView = 'maintenance';
                renderApp();
                setTimeout(() => {
                    const targetTab = document.querySelector('[data-pane="favorite-combo-pane"]');
                    if (targetTab) {
                        targetTab.click();
                    }
                }, 100);
            }
        });
    }
    
    // 刪除組合的模態框
    function openEditPackagingModal(combo) {
        // 設定當前選擇狀態為該組合的包材
        selectedBoxSku = combo.boxSku;
        selectedAdditional.clear();
        combo.additionalSkus.forEach(sku => selectedAdditional.add(sku));
        
        let activeTabKey = 'box';

        function renderPicker() {
            const tabHasSelection = (key) => {
                if (key === 'box') {
                    return !!selectedBoxSku;
                }
                const skusForCategory = products
                    .filter(p => p.category === 'packaging' && p.details?.type === key)
                    .map(p => p.sku);
                return skusForCategory.some(sku => selectedAdditional.has(sku));
            };

            const tabsHtml = packagingCategories.map(cat => {
                const hasSelection = tabHasSelection(cat.key);
                const isActive = cat.key === activeTabKey;
                const baseClass = 'px-4 py-3 text-sm text-left w-full transition-colors duration-150';
                const activeClasses = isActive ? 'bg-white font-semibold text-blue-700' : 'hover:bg-gray-200';
                const selectionClasses = hasSelection ? 'border-l-4 border-blue-500 font-semibold' : 'border-l-4 border-transparent';
                const combinedClasses = `${baseClass} ${activeClasses} ${selectionClasses}`;
                
                return `<button type="button" data-key="${cat.key}" class="pkg-tab-btn ${combinedClasses}">${cat.name}</button>`;
            }).join('');

            const itemsForActiveTab = products.filter(p => p.category === 'packaging' && p.details?.type === activeTabKey);
            const buttonsHtml = itemsForActiveTab.map(p => {
                const isSelected = activeTabKey === 'box' ? p.sku === selectedBoxSku : selectedAdditional.has(p.sku);
                const selectedClasses = isSelected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-50';
                return `<button type="button" data-sku="${p.sku}" data-type="${activeTabKey}" class="pkg-item-btn ${selectedClasses} px-3 py-2 rounded-md border text-sm font-medium transition-colors">${p.name}</button>`;
            }).join(' ');

            const renderPickerSummary = () => {
                const boxHtml = selectedBoxSku ? `<span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 mr-1 mb-1">盒子: ${findProduct(selectedBoxSku)?.name}</span>` : '';
                const othersHtml = Array.from(selectedAdditional).map(sku => {
                    const product = findProduct(sku);
                    return product ? `<span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 mr-1 mb-1">${product.name}</span>` : '';
                }).join('');
                return boxHtml + othersHtml;
            };

            const modalHtml = `
                <div class="p-0 flex flex-col max-h-[80vh]" style="height: 80vh;">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">編輯包材選項 - ${combo.name}</h3>
                    </div>
                    <div class="flex-grow flex overflow-hidden">
                        <div class="w-1/3 border-r bg-gray-100 overflow-y-auto">
                            <nav class="flex flex-col pt-2">${tabsHtml}</nav>
                        </div>
                        <div class="w-2/3 overflow-y-auto p-4">
                            <div class="space-y-2">${buttonsHtml || '<p class="text-sm text-gray-500">此類別尚無品項</p>'}</div>
                        </div>
                    </div>
                    <div class="p-4 border-t bg-white">
                        <h4 class="text-sm font-semibold text-gray-800 mb-2">已選項目：</h4>
                        <div id="picker-summary" class="flex flex-wrap items-center min-h-[2.5rem]">
                            ${renderPickerSummary()}
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                        <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                        <button type="button" id="save-combo-changes" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">儲存變更</button>
                    </div>
                </div>`;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.className = `bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform translateY(0)`;
            modalContent.innerHTML = modalHtml;
            attachEditPickerListeners();
        }

        function attachEditPickerListeners() {
            const modalContent = document.getElementById('modal-content');
            
            modalContent.querySelector('.cancel-btn').addEventListener('click', () => {
                closeModal();
                // 如果目前就在資料維護頁面，直接更新常用包材組合分頁
                if (currentView === 'maintenance') {
                    renderMaintenanceAndStayOnTab('favorite-combo-pane');
                } else {
                    // 切換到資料維護頁面的常用包材組合分頁
                    currentView = 'maintenance';
                    renderApp();
                    setTimeout(() => {
                        const targetTab = document.querySelector('[data-pane="favorite-combo-pane"]');
                        if (targetTab) {
                            targetTab.click();
                        }
                    }, 100);
                }
            });
            
            modalContent.querySelector('#save-combo-changes').addEventListener('click', () => {
                // 更新組合的包材選項
                combo.boxSku = selectedBoxSku;
                combo.additionalSkus = Array.from(selectedAdditional);
                
                closeModal();
                // 如果目前就在資料維護頁面，直接更新常用包材組合分頁
                if (currentView === 'maintenance') {
                    renderMaintenanceAndStayOnTab('favorite-combo-pane');
                } else {
                    // 切換到資料維護頁面的常用包材組合分頁
                    currentView = 'maintenance';
                    renderApp();
                    setTimeout(() => {
                        const targetTab = document.querySelector('[data-pane="favorite-combo-pane"]');
                        if (targetTab) {
                            targetTab.click();
                        }
                    }, 100);
                }
            });

            modalContent.querySelectorAll('.pkg-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeTabKey = btn.dataset.key;
                    renderPicker();
                });
            });

            modalContent.querySelectorAll('.pkg-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sku = btn.dataset.sku;
                    const type = btn.dataset.type;
                    if (type === 'box') {
                        selectedBoxSku = (selectedBoxSku === sku) ? '' : sku;
                    } else {
                        if (selectedAdditional.has(sku)) {
                            selectedAdditional.delete(sku);
                        } else {
                            selectedAdditional.add(sku);
                        }
                    }
                    renderPicker();
                });
            });
        }
        
        // 確保模態框已開啟
        const modalContent = document.getElementById('modal-content');
        if (!modalContent.innerHTML.trim()) {
            openModal('', 'max-w-3xl');
        }
        renderPicker();
    }

    function openDeleteComboModal(combo) {
        const modalHtml = `
            <div class="p-6 space-y-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-semibold text-gray-900">確認刪除</h3>
                        <p class="text-sm text-gray-500 mt-1">確定要刪除常用組合「<span class="font-medium">${combo.name}</span>」嗎？</p>
                        <p class="text-xs text-gray-400 mt-1">此操作無法復原</p>
                    </div>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">取消</button>
                    <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition-colors">確認刪除</button>
                </div>
            </div>`;
        
        openModal(modalHtml);
        
        document.querySelector('.cancel-btn').addEventListener('click', () => {
            closeModal();
            // 如果目前就在資料維護頁面，直接更新常用包材組合分頁
            if (currentView === 'maintenance') {
                renderMaintenanceAndStayOnTab('favorite-combo-pane');
            } else {
                // 切換到資料維護頁面的常用包材組合分頁
                currentView = 'maintenance';
                renderApp();
                setTimeout(() => {
                    const targetTab = document.querySelector('[data-pane="favorite-combo-pane"]');
                    if (targetTab) {
                        targetTab.click();
                    }
                }, 100);
            }
        });
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            const index = favoritePackagingCombos.findIndex(c => c.id === combo.id);
            if (index !== -1) {
                favoritePackagingCombos.splice(index, 1);
                closeModal();
                // 如果目前就在資料維護頁面，直接更新常用包材組合分頁
                if (currentView === 'maintenance') {
                    renderMaintenanceAndStayOnTab('favorite-combo-pane');
                } else {
                    // 切換到資料維護頁面的常用包材組合分頁
                    currentView = 'maintenance';
                    renderApp();
                    setTimeout(() => {
                        const targetTab = document.querySelector('[data-pane="favorite-combo-pane"]');
                        if (targetTab) {
                            targetTab.click();
                        }
                    }, 100);
                }
            }
        });
    }

    // 狐狸頭匯入模態框
    function openFoxImportModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.id = 'fox-import-modal';
        
        // 點擊背景關閉模態框
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-8xl shadow-lg rounded-md bg-white" style="max-height: 90vh; overflow-y: auto; max-width: 95vw;">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">狐狸頭匯入</h3>
                        <button id="fox-modal-close-btn" class="close-modal text-gray-400 hover:text-gray-600">
                            <span class="sr-only">關閉</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="fox-import-content">
                        <!-- 檔案上傳區域 -->
                        <div id="file-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <div class="mx-auto h-12 w-12 text-gray-400">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <div class="mt-4">
                                <label for="excel-file-input" class="cursor-pointer">
                                    <span class="mt-2 block text-sm font-medium text-gray-900">
                                        點擊上傳或拖拽檔案到此處
                                    </span>
                                    <span class="mt-1 block text-xs text-gray-500">
                                        支援 .xlsx/.csv 格式，標題列應在第3列
                                    </span>
                                </label>
                                <input id="excel-file-input" type="file" accept=".xlsx,.xls,.csv" class="hidden">
                            </div>
                        </div>
                        
                        <!-- 錯誤訊息和進度指示器 -->
                        <div id="import-status-area" class="mt-4 hidden">
                            <!-- 進度指示器 -->
                            <div id="import-progress" class="hidden">
                                <div class="flex items-center justify-center py-4">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    <span class="ml-3 text-gray-600">正在解析檔案...</span>
                                </div>
                            </div>
                            
                            <!-- 錯誤訊息 -->
                            <div id="import-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-red-800">檔案解析錯誤</h3>
                                        <div id="error-message" class="mt-2 text-sm text-red-700"></div>
                                        <div id="error-details" class="mt-2 text-xs text-red-600 hidden"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 成功訊息 -->
                            <div id="import-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-green-800">檔案解析成功</h3>
                                        <div id="success-message" class="mt-2 text-sm text-green-700"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 預覽表格區域 -->
                        <div id="preview-area" class="mt-6 hidden">
                            <h4 class="text-md font-medium text-gray-900 mb-3">資料預覽與編輯</h4>
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="inline-block w-4 h-4 bg-gray-500 mr-2"></span>主要欄位（匯入用）
                                <span class="inline-block w-4 h-4 bg-blue-600 ml-4 mr-2"></span>必填欄位
                                <span class="inline-block w-4 h-4 bg-gray-400 ml-4 mr-2"></span>參考欄位（僅供查看）
                            </div>
                            <div class="overflow-auto border border-gray-200 rounded-lg relative" style="max-height: 60vh;">
                                <table id="preview-table" class="min-w-full divide-y divide-gray-200 table-auto">
                                    <!-- 動態生成表格內容 -->
                                </table>
                            </div>
                            
                            <div class="mt-6 flex justify-end gap-3">
                                <button id="cancel-import" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                                    取消
                                </button>
                                <button id="confirm-import" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    確認匯入
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        initFoxImportHandlers();
    }

    // 初始化狐狸頭匯入處理器
    function initFoxImportHandlers() {
        const fileInput = document.getElementById('excel-file-input');
        const uploadArea = document.getElementById('file-upload-area');
        const previewArea = document.getElementById('preview-area');
        
        // X關閉按鈕事件監聽器
        const closeBtn = document.getElementById('fox-modal-close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('fox-import-modal');
                if (modal) {
                    modal.remove();
                }
            });
        }
        
        // 增強檔案上傳體驗
        enhanceFileUploadUX();
        
        // 檔案選擇處理
        fileInput.addEventListener('change', handleFileSelect);
        
        // 拖拽上傳處理
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect({ target: { files } });
            }
        });
        
        // 取消按鈕
        document.getElementById('cancel-import').addEventListener('click', () => {
            document.getElementById('fox-import-modal').remove();
        });
        
        // 確認匯入按鈕
        document.getElementById('confirm-import').addEventListener('click', handleConfirmImport);
    }

    // 狀態管理函數
    function showImportProgress() {
        const statusArea = document.getElementById('import-status-area');
        const progress = document.getElementById('import-progress');
        const error = document.getElementById('import-error');
        const success = document.getElementById('import-success');
        const previewArea = document.getElementById('preview-area');
        
        statusArea.classList.remove('hidden');
        progress.classList.remove('hidden');
        error.classList.add('hidden');
        success.classList.add('hidden');
        previewArea.classList.add('hidden');
    }
    function showImportError(message, details = null) {
        const statusArea = document.getElementById('import-status-area');
        const progress = document.getElementById('import-progress');
        const error = document.getElementById('import-error');
        const success = document.getElementById('import-success');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const previewArea = document.getElementById('preview-area');

        console.log('🔴 showImportError triggered. Forcing preview area to be visible.');

        // 強制預覽區塊可見，防止UI狀態錯誤
        if (previewArea) {
            previewArea.classList.remove('hidden');
        }
        
        statusArea.classList.remove('hidden');
        progress.classList.add('hidden');
        error.classList.remove('hidden');
        success.classList.add('hidden');
        
        errorMessage.textContent = message;

        if (details) {
            errorDetails.textContent = details;
            errorDetails.classList.remove('hidden');
        } else {
            errorDetails.classList.add('hidden');
        }
    }

    function showImportSuccess(message) {
        const statusArea = document.getElementById('import-status-area');
        const progress = document.getElementById('import-progress');
        const error = document.getElementById('import-error');
        const success = document.getElementById('import-success');
        const successMessage = document.getElementById('success-message');
        
        statusArea.classList.remove('hidden');
        progress.classList.add('hidden');
        error.classList.add('hidden');
        success.classList.remove('hidden');
        
        successMessage.textContent = message;
        
        // 3秒後自動隱藏成功訊息
        setTimeout(() => {
            success.classList.add('hidden');
            if (!document.getElementById('preview-area').classList.contains('hidden')) {
                statusArea.classList.add('hidden');
            }
        }, 3000);
    }

    function hideImportStatus() {
        const statusArea = document.getElementById('import-status-area');
        const progress = document.getElementById('import-progress');
        const error = document.getElementById('import-error');
        const success = document.getElementById('import-success');
        
        statusArea.classList.add('hidden');
        progress.classList.add('hidden');
        error.classList.add('hidden');
        success.classList.add('hidden');
    }

    // 檔案結構驗證函數
    function validateFileStructure(headers, data) {
        const errors = [];
        const warnings = [];
        
        // 檢查核心欄位（品種和品牌可以為空，會自動填入預設值）
        const coreFields = ['日期', '水果種類', 'SIZE', '數量', '單價'];
        const optionalFields = ['品種', '品牌'];
        const missingFields = coreFields.filter(field => !headers.includes(field));
        
        if (missingFields.length > 0) {
            errors.push(`缺少必要欄位：${missingFields.join(', ')}`);
        }
        
        // 檢查資料格式
        let validRowCount = 0;
        let invalidRowCount = 0;
        
        data.forEach((row, index) => {
            const rowNumber = index + 4; // 從第4列開始
            const rowErrors = [];
            
            // 檢查核心欄位是否有值
            coreFields.forEach(field => {
                if (!row[field] || row[field].toString().trim() === '') {
                    rowErrors.push(`${field}為空`);
                }
            });
            
            // 檢查數量和單價是否為有效數字
            if (row['數量'] && isNaN(parseFloat(row['數量']))) {
                rowErrors.push('數量格式不正確');
            }
            if (row['單價'] && isNaN(parseFloat(row['單價']))) {
                rowErrors.push('單價格式不正確');
            }
            
            if (rowErrors.length > 0) {
                invalidRowCount++;
                if (invalidRowCount <= 5) { // 只顯示前5個錯誤
                    warnings.push(`第${rowNumber}列：${rowErrors.join(', ')}`);
                }
            } else {
                validRowCount++;
            }
        });
        
        if (invalidRowCount > 5) {
            warnings.push(`...還有 ${invalidRowCount - 5} 列資料有問題`);
        }
        
        return {
            isValid: errors.length === 0,
            errors,
            warnings,
            validRowCount,
            invalidRowCount,
            totalRowCount: data.length
        };
    }

    // 處理檔案選擇
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // 支援 Excel 和 CSV 檔案
        if (!file.name.match(/\.(xlsx|xls|csv)$/)) {
            showImportError('不支援的檔案格式', '請選擇 Excel 檔案 (.xlsx, .xls) 或 CSV 檔案 (.csv)');
            return;
        }
        
        // 顯示進度指示器
        showImportProgress();
        
        const reader = new FileReader();
        
        if (file.name.endsWith('.csv')) {
            // 處理 CSV 檔案
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    parseCSVData(csvText);
                } catch (error) {
                    showImportError('CSV 檔案解析失敗', error.message);
                    console.error('CSV parsing error:', error);
                }
            };
            reader.readAsText(file, 'UTF-8');
            console.log('開始讀取CSV檔案:', file.name, '大小:', file.size, 'bytes');
        } else {
            // 處理 Excel 檔案
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    parseExcelData(data);
                } catch (error) {
                    showImportError('Excel 檔案解析失敗', error.message);
                    console.error('Excel parsing error:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }

    // 解析Excel資料
    function parseExcelData(data) {
        // 防止重複解析
        if (window.isParsingExcel) {
            console.log('Excel解析進行中，跳過重複調用');
            return;
        }
        window.isParsingExcel = true;
        
        try {
            console.log('開始解析Excel檔案，資料大小:', data.length, 'bytes');
            
            // 使用 SheetJS 解析 Excel 檔案
            const workbook = XLSX.read(data, { type: 'array' });
            console.log('Excel工作簿解析成功，工作表數量:', workbook.SheetNames.length);
            console.log('工作表名稱:', workbook.SheetNames);
            
            // 取得第一個工作表
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            console.log('使用工作表:', sheetName);
            
            // 將工作表轉換為二維陣列
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1,  // 使用陣列格式而非物件格式
                defval: ''  // 空白儲存格使用空字串
            });
            console.log('Excel轉換為陣列，總行數:', jsonData.length);
            console.log('前5行資料:', jsonData.slice(0, 5));
            
            if (jsonData.length < 4) {
                throw new Error('Excel 檔案資料不足，至少需要 4 列資料（包含標題列）');
            }
            
            // 第3列是標題列（索引2）
            const headers = jsonData[2];
            console.log('Excel標題列（第3列）:', headers);
            console.log('標題列長度:', headers ? headers.length : 0);
            
            if (!headers || headers.length === 0) {
                throw new Error('找不到標題列（第3列）');
            }
            
            // 驗證必要的欄位
            const requiredFields = ['日期', '水果種類', 'SIZE', '品種', '品牌', '數量', '單價'];
            const missingFields = requiredFields.filter(field => !headers.includes(field));
            
            // 所有要解析的欄位（包含必要欄位和參考欄位）
            const allParseFields = ['日期', '水果種類', '對外品名', 'SIZE', '異動別', '交易碼', '客戶/廠商', 'ETA', '櫃號', '單據號碼', '數量', '單價', '冰庫', '品種', '品牌', '公司別'];
            
            if (missingFields.length > 0) {
                throw new Error(`缺少必要欄位：${missingFields.join(', ')}`);
            }
            
            // 解析資料列（從第4列開始，索引3）
            const dataRows = jsonData.slice(3); // 從第4列開始
            const parsedData = [];
            console.log('Excel資料列數量:', dataRows.length);
            console.log('前3個資料列:', dataRows.slice(0, 3));
            
            dataRows.forEach((row, index) => {
                console.log(`Excel處理第${index + 4}列:`, row);
                // 跳過總計列或空白列
                if (!row || row.length === 0 || (row[0] && row[0].toString().includes('數量總計'))) {
                    return;
                }
                
                // 檢查是否有有效資料
                const hasValidData = row.some(cell => cell !== null && cell !== undefined && cell !== '');
                if (!hasValidData) {
                    return;
                }
                
                try {
                    // 建立資料物件
                    const rowData = {};
                    headers.forEach((header, headerIndex) => {
                        if (header && allParseFields.includes(header)) {
                            let value = row[headerIndex];
                            
                            // 處理數字格式（移除千分位逗號）
                            if (header === '數量' || header === '單價') {
                                if (typeof value === 'string') {
                                    value = value.replace(/,/g, '');
                                }
                                value = parseFloat(value) || 0;
                            }
                            
                            // 處理日期格式
                            if (header === '日期' && typeof value === 'number') {
                                // Excel 日期序號轉換
                                const date = XLSX.SSF.parse_date_code(value);
                                if (date) {
                                    value = `${date.y}.${String(date.m).padStart(2, '0')}.${String(date.d).padStart(2, '0')}`;
                                }
                            }
                            
                            rowData[header] = value || '';
                        }
                    });
                    
                    // 建立資料物件的調試信息
                    console.log(`Excel第${index + 4}列資料物件:`, {
                        '日期': rowData['日期'],
                        '水果種類': rowData['水果種類'], 
                        '對外品名': rowData['對外品名'],
                        'SIZE': rowData['SIZE'],
                        '異動別': rowData['異動別'],
                        '交易碼': rowData['交易碼'],
                        '客戶/廠商': rowData['客戶/廠商'],
                        'ETA': rowData['ETA'],
                        '櫃號': rowData['櫃號'],
                        '單據號碼': rowData['單據號碼'],
                        '數量': rowData['數量'],
                        '單價': rowData['單價'],
                        '冰庫': rowData['冰庫'],
                        '品種': rowData['品種'],
                        '品牌': rowData['品牌'],
                        '公司別': rowData['公司別']
                    });

                    // 確保核心欄位都有值（品牌可以為空）
                    const coreFields = ['日期', '水果種類', 'SIZE', '數量', '單價'];
                    const isValidRow = coreFields.every(field => {
                        const value = rowData[field];
                        const isValid = value !== undefined && value !== null && value.toString().trim() !== '';
                        if (!isValid) {
                            console.log(`Excel第${index + 4}列 - 欄位 "${field}" 無效:`, `"${value}"`);
                        }
                        return isValid;
                    });
                    
                    if (isValidRow) {
                        // 確保品種和品牌至少有一個不為空，如果都為空則填入預設值
                        if (!rowData['品種'] || rowData['品種'].toString().trim() === '') {
                            rowData['品種'] = '未分類';
                        }
                        if (!rowData['品牌'] || rowData['品牌'].toString().trim() === '') {
                            rowData['品牌'] = '未指定';
                        }
                        
                        parsedData.push(rowData);
                        console.log(`Excel成功解析第${index + 4}列：${rowData['水果種類']} - ${rowData['品種']}`);
                    } else {
                        console.warn(`Excel第${index + 4}列資料不完整，跳過此列。缺少欄位:`, 
                            coreFields.filter(field => {
                                const value = rowData[field];
                                return !value || value.toString().trim() === '';
                            }));
                    }
                    
                } catch (error) {
                    console.error(`解析第${index + 4}列時發生錯誤:`, error);
                }
            });
            
            if (parsedData.length === 0) {
                throw new Error('沒有找到有效的資料列');
            }
            
            // 執行詳細驗證
            const validation = validateFileStructure(headers, parsedData);
            
            if (!validation.isValid) {
                showImportError('檔案結構驗證失敗', validation.errors.join('\n'));
                return;
            }
            
            // 顯示成功訊息和警告（如果有）
            let successMsg = `成功解析 ${validation.validRowCount} 筆 Excel 資料`;
            if (validation.invalidRowCount > 0) {
                successMsg += `，跳過 ${validation.invalidRowCount} 筆無效資料`;
            }
            
            showImportSuccess(successMsg);
            console.log(`Excel 解析完成：${successMsg}`);
            console.log('準備顯示的資料:', parsedData);
            console.log('資料筆數:', parsedData.length);
            
            if (validation.warnings.length > 0) {
                console.warn('Excel 解析警告：', validation.warnings);
            }
            
            displayPreviewTable(parsedData);
            
        } catch (error) {
            showImportError('Excel檔案解析失敗', error.message);
            console.error('Excel parsing error:', error);
        } finally {
            // 解析完成，重置標誌
            window.isParsingExcel = false;
        }
    }
    // 解析CSV資料
    function parseCSVData(csvText) {
        try {
            // 將CSV文字分割成行
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            console.log('CSV總行數:', lines.length);
            console.log('前15行內容:', lines.slice(0, 15));
            
            if (lines.length < 4) {
                throw new Error('CSV檔案資料不足，至少需要4行（包含標題列）');
            }
            
            // 第3列是標題列（索引2）
            const headerLine = lines[2];
            const headers = parseCSVLine(headerLine);
            console.log('標題列:', headers);
            console.log('標題列數量:', headers.length);
            
            // 驗證必要的欄位
            const requiredFields = ['日期', '水果種類', 'SIZE', '品種', '品牌', '數量', '單價'];
            const missingFields = requiredFields.filter(field => !headers.includes(field));
            
            // 所有要解析的欄位（包含必要欄位和參考欄位）
            const allParseFields = ['日期', '水果種類', '對外品名', 'SIZE', '異動別', '交易碼', '客戶/廠商', 'ETA', '櫃號', '單據號碼', '數量', '單價', '冰庫', '品種', '品牌', '公司別'];
            
            if (missingFields.length > 0) {
                throw new Error(`缺少必要欄位：${missingFields.join(', ')}`);
            }
            
            // 解析資料列（從第4列開始，索引3）
            const dataLines = lines.slice(3); // 從第4列開始
            const parsedData = [];
            
            dataLines.forEach((line, index) => {
                // 跳過總計列或空白列
                if (line.includes('數量總計') || line.trim() === '') {
                    console.log(`跳過第${index + 4}列：總計或空白列`);
                    return;
                }
                
                console.log(`處理第${index + 4}列：${line.substring(0, 50)}...`);
                
                try {
                    const values = parseCSVLine(line);
                    console.log(`第${index + 4}列解析結果:`, values.length, '個欄位');
                    
                    // 確保有足夠的欄位
                    if (values.length < headers.length) {
                        console.warn(`第${index + 4}列資料欄位不完整，跳過此列`);
                        return;
                    }
                    
                    // 建立資料物件
                    const rowData = {};
                    headers.forEach((header, i) => {
                        if (allParseFields.includes(header)) {
                        rowData[header] = values[i] || '';
                        }
                    });
                    
                    console.log(`第${index + 4}列資料物件:`, {
                        '日期': rowData['日期'],
                        '水果種類': rowData['水果種類'], 
                        '對外品名': rowData['對外品名'],
                        'SIZE': rowData['SIZE'],
                        '異動別': rowData['異動別'],
                        '交易碼': rowData['交易碼'],
                        '客戶/廠商': rowData['客戶/廠商'],
                        'ETA': rowData['ETA'],
                        '櫃號': rowData['櫃號'],
                        '單據號碼': rowData['單據號碼'],
                        '數量': rowData['數量'],
                        '單價': rowData['單價'],
                        '冰庫': rowData['冰庫'],
                        '品種': rowData['品種'],
                        '品牌': rowData['品牌'],
                        '公司別': rowData['公司別']
                    });
                    
                    // 檢查核心欄位是否有效
                    const coreFields = ['日期', '水果種類', 'SIZE', '數量', '單價'];
                    const isValidRow = coreFields.every(field => {
                        const value = rowData[field];
                        const isValid = value && value.toString().trim() !== '';
                        if (!isValid) {
                            console.log(`第${index + 4}列 - 欄位 "${field}" 無效:`, `"${value}"`);
                        }
                        return isValid;
                    });
                    
                    if (isValidRow) {
                        // 處理可能為空的欄位
                        if (!rowData['品種'] || rowData['品種'].toString().trim() === '') {
                            rowData['品種'] = '未分類';
                        }
                        if (!rowData['品牌'] || rowData['品牌'].toString().trim() === '') {
                            rowData['品牌'] = '未指定';
                        }
                        
                        parsedData.push(rowData);
                        console.log(`CSV解析第${index + 4}列：${rowData['水果種類']} - ${rowData['品種']}`);
                    } else {
                        console.warn(`第${index + 4}列資料不完整，跳過此列。缺少欄位:`, 
                            coreFields.filter(field => !rowData[field] || rowData[field].toString().trim() === ''));
                    }
                    
                } catch (error) {
                    console.warn(`第${index + 4}列解析失敗：${error.message}`);
                }
            });
            
            if (parsedData.length === 0) {
                throw new Error('沒有找到有效的資料列');
            }
            
            // 執行詳細驗證
            const validation = validateFileStructure(headers, parsedData);
            
            if (!validation.isValid) {
                showImportError('檔案結構驗證失敗', validation.errors.join('\n'));
                return;
            }
            
            // 顯示成功訊息和警告（如果有）
            let successMsg = `成功解析 ${validation.validRowCount} 筆 CSV 資料`;
            if (validation.invalidRowCount > 0) {
                successMsg += `，跳過 ${validation.invalidRowCount} 筆無效資料`;
            }
            
            showImportSuccess(successMsg);
            console.log(`CSV 解析完成：${successMsg}`);
            
            if (validation.warnings.length > 0) {
                console.warn('CSV 解析警告：', validation.warnings);
            }
            
            displayPreviewTable(parsedData);
            
        } catch (error) {
            showImportError('CSV檔案解析失敗', error.message);
            console.error('CSV parsing error:', error);
        }
    }
    // 解析CSV行（處理引號和逗號）
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }



    // 從水果品名中解析國家和區域信息
    function parseCountryAndRegionFromName(fruitName) {
        if (!fruitName) return { country: '', region: '' };
        
        // 常見國家關鍵詞映射
        const countryKeywords = {
            '紐西蘭': '紐西蘭',
            'NZ': '紐西蘭',
            '智利': '智利',
            'CL': '智利',
            '美國': '美國',
            'US': '美國',
            '加拿大': '加拿大',
            'CA': '加拿大',
            '日本': '日本',
            'JP': '日本',
            '韓國': '韓國',
            'KR': '韓國',
            '泰國': '泰國',
            'TH': '泰國',
            '台灣': '台灣',
            'TW': '台灣',
            '中國': '中國',
            'CN': '中國',
            '澳洲': '澳洲',
            'AU': '澳洲',
            '南非': '南非',
            'ZA': '南非',
            '義大利': '義大利',
            'IT': '義大利',
            '法國': '法國',
            'FR': '法國',
            '西班牙': '西班牙',
            'ES': '西班牙',
            '土耳其': '土耳其',
            'TR': '土耳其'
        };
        
        // 國家對應的地理區域映射
        const countryRegions = {
            '美國': {
                '華盛頓': '華盛頓州',
                '加州': '加州',
                '佛羅里達': '佛羅里達州',
                '俄勒岡': '俄勒岡州',
                '密西根': '密西根州',
                '紐約': '紐約州',
                'Washington': '華盛頓州',
                'California': '加州',
                'Florida': '佛羅里達州',
                'Oregon': '俄勒岡州',
                'Michigan': '密西根州',
                'New York': '紐約州'
            },
            '紐西蘭': {
                '奧克蘭': '奧克蘭',
                '霍克斯灣': '霍克斯灣',
                '坎特伯雷': '坎特伯雷',
                '奧塔哥': '奧塔哥',
                '基督城': '基督城',
                '威靈頓': '威靈頓',
                'Auckland': '奧克蘭',
                'Hawke\'s Bay': '霍克斯灣',
                'Canterbury': '坎特伯雷',
                'Otago': '奧塔哥',
                'Christchurch': '基督城',
                'Wellington': '威靈頓'
            },
            '智利': {
                '聖地牙哥': '聖地牙哥',
                '瓦爾帕萊索': '瓦爾帕萊索',
                '比奧比奧': '比奧比奧',
                '阿勞卡尼亞': '阿勞卡尼亞',
                '奧希金斯': '奧希金斯',
                'Santiago': '聖地牙哥',
                'Valparaiso': '瓦爾帕萊索',
                'Bio Bio': '比奧比奧',
                'Araucania': '阿勞卡尼亞',
                'O\'Higgins': '奧希金斯'
            },
            '加拿大': {
                '卑詩省': '卑詩省',
                '安大略省': '安大略省',
                '魁北克省': '魁北克省',
                '亞伯達省': '亞伯達省',
                'British Columbia': '卑詩省',
                'Ontario': '安大略省',
                'Quebec': '魁北克省',
                'Alberta': '亞伯達省'
            },
            '日本': {
                '青森': '青森縣',
                '長野': '長野縣',
                '山形': '山形縣',
                '岡山': '岡山縣',
                '福島': '福島縣',
                '山梨': '山梨縣',
                'Aomori': '青森縣',
                'Nagano': '長野縣',
                'Yamagata': '山形縣',
                'Okayama': '岡山縣',
                'Fukushima': '福島縣',
                'Yamanashi': '山梨縣'
            },
            '韓國': {
                '慶尚北道': '慶尚北道',
                '全羅南道': '全羅南道',
                '忠清北道': '忠清北道',
                '江原道': '江原道'
            },
            '澳洲': {
                '維多利亞': '維多利亞州',
                '新南威爾士': '新南威爾士州',
                '昆士蘭': '昆士蘭州',
                '南澳': '南澳州',
                'Victoria': '維多利亞州',
                'New South Wales': '新南威爾士州',
                'Queensland': '昆士蘭州',
                'South Australia': '南澳州'
            },
            '南非': {
                '西開普': '西開普省',
                '東開普': '東開普省',
                '夸祖魯-納塔爾': '夸祖魯-納塔爾省',
                'Western Cape': '西開普省',
                'Eastern Cape': '東開普省',
                'KwaZulu-Natal': '夸祖魯-納塔爾省'
            }
        };
        
        let detectedCountry = '';
        let detectedRegion = '';
        
        // 檢測國家（優先檢測較長的關鍵詞）
        const sortedCountryKeys = Object.keys(countryKeywords).sort((a, b) => b.length - a.length);
        for (const keyword of sortedCountryKeys) {
            if (fruitName.includes(keyword)) {
                detectedCountry = countryKeywords[keyword];
                break;
            }
        }
        
        // 檢測區域（只在偵測到國家後，檢測該國家對應的區域）
        if (detectedCountry && countryRegions[detectedCountry]) {
            const regionMap = countryRegions[detectedCountry];
            const sortedRegionKeys = Object.keys(regionMap).sort((a, b) => b.length - a.length);
            
            for (const keyword of sortedRegionKeys) {
                if (fruitName.includes(keyword)) {
                    detectedRegion = regionMap[keyword];
                    break;
                }
            }
        }
        
        // 移除自動國家代碼判斷 - 只根據水果名稱本身進行判斷
        // 避免根據代碼自動推斷國家，應該根據實際的水果名稱內容
        /*
        // 特殊處理：根據水果種類代碼進一步判斷國家
        if (!detectedCountry) {
            if (fruitName.includes('APP-CL') || fruitName.includes('CHY-CL')) {
                detectedCountry = '智利';
            } else if (fruitName.includes('APP-NZ') || fruitName.includes('KIW-NZ')) {
                detectedCountry = '紐西蘭';
            } else if (fruitName.includes('CHY-CA')) {
                detectedCountry = '加拿大';
            } else if (fruitName.includes('APP-US')) {
                detectedCountry = '美國';
            }
        }
        */
            
        // 如果通過代碼偵測到國家，再檢測對應的區域
        if (detectedCountry && countryRegions[detectedCountry]) {
            const regionMap = countryRegions[detectedCountry];
            const sortedRegionKeys = Object.keys(regionMap).sort((a, b) => b.length - a.length);
            
            for (const keyword of sortedRegionKeys) {
                if (fruitName.includes(keyword)) {
                    detectedRegion = regionMap[keyword];
                    break;
                }
            }
        }
        
        return { country: detectedCountry, region: detectedRegion };
    }

    // 顯示預覽表格
    function displayPreviewTable(data) {
        const previewArea = document.getElementById('preview-area');
        const previewTable = document.getElementById('preview-table');
        
        console.log('displayPreviewTable 被調用，收到資料:', data);
        console.log('資料筆數:', data ? data.length : 0);
        
        // 隱藏進度指示器
        const progress = document.getElementById('import-progress');
        if (progress) {
            progress.classList.add('hidden');
        }
        
        if (!data || data.length === 0) {
            showImportError('沒有找到資料', '請檢查檔案是否包含有效的資料列');
            return;
        }
        
        // 生成表格標題 - 重新排列Excel欄位
        const excelColumns = ['日期', '狐狸頭@水果品名', '水果種類', 'SIZE', '品種', '品牌', '數量', '單價'];
        const referenceColumns = ['異動別', '交易碼', '客戶/廠商', 'ETA', '櫃號', '單據號碼', '冰庫', '公司別'];
        const additionalColumns = ['Category', '國家', '區域', '等級'];
        
        let headerHtml = '<thead class="bg-gray-50 sticky top-0 z-10"><tr>';
        
        // Excel主要欄位（用於匯入）
        excelColumns.forEach(col => {
            // 對於狐狸頭@水果品名欄位，使用較寬的設定
            if (col === '狐狸頭@水果品名') {
                headerHtml += `<th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50 sticky top-0" style="min-width: 200px; max-width: 300px;">${col}</th>`;
            } else {
                headerHtml += `<th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase bg-gray-50 sticky top-0" style="min-width: 80px;">${col}</th>`;
            }
        });
        
        // 需要填寫的額外欄位
        additionalColumns.forEach(col => {
            const required = (col !== '區域' && col !== '等級') ? ' <span class="text-red-500">*</span>' : '';
            headerHtml += `<th class="px-2 py-2 text-left text-xs font-medium text-blue-600 uppercase bg-blue-50 sticky top-0" style="min-width: 100px;">${col}${required}</th>`;
        });
        
        // 參考欄位（僅供對應查看）
        referenceColumns.forEach(col => {
            headerHtml += `<th class="px-2 py-2 text-left text-xs font-medium text-gray-400 uppercase bg-gray-100 sticky top-0" style="min-width: 80px;">${col}</th>`;
        });
        
        headerHtml += '</tr></thead>';
        
        // 生成表格內容
        let bodyHtml = '<tbody class="bg-white divide-y divide-gray-200">';
        
        console.log('開始生成表格，資料筆數:', data.length);
        
        data.forEach((row, index) => {
            console.log(`生成第${index + 1}列表格，資料:`, row);
            bodyHtml += '<tr>';
            
            // Excel主要資料（只讀）
            excelColumns.forEach(col => {
                // 對外品名欄位映射
                const dataKey = col === '狐狸頭@水果品名' ? '對外品名' : col;
                const value = row[dataKey] || '';
                // 對於狐狸頭@水果品名欄位，使用較寬的設定
                if (col === '狐狸頭@水果品名') {
                    bodyHtml += `<td class="px-2 py-2 text-sm text-gray-900" style="min-width: 200px; max-width: 300px; white-space: nowrap; overflow: visible;">${value}</td>`;
                } else {
                    bodyHtml += `<td class="px-2 py-2 text-sm text-gray-900" style="max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${value}</td>`;
                }
            });
            
            // 只從對外品名（狐狸頭@水果品名）進行關鍵字判斷，不使用水果種類
            const fruitName = row['對外品名'] || '';
            // 移除水果種類的判斷，只保留對外品名
            console.log(`第${index + 1}列對外品名:`, fruitName);
            
            // 需要填寫的欄位（可編輯）
            additionalColumns.forEach(col => {
                const required = (col !== '區域' && col !== '等級') ? 'required' : '';
                const placeholder = col === 'Category' ? '請選擇商品種類' : 
                                  col === '國家' ? '請輸入國家' : 
                                  col === '區域' ? '請輸入區域' : '請輸入等級';
                
                // 設定預設值 - 移除自動解析，改用關鍵字匹配
                let defaultValue = '';
                if (col === 'Category') {
                    defaultValue = '進口水果';
                } else if (col === '國家') {
                    defaultValue = ''; // 不自動預填，讓關鍵字匹配處理
                } else if (col === '區域') {
                    defaultValue = ''; // 不自動預填，讓關鍵字匹配處理
                } else if (col === '等級') {
                    defaultValue = ''; // 不自動預填，讓關鍵字匹配處理
                }
                
                bodyHtml += `<td class="px-2 py-2" style="min-width: 100px;">
                    <div class="relative">
                        <input type="text" 
                               class="additional-field w-full px-2 py-1 text-sm border border-gray-300 rounded focus:border-blue-500" 
                               data-row="${index}" 
                               data-field="${col}" 
                               placeholder="${placeholder}" 
                               value="${defaultValue}"
                               ${required}
                               id="${col.toLowerCase()}-${index}">
                        <div id="${col.toLowerCase()}-${index}-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden mt-1"></div>
                    </div>
                </td>`;
            });
            
            // 參考欄位（只讀，僅供對應查看）
            referenceColumns.forEach(col => {
                const value = row[col] || '';
                bodyHtml += `<td class="px-2 py-2 text-sm text-gray-500 bg-gray-50" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;" title="${value}">${value}</td>`;
            });
            
            bodyHtml += '</tr>';
        });
        
        bodyHtml += '</tbody>';
        
        console.log('表格HTML生成完成，準備設置innerHTML');
        console.log('headerHtml長度:', headerHtml.length);
        console.log('bodyHtml長度:', bodyHtml.length);
        
        previewTable.innerHTML = headerHtml + bodyHtml;
        previewArea.classList.remove('hidden');
        
        console.log('表格設置完成，檢查DOM中的行數:', previewTable.querySelectorAll('tbody tr').length);
        
        // 初始化智能輸入功能
        initPreviewTableSmartInputs();
        
        // 隱藏上傳區塊
        const uploadArea = document.getElementById('file-upload-area');
        const statusArea = document.getElementById('import-status-area');
        if (uploadArea) {
            uploadArea.style.display = 'none';
        }
        if (statusArea) {
            statusArea.style.display = 'none';
        }
    }
    // 檢查歷史狐狸頭匯入資料並自動帶入相同資訊
    function checkHistoryAndAutoFill(fruitName, unitPrice, rowIndex) {
        console.log(`檢查歷史狐狸頭匯入資料: "${fruitName}", 單價: ${unitPrice} (第${rowIndex + 1}列)`);
        
        let historyMatch = null;
        
        // 第一優先：尋找庫存管理中大件原料的相同水果品名和單價
        // 先檢查產品名稱是否與狐狸頭@水果品名相同
        historyMatch = products.find(p => 
            p.category === 'large_fruit' && 
            p.name === fruitName && 
            inventory.some(inv => 
                inv.sku === p.sku && 
                inv.unitCost && 
                inv.unitCost === unitPrice
            )
        );
        
        if (historyMatch) {
            console.log(`✅ 在庫存管理大件原料中找到完全匹配的水果品名和單價: ${historyMatch.name}`);
        }
        
        // 第二優先：如果沒有完全匹配，檢查是否有相同品名但單價在合理範圍內（±5%）
        if (!historyMatch && unitPrice > 0) {
            const priceRange = unitPrice * 0.05; // 5%的價格範圍
            historyMatch = products.find(p => 
                p.category === 'large_fruit' && 
                p.name === fruitName && 
                inventory.some(inv => 
                    inv.sku === p.sku && 
                    inv.unitCost && 
                    Math.abs(inv.unitCost - unitPrice) <= priceRange
                )
            );
            if (historyMatch) {
                const matchedInventory = inventory.find(inv => inv.sku === historyMatch.sku);
                console.log(`✅ 在庫存管理大件原料中找到價格範圍內的匹配 (±5%): ${matchedInventory.unitCost} vs ${unitPrice}`);
            }
        }
        
        // 第三優先：檢查foxImportData中的歷史資料（原有邏輯）
        if (!historyMatch) {
            historyMatch = products.find(p => 
                p.foxImportData && 
                p.foxImportData.originalName === fruitName && 
                p.foxImportData.unitPrice === unitPrice
            );
            if (historyMatch) {
                console.log(`✅ 在狐狸頭匯入歷史資料中找到完全匹配: ${historyMatch.foxImportData.originalName}`);
            }
        }
        
        // 第四優先：foxImportData中的單價範圍匹配（±5%）
        if (!historyMatch && unitPrice > 0) {
            const priceRange = unitPrice * 0.05; // 5%的價格範圍
            historyMatch = products.find(p => 
                p.foxImportData && 
                p.foxImportData.originalName === fruitName && 
                Math.abs(p.foxImportData.unitPrice - unitPrice) <= priceRange
            );
            if (historyMatch) {
                console.log(`✅ 在狐狸頭匯入歷史資料中找到價格範圍內的匹配 (±5%): ${historyMatch.foxImportData.unitPrice} vs ${unitPrice}`);
            }
        }
        
        // 第五優先：部分品名匹配（去除特殊符號和空格後比較）
        if (!historyMatch) {
            const cleanFruitName = fruitName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase();
            if (cleanFruitName.length > 3) { // 只對足夠長的品名進行部分匹配
                // 先在庫存管理中尋找部分匹配
                historyMatch = products.find(p => 
                    p.category === 'large_fruit' && 
                    p.name && 
                    p.name.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase().includes(cleanFruitName)
                );
                if (historyMatch) {
                    console.log(`✅ 在庫存管理大件原料中找到部分品名匹配: "${historyMatch.name}" 包含 "${fruitName}"`);
                } else {
                    // 再在foxImportData中尋找部分匹配
                    historyMatch = products.find(p => 
                        p.foxImportData && 
                        p.foxImportData.originalName && 
                        p.foxImportData.originalName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').toLowerCase().includes(cleanFruitName)
                    );
                    if (historyMatch) {
                        console.log(`✅ 在狐狸頭匯入歷史資料中找到部分品名匹配: "${historyMatch.foxImportData.originalName}" 包含 "${fruitName}"`);
                    }
                }
            }
        }
        
        if (historyMatch) {
            console.log(`✅ 找到相同的歷史資料:`, historyMatch);
            
            // 自動帶入相同的 Category、國家、區域、等級
            const categoryInput = document.getElementById(`Category-${rowIndex}`);
            const countryInput = document.getElementById(`國家-${rowIndex}`);
            const regionInput = document.getElementById(`區域-${rowIndex}`);
            const gradeInput = document.getElementById(`等級-${rowIndex}`);
            
            if (categoryInput && historyMatch.details && historyMatch.details.category) {
                categoryInput.value = historyMatch.details.category;
                console.log(`✅ 自動帶入Category: ${historyMatch.details.category}`);
            }
            
            if (countryInput && historyMatch.details && historyMatch.details.country) {
                countryInput.value = historyMatch.details.country;
                console.log(`✅ 自動帶入國家: ${historyMatch.details.country}`);
            }
            
            if (regionInput && historyMatch.details && historyMatch.details.region) {
                regionInput.value = historyMatch.details.region;
                console.log(`✅ 自動帶入區域: ${historyMatch.details.region}`);
            }
            
            if (gradeInput && historyMatch.details && historyMatch.details.grade) {
                gradeInput.value = historyMatch.details.grade;
                console.log(`✅ 自動帶入等級: ${historyMatch.details.grade}`);
            } else if (gradeInput && historyMatch.foxImportData && historyMatch.foxImportData.grade) {
                gradeInput.value = historyMatch.foxImportData.grade;
                console.log(`✅ 自動帶入等級(從foxImportData): ${historyMatch.foxImportData.grade}`);
            }
            
            // 顯示匹配來源的訊息
            const matchSource = historyMatch.foxImportData ? '狐狸頭匯入歷史資料' : '庫存管理大件原料';
            console.log(`🎯 資料來源: ${matchSource}`);
            
            return true; // 表示找到歷史資料並已自動帶入
        } else {
            console.log(`❌ 沒有找到相同的歷史資料，使用關鍵字自動帶入`);
            return false; // 表示沒有找到歷史資料，需要使用關鍵字匹配
        }
    }
    
    // 簡單的關鍵字自動帶入功能 - 只從狐狸頭@水果品名（對外品名）進行判斷
    function autoFillByKeywords(fruitName, rowIndex) {
        console.log(`檢查狐狸頭@水果品名關鍵字自動帶入: "${fruitName}" (第${rowIndex + 1}列)`);
        
        // 動態建立關鍵字對應表 - 從現有的資料維護資料中取得
        const keywordMappings = {
            // 國家關鍵字 - 從products中的所有國家資料動態建立
            countries: {},
            // 區域關鍵字 - 從products中的所有區域資料動態建立  
            regions: {}
        };
        
        // 從現有產品資料中建立國家關鍵字表
        products.filter(p => p.category === 'large_fruit' && p.details?.country)
                .forEach(p => {
                    const country = p.details.country.trim();
                    if (country) {
                        keywordMappings.countries[country] = country;
                    }
                });
        
        // 從現有產品資料中建立區域關鍵字表
        products.filter(p => p.category === 'large_fruit' && p.details?.region)
                .forEach(p => {
                    const region = p.details.region.trim();
                    if (region) {
                        keywordMappings.regions[region] = region;
                    }
                });
        
        console.log('🔄 動態建立的關鍵字表:', {
            國家數量: Object.keys(keywordMappings.countries).length,
            國家列表: Object.keys(keywordMappings.countries),
            區域數量: Object.keys(keywordMappings.regions).length,
            區域列表: Object.keys(keywordMappings.regions)
        });
        
        let hasMatch = false;
        
        // 檢查國家關鍵字
        for (const [keyword, country] of Object.entries(keywordMappings.countries)) {
            if (fruitName.includes(keyword)) {
                const countryInput = document.getElementById(`國家-${rowIndex}`);
                if (countryInput && !countryInput.value) {
                    countryInput.value = country;
                    console.log(`✅ 根據關鍵字"${keyword}"自動帶入國家: ${country}`);
                    hasMatch = true;
                }
                break; // 找到第一個匹配就停止
            }
        }
        
        // 檢查區域關鍵字
        for (const [keyword, region] of Object.entries(keywordMappings.regions)) {
            if (fruitName.includes(keyword)) {
                const regionInput = document.getElementById(`區域-${rowIndex}`);
                if (regionInput && !regionInput.value) {
                    regionInput.value = region;
                    console.log(`✅ 根據關鍵字"${keyword}"自動帶入區域: ${region}`);
                    hasMatch = true;
                }
                break; // 找到第一個匹配就停止
            }
        }
        
        // 移除等級關鍵字自動帶入功能
        // for (const [keyword, grade] of Object.entries(keywordMappings.grades)) {
        //     if (fruitName.includes(keyword)) {
        //         const gradeInput = document.getElementById(`等級-${rowIndex}`);
        //         if (gradeInput && !gradeInput.value) {
        //             gradeInput.value = grade;
        //             console.log(`✅ 根據關鍵字"${keyword}"自動帶入等級: ${grade}`);
        //             hasMatch = true;
        //         }
        //         break; // 找到第一個匹配就停止
        //     }
        // }
        
        // 自動帶入Category（所有進口水果都是進口水果）
        const categoryInput = document.getElementById(`Category-${rowIndex}`);
        if (categoryInput && !categoryInput.value) {
            categoryInput.value = '進口水果';
            console.log(`✅ 自動帶入Category: 進口水果`);
            hasMatch = true;
        }
        
        return hasMatch;
    }

    // 設置狐狸頭@水果品名的自動帶入監聽器
    function setupFruitNameAutoFill() {
        // 尋找預覽表格
        const previewTable = document.querySelector('#preview-table tbody');
        if (!previewTable) return;
        
        // 遍歷所有表格列
        const rows = previewTable.querySelectorAll('tr');
        rows.forEach((row, rowIndex) => {
            // 找到對外品名欄位 (狐狸頭@水果品名) - 根據表格結構是第2欄(索引1)
            // 找到單價欄位 - 根據表格結構是第8欄(索引7)
            const cells = row.querySelectorAll('td');
            if (cells.length > 7) {
                const fruitNameCell = cells[1]; // 第2欄是對外品名
                const unitPriceCell = cells[7]; // 第8欄是單價
                const fruitName = fruitNameCell.textContent.trim();
                const unitPrice = parseFloat(unitPriceCell.textContent.trim()) || 0;
                
                if (fruitName) {
                    console.log(`檢查第${rowIndex + 1}列的水果品名: "${fruitName}", 單價: ${unitPrice}`);
                    // 延遲執行以確保所有輸入欄位都已建立
                    setTimeout(() => {
                        // 先嘗試歷史資料匹配，如果沒有匹配再使用關鍵字自動帶入
                        const historyFound = checkHistoryAndAutoFill(fruitName, unitPrice, rowIndex);
                        if (!historyFound) {
                            autoFillByKeywords(fruitName, rowIndex);
                        }
                    }, 200);
                }
            }
        });
    }

    // 初始化預覽表格的智能輸入
    function initPreviewTableSmartInputs() {
        document.querySelectorAll('.additional-field').forEach(input => {
            const field = input.dataset.field;
            const rowIndex = input.dataset.row;
            const fieldId = input.id;
            
            if (field === 'Category') {
                initPreviewSmartInput(fieldId, 'category', rowIndex);
            } else if (field === '國家') {
                initPreviewSmartInput(fieldId, 'country', rowIndex);
            } else if (field === '區域') {
                initPreviewSmartInput(fieldId, 'region', rowIndex);
            }
            // 移除等級欄位的智能輸入功能
            // } else if (field === '等級') {
            //     initPreviewSmartInput(fieldId, 'grade', rowIndex);
            // }
        });
        
        // 設置國家和區域的關聯
        setupCountryRegionRelation();
        
        // 啟用關鍵字自動帶入功能
        setupFruitNameAutoFill();
    }
    // 設置國家和區域的關聯
    function setupCountryRegionRelation() {
        document.querySelectorAll('.additional-field').forEach(input => {
            const field = input.dataset.field;
            const rowIndex = input.dataset.row;
            
            if (field === '國家') {
                input.addEventListener('input', () => {
                    // 清空對應行的區域欄位
                    const regionInput = document.getElementById(`區域-${rowIndex}`);
                    if (regionInput) {
                        regionInput.value = '';
                        // 隱藏區域下拉選單
                        const regionDropdown = document.getElementById(`區域-${rowIndex}-dropdown`);
                        if (regionDropdown) {
                            regionDropdown.classList.add('hidden');
                        }
                        
                        // 如果區域欄位正在被使用，觸發其重新計算選項
                        setTimeout(() => {
                            if (document.activeElement === regionInput) {
                                regionInput.dispatchEvent(new Event('focus'));
                            }
                        }, 50);
                    }
                });
                
                input.addEventListener('change', () => {
                    // 清空對應行的區域欄位
                    const regionInput = document.getElementById(`區域-${rowIndex}`);
                    if (regionInput) {
                        regionInput.value = '';
                    }
                });
            }
        });
    }
    
    // 為預覽表格特製的智能輸入功能
    function initPreviewSmartInput(inputId, fieldType, rowIndex) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(`${inputId}-dropdown`);
        
        if (!input || !dropdown) return;
        
        let isOptionClicked = false;
        
        // 獲取該欄位的所有現有值
        const getExistingValues = () => {
            let values = [];
            
            if (fieldType === 'category') {
                values = [...new Set(products
                    .filter(p => p.category === 'large_fruit')
                    .map(p => p.details?.category)
                    .filter(v => v && v.trim() !== ''))];
            } else if (fieldType === 'country') {
                values = [...new Set(products
                    .filter(p => p.category === 'large_fruit')
                    .map(p => p.details?.country)
                    .filter(v => v && v.trim() !== ''))];
            } else if (fieldType === 'region') {
                // 區域：根據同行的國家欄位來過濾，只顯示地理區域
                const countryInput = document.getElementById(`國家-${rowIndex}`);
                const selectedCountry = countryInput ? countryInput.value.trim() : '';
                
                // 移除預定義區域映射，完全從資料維護中取得
                
                if (selectedCountry) {
                    // 如果有選擇國家，只顯示該國家在資料維護中的區域
                    values = [...new Set(products
                        .filter(p => p.category === 'large_fruit' && 
                                    p.details && p.details.region &&
                                    p.details.country === selectedCountry)
                        .map(p => p.details.region)
                        .filter(v => v && v.trim() !== ''))];
                } else {
                    // 如果沒有選擇國家，顯示所有資料維護中的區域
                    values = [...new Set(products
                        .filter(p => p.category === 'large_fruit')
                        .map(p => p.details?.region)
                        .filter(v => v && v.trim() !== ''))];
                }
            } else if (fieldType === 'grade') {
                // 等級：從現有產品中獲取等級選項
                values = [...new Set(products
                    .filter(p => p.category === 'large_fruit')
                    .map(p => p.details?.grade)
                    .filter(v => v && v.trim() !== ''))];
                
                // 添加一些常見的等級選項
                const commonGrades = ['特級', '一級', '二級', 'A級', 'B級', 'C級', 'Premium', 'Standard', 'Economy'];
                values = [...new Set([...values, ...commonGrades])];
            }
            
            return [...new Set(values)].sort();
        };
        
        // 顯示下拉選單
        const showDropdown = (filteredValues) => {
            if (filteredValues.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = filteredValues.map(value => 
                `<div class="px-3 py-2 hover:bg-blue-100 cursor-pointer text-sm">${value}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
            
            // 綁定選項點擊事件
            dropdown.querySelectorAll('div').forEach(option => {
                option.addEventListener('mousedown', () => {
                    isOptionClicked = true;
                    input.value = option.textContent;
                    dropdown.classList.add('hidden');
                    input.focus();
                });
            });
        };
        
        // 輸入事件
        input.addEventListener('input', () => {
            if (isOptionClicked) {
                isOptionClicked = false;
                return;
            }
            
            const query = input.value.toLowerCase();
            const allValues = getExistingValues();
            const filteredValues = allValues.filter(value => 
                value.toLowerCase().includes(query)
            );
            
            showDropdown(filteredValues);
        });
        
        // 焦點事件
        input.addEventListener('focus', () => {
            const allValues = getExistingValues();
            showDropdown(allValues);
        });
        
        // 失焦事件
        input.addEventListener('blur', () => {
            setTimeout(() => {
                if (!isOptionClicked) {
                    dropdown.classList.add('hidden');
                }
            }, 150);
        });
        
        // 點擊外部關閉下拉選單
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // 處理確認匯入
    function handleConfirmImport() {
        console.log('🔄 開始處理確認匯入 (V2 Logic)...');
        
        const rows = document.querySelectorAll('#preview-table tbody tr');
        let hasError = false;
        const validationErrors = [];

        // --- 第一階段：純驗證 ---
        console.log('--- Phase 1: Validation Only ---');
        rows.forEach((row, index) => {
            const additionalInputs = row.querySelectorAll('.additional-field');
            const categoryInput = additionalInputs[0];
            const countryInput = additionalInputs[1];
            
            // 清除舊的錯誤樣式
            categoryInput.classList.remove('border-red-500');
            countryInput.classList.remove('border-red-500');

            let rowHasError = false;
            const missingFields = [];
            if (!categoryInput.value.trim()) {
                hasError = true;
                rowHasError = true;
                categoryInput.classList.add('border-red-500');
                missingFields.push('Category');
            }
            if (!countryInput.value.trim()) {
                hasError = true;
                rowHasError = true;
                countryInput.classList.add('border-red-500');
                missingFields.push('國家');
            }

            if (rowHasError) {
                const errorMessage = `第${index + 1}列：缺少 ${missingFields.join('、')}`;
                validationErrors.push(errorMessage);
                console.warn(errorMessage);
            }
        });

        // --- 中斷檢查 ---
        if (hasError) {
            console.log('❌ 驗證失敗，流程已中斷。');
            showImportError('資料驗證失敗', '請填寫所有必填欄位：\n\n' + validationErrors.join('\n'));
            return; // 驗證失敗，完全停止後續執行
        }

        // --- 第二階段：純資料收集 ---
        console.log('--- Phase 2: Data Collection ---');
        const importData = [];
        rows.forEach((row) => {
            const cells = row.querySelectorAll('td');
            const additionalInputs = row.querySelectorAll('.additional-field');
            
            const rawPrice = cells[7].textContent.replace(/,/g, '');
            const rawQuantity = parseFloat(cells[6].textContent);
            
            const fruitTypeCode = cells[2].textContent.trim();
            const fruitTypeMapping = { 'APP-CL': '蘋果', 'APP-NZ': '蘋果', 'APP-US': '蘋果', 'CHY-CA': '櫻桃', 'CHY-CL': '櫻桃', 'CHY-US': '櫻桃', 'KIW-NZ': '奇異果', 'KIW-IT': '奇異果', 'MEL': '哈密瓜', 'GRP': '葡萄' };
            const fruitType = fruitTypeMapping[fruitTypeCode] || fruitTypeCode;
            
            const varietyCode = cells[4].textContent.trim();
            const varietyMapping = { 'CL FUJI': 'Fuji', 'AMBR8.7K': 'Ambrosia', 'AMBR 17K': 'Ambrosia', 'LAPI20B': 'Lapin', 'GOLD3.5': 'Gold', 'HONEYDE': 'Honeydew', 'VF': 'Variety' };
            const variety = varietyMapping[varietyCode] || varietyCode;
            
            const rowData = {
                日期: cells[0].textContent,
                對外品名: cells[1].textContent,
                水果種類: fruitType,
                SIZE: cells[3].textContent,
                品種: variety,
                品牌: cells[5].textContent,
                數量: rawQuantity,
                單價: parseFloat(rawPrice),
                Category: additionalInputs[0].value.trim(),
                國家: additionalInputs[1].value.trim(),
                區域: additionalInputs[2].value.trim() || '',
                等級: additionalInputs[3].value.trim() || ''
            };
            importData.push(rowData);
        });

        // --- 最終檢查並執行 ---
        if (importData.length === 0) {
            console.log('❌ 沒有可匯入的資料。');
            showImportError('沒有有效資料', '沒有可匯入的資料，請檢查檔案內容。');
            return;
        }
        
        console.log(`✅ 驗證通過，共 ${importData.length} 筆資料準備匯入。`);
        processFoxImport(importData);
    }
    // 處理狐狸頭匯入資料
    function processFoxImport(importData) {
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        importData.forEach((row, index) => {
            try {
                // 1. 建立或更新水果品項
                const fruitName = `${row.國家}${row.區域}${row.品種}`;
                const fruitSku = generateFruitSku(fruitName, row.國家, row.品種);
                
                // 檢查是否已存在
                const existingFruit = products.find(p => 
                    p.category === 'large_fruit' && 
                    p.name === fruitName &&
                    p.details?.category === row.Category &&
                    p.details?.fruitType === row.水果種類 &&
                    p.details?.variety === row.品種
                );
                
                if (!existingFruit) {
                    // 新增水果品項，包含狐狸頭匯入資料
                    const newFruit = {
                        sku: fruitSku,
                        category: 'large_fruit',
                        name: fruitName,
                        details: {
                            category: row.Category,
                            fruitType: row.水果種類,
                            variety: row.品種,
                            country: row.國家,
                            region: row.區域,
                            size: row.SIZE,
                            grade: '',
                            brand: row.品牌
                        },
                        // 保存狐狸頭匯入的完整原始資料
                        foxImportData: {
                            originalName: row.對外品名,
                            importDate: row.日期,
                            fruitType: row.水果種類,
                            size: row.SIZE,
                            variety: row.品種,
                            brand: row.品牌,
                            quantity: row.數量,
                            unitPrice: row.單價,
                            category: row.Category,
                            country: row.國家,
                            region: row.區域,
                            grade: row.等級,
                            // 從Excel的其他欄位取得參考資料
                            transactionType: '', // 異動別
                            transactionCode: '', // 交易碼  
                            customer: '', // 客戶/廠商
                            eta: '', // ETA
                            containerNumber: '', // 櫃號
                            documentNumber: '', // 單據號碼
                            coldStorage: '', // 冰庫
                            company: '', // 公司別
                            importTimestamp: new Date().toISOString()
                        }
                    };
                    products.push(newFruit);
                } else {
                    // 如果品項已存在但沒有狐狸頭資料，則添加
                    if (!existingFruit.foxImportData) {
                        existingFruit.foxImportData = {
                            originalName: row.對外品名,
                            importDate: row.日期,
                            fruitType: row.水果種類,
                            size: row.SIZE,
                            variety: row.品種,
                            brand: row.品牌,
                            quantity: row.數量,
                            unitPrice: row.單價,
                            category: row.Category,
                            country: row.國家,
                            region: row.區域,
                            grade: row.等級,
                            transactionType: '',
                            transactionCode: '',
                            customer: '',
                            eta: '',
                            containerNumber: '',
                            documentNumber: '',
                            coldStorage: '',
                            company: '',
                            importTimestamp: new Date().toISOString()
                        };
                    }
                }
                
                // 2. 更新庫存
                const targetSku = existingFruit ? existingFruit.sku : fruitSku;
                let stockItem = inventory.find(item => item.sku === targetSku);
                
                if (!stockItem) {
                    stockItem = { sku: targetSku, quantity: 0, unitCost: row.單價 };
                    inventory.push(stockItem);
                } else {
                    // 更新單位成本
                    stockItem.unitCost = row.單價;
                }
                
                // 增加庫存數量
                stockItem.quantity += row.數量;
                
                // 3. 生成批號
                const lotNumber = generateLotNumberForSku(targetSku);
                
                // 4. 添加批號到庫存項目
                if (!stockItem.lots) {
                    stockItem.lots = [];
                }
                
                // 檢查是否已有相同批號，如果沒有則新增
                let existingLot = stockItem.lots.find(lot => lot.lotNumber === lotNumber);
                if (!existingLot) {
                    stockItem.lots.push({
                        lotNumber: lotNumber,
                        quantity: row.數量
                    });
                } else {
                    existingLot.quantity += row.數量;
                }
                
                // 5. 記錄庫存異動 - 使用正確的 addInventoryLog 函式
                addInventoryLog(
                    targetSku, 
                    '狐狸頭匯入', 
                    row.數量, 
                    `匯入自Excel - 原始品名: ${row.對外品名}`, 
                    lotNumber, 
                    row.單價
                );
                
                successCount++;
                
            } catch (error) {
                errorCount++;
                errors.push(`第${index + 1}列：${error.message}`);
            }
        });
        
        // 顯示結果
        const resultMessage = `匯入完成！成功：${successCount} 筆，失敗：${errorCount} 筆`;
        
        console.log('🎉 匯入結果:', { successCount, errorCount, errors });
        
        if (errors.length > 0) {
            showImportError('匯入部分成功', resultMessage + '\n\n錯誤詳情：\n' + errors.join('\n'));
            // 延遲關閉，讓用戶看到錯誤訊息
            setTimeout(() => {
                const modal = document.getElementById('fox-import-modal');
                if (modal) {
                    modal.remove();
                    console.log('🚪 已關閉狐狸頭匯入模態框（部分成功）');
                }
                renderApp();
            }, 5000);
        } else {
            showImportSuccess(resultMessage);
            // 延遲關閉
            setTimeout(() => {
                const modal = document.getElementById('fox-import-modal');
                if (modal) {
                    modal.remove();
                    console.log('🚪 已關閉狐狸頭匯入模態框（完全成功）');
                }
                renderApp();
            }, 2000);
        }
    }

    // 測試和優化功能
    function testImportFunctionality() {
        console.log('=== 匯入功能測試 ===');
        
        // 測試檔案格式驗證
        const testFiles = [
            { name: 'test.txt', expected: false },
            { name: 'test.csv', expected: true },
            { name: 'test.xlsx', expected: true },
            { name: 'test.xls', expected: true }
        ];
        
        testFiles.forEach(testFile => {
            const isValid = testFile.name.match(/\.(xlsx|xls|csv)$/);
            const result = isValid ? '✅' : '❌';
            console.log(`檔案格式測試 - ${testFile.name}: ${result} (預期: ${testFile.expected ? '✅' : '❌'})`);
        });
        
        // 測試必要欄位驗證
        const testHeaders = ['日期', '水果種類', 'SIZE', '品種', '品牌', '數量', '單價'];
        const testData = [{
            '日期': '0114.08.22',
            '水果種類': 'APP-CL',
            'SIZE': '56',
            '品種': 'CL FUJI',
            '品牌': 'FRUSAN',
            '數量': 9.0,
            '單價': 600
        }];
        
        const validation = validateFileStructure(testHeaders, testData);
        console.log('資料驗證測試:', validation.isValid ? '✅ 通過' : '❌ 失敗');
        console.log('測試完成');
    }

    // 性能優化：防抖函數
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // 優化檔案上傳體驗
    function enhanceFileUploadUX() {
        const uploadArea = document.getElementById('file-upload-area');
        if (!uploadArea) return;

        // 防止瀏覽器預設的拖拽行為
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // 添加視覺反饋
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('border-blue-500', 'bg-blue-50');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
        }
    }

    // 在開發模式下運行測試
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        // 延遲執行測試，確保DOM已載入
        setTimeout(testImportFunctionality, 1000);
    }
    renderWorkOrderList = function() { 
        if (!workOrderListContainer) return; 
        workOrderListContainer.innerHTML = ''; 
        
        // 根據角色決定要顯示的工單
        let filteredWorkOrders = workOrders;
        if (currentRole === 'retail') {
            // 門市人員只顯示符合當前篩選狀態的工單
            filteredWorkOrders = workOrders.filter(wo => wo.status === currentWorkOrderStatusFilter);
        }
        
        const statusColors = {
            '待處理': 'bg-yellow-100 text-yellow-800', 
            '包裝中': 'bg-blue-100 text-blue-800', 
            '已完成': 'bg-green-100 text-green-800'
        };
        
        filteredWorkOrders.forEach(wo => { 
            const product = findProduct(wo.largeItemSku); 
            const item = document.createElement('div'); 
            item.className = `work-order-item p-3 border-l-4 cursor-pointer hover:bg-gray-50 transition-all duration-200 ${selectedWorkOrderId === wo.id ? 'selected' : 'border-transparent'}`; 
            item.dataset.id = wo.id; 
            
            // 對門市人員，使用水果品名顯示
            const displayName = currentRole === 'retail' && product ? getSmallItemDisplayName(wo.smallItemSku) : (product ? product.name : '未知品項');
            
            item.innerHTML = `<div class="flex justify-between items-center"><p class="font-semibold text-gray-800">${displayName}</p><span class="text-xs font-medium px-2 py-1 rounded-full ${statusColors[wo.status] || 'bg-gray-100'}">${wo.status}</span></div><p class="text-sm text-gray-500">${wo.id}</p>`; 
            item.addEventListener('click', () => { selectedWorkOrderId = wo.id; renderApp(); }); 
            workOrderListContainer.appendChild(item); 
        }); 
    };
    renderWorkOrderDetails = function() { if (!workOrderDetailsContainer) return; if (!selectedWorkOrderId || !currentRole) { workOrderDetailsContainer.innerHTML = `<div class="text-center text-gray-500 pt-16"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900">請選擇角色與工單</h3><p class="mt-1 text-sm text-gray-500">請先從上方選擇您的角色，再從左側列表選擇一張工單。</p></div>`; return; } const wo = workOrders.find(w => w.id === selectedWorkOrderId); if (!wo) return; const largeProduct = findProduct(wo.largeItemSku), smallProduct = findProduct(wo.smallItemSku), boxProduct = findProduct(wo.boxSku); if (!largeProduct || !smallProduct || !boxProduct) { workOrderDetailsContainer.innerHTML = `<p class="text-red-500">錯誤：找不到工單所需的產品資料。</p>`; return; } let html = `<div class="fade-in space-y-6">`; html += `<div><div class="flex justify-between items-start"><div><h2 class="text-xl font-bold text-gray-900">${largeProduct.name} - 大轉小工單</h2><p class="text-sm text-gray-500">${wo.id}</p></div><span class="text-sm font-semibold px-3 py-1 rounded-full ${{'待處理':'bg-yellow-100 text-yellow-800','包裝中':'bg-blue-100 text-blue-800','已完成':'bg-green-100 text-green-800'}[wo.status] || 'bg-gray-100'}">${wo.status}</span></div></div><div class="border-t border-gray-200"></div>`; html += `<div><h3 class="font-semibold text-gray-800 mb-2">原料水果資訊</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm p-4 bg-gray-50 rounded-lg"><p><strong class="text-gray-600">品名/品種:</strong> ${largeProduct.name} / ${largeProduct.details.variety || 'N/A'}</p><p><strong class="text-gray-600">品牌:</strong> ${largeProduct.details.brand || 'N/A'}</p><p><strong class="text-gray-600">國家/區域:</strong> ${largeProduct.details.country || 'N/A'} / ${largeProduct.details.region || 'N/A'}</p><p><strong class="text-gray-600">等級/大小:</strong> ${largeProduct.details.grade || 'N/A'} / ${largeProduct.details.size || 'N/A'}</p><p class="md:col-span-2 font-medium"><strong class="text-gray-600">來源工號:</strong> <span class="text-indigo-600">${wo.sourceLotNumber || 'N/A'}</span></p></div></div>`; if (['retail', 'packaging'].includes(currentRole)) { const boxStock = findStock(wo.boxSku); const locationQuantities = {}; inventoryLog.filter(log => log.sku === wo.boxSku && log.storageLocation).forEach(log => { locationQuantities[log.storageLocation] = (locationQuantities[log.storageLocation] || 0) + log.quantity; }); const locationDetailText = Object.entries(locationQuantities).filter(([, qty]) => qty > 0).map(([loc, qty]) => `${loc}: ${qty.toLocaleString()}`).join('，') || '無儲位資訊'; const additionalList = (wo.additionalPackagingSkus || []).map(sku => { const p = findProduct(sku); const inv = findStock(sku); return `<span class="inline-flex items-center px-2 py-1 text-xs rounded-full border ${inv && inv.quantity>0 ? 'border-green-300 text-green-700' : 'border-red-300 text-red-700'}">${p?.name || sku}${inv ? `（庫存:${inv.quantity}）` : ''}</span>`; }).join(' '); html += `<div><h3 class="font-semibold text-gray-800 mb-2">門市需求 (包裝指示)</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm p-4 bg-blue-50 rounded-lg"><p><strong class="text-gray-600">包裝盒名稱:</strong> ${boxProduct.name}</p><p><strong class="text-gray-600">小件規格:</strong> ${boxProduct.details.spec || 'N/A'}</p><p><strong class="text-gray-600">需求大件數:</strong> ${wo.warehouseInfo.requestUnits} 箱</p><p><strong class="text-gray-600">包材庫存:</strong> <span class="font-medium ${boxStock && boxStock.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${boxStock ? boxStock.quantity : 'N/A'}</span></p><p class="md:col-span-2"><strong class="text-gray-600">包材儲位:</strong> ${locationDetailText}</p>${(wo.additionalPackagingSkus && wo.additionalPackagingSkus.length>0) ? `<p class="md:col-span-2"><strong class="text-gray-600">選用包材:</strong> ${additionalList}</p>` : ''}${wo.retailRequest.note ? `<p class="md:col-span-2"><strong class="text-gray-600">備註:</strong> ${wo.retailRequest.note}</p>` : ''}</div></div>`; } if (['warehouse'].includes(currentRole)) { const stock = findStock(wo.largeItemSku); const stockInfo = stock ? `(現有庫存: ${stock.quantity})` : '(無庫存資料)'; html += `<div><h3 class="font-semibold text-gray-800 mb-2">倉儲作業</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm p-4 bg-gray-50 rounded-lg"><p><strong class="text-gray-600">需求大件數:</strong> ${wo.warehouseInfo.requestUnits} 箱 <span class="text-blue-600 font-medium">${stockInfo}</span></p><p><strong class="text-gray-600">實際出庫數量:</strong> ${currentRole === 'warehouse' && wo.status === '待處理' ? wo.warehouseInfo.requestUnits + ' 箱' : (wo.warehouseInfo.dispatchedUnits > 0 ? wo.warehouseInfo.dispatchedUnits + ' 箱' : '尚未出庫')}</p><p><strong class="text-gray-600">出庫人員:</strong> ${wo.warehouseInfo.dispatchedBy || 'N/A'}</p><p><strong class="text-gray-600">出庫時間:</strong> ${wo.warehouseInfo.dispatchedAt ? wo.warehouseInfo.dispatchedAt.toLocaleString('sv-SE') : 'N/A'}</p><p class="md:col-span-2"><strong class="text-gray-600">包裝退庫數量:</strong> ${wo.warehouseInfo.returnedUnits > 0 ? wo.warehouseInfo.returnedUnits + ' 箱' : '無'}</p></div></div>`; } if (['packaging'].includes(currentRole)) { html += `<div><h3 class="font-semibold text-gray-800 mb-2">包裝成果</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm p-4 bg-blue-50 rounded-lg">${currentRole === 'packaging' && wo.status === '包裝中' ? `<div><label for="producedCount" class="block text-sm font-medium text-gray-700">小件成品數量</label><input type="number" id="producedCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="輸入成品盒數"></div><div><label for="ngCount" class="block text-sm font-medium text-gray-700">NG/損耗數量 (顆/g)</label><input type="number" id="ngCount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="輸入損耗數量"></div><div><label for="returnedUnits" class="block text-sm font-medium text-gray-700">退庫大件數量</label><input type="number" id="returnedUnits" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="輸入未使用完的大件數量"></div>` : `<p><strong class="text-gray-600">小件成品數量:</strong> ${wo.packagingResult.producedCount > 0 ? wo.packagingResult.producedCount + ' 盒' : '尚未回報'}</p><p><strong class="text-gray-600">NG/損耗數量:</strong> ${wo.packagingResult.ngCount > 0 ? wo.packagingResult.ngCount : '無'}</p><p><strong class="text-gray-600">完成人員:</strong> ${wo.packagingResult.completedBy || 'N/A'}</p><p><strong class="text-gray-600">完成時間:</strong> ${wo.packagingResult.completedAt ? wo.packagingResult.completedAt.toLocaleString('sv-SE') : 'N/A'}</p>`}</div></div>`; } if (currentRole === 'retail' && wo.status === '已完成') { const boxPrice = boxProduct.details?.price || 0; const otherPkgs = (wo.additionalPackagingSkus || []).map(s => findProduct(s)).filter(Boolean); const otherCost = otherPkgs.reduce((sum, p) => sum + (p.details?.price || 0), 0); html += `<div><h3 class="font-semibold text-gray-800 mb-2">成本分析</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm p-4 bg-green-50 rounded-lg"><p><strong class="text-gray-600">大件單位成本:</strong> $${wo.costing.unitCost.toLocaleString()}</p><p><strong class="text-gray-600">包材(盒子)費用:</strong> $${boxPrice.toLocaleString()}</p>${otherPkgs.length>0 ? `<p class="md:col-span-2"><strong class="text-gray-600">其他包材費用(每盒合計):</strong> $${otherCost.toLocaleString()}</p>` : ''}<p class="md:col-span-2 text-lg font-bold text-green-800"><strong class="text-gray-600">最終成品單位成本:</strong> $${wo.costing.finalCostPerPackage.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p><p class="md:col-span-2 text-xs text-gray-500">公式: (大件成本 * (出庫-退庫)件數 / 小件成品數) + 盒子費用 + 其他包材費用</p></div></div>`; } html += `<div class="border-t border-gray-200 pt-6">`; if (currentRole === 'warehouse' && wo.status === '待處理') { html += `<button id="dispatch-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">確認領料出庫</button>`; } if (currentRole === 'packaging' && wo.status === '待處理') { html += `<p class="text-sm text-center text-orange-600 bg-orange-100 p-3 rounded-md">等待倉儲人員領料出庫...</p>`; } if (currentRole === 'packaging' && wo.status === '包裝中') { html += `<button id="complete-packaging-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">回報包裝成果</button>`; } if (wo.status === '已完成') { html += `<p class="text-sm text-center text-green-600 bg-green-100 p-3 rounded-md">此工單已完成歸檔。</p>`; } html += `</div></div>`; workOrderDetailsContainer.innerHTML = html; attachActionListeners(wo); };

    // --- New Modal Functions ---
    function openNewWorkOrderModal() {
        // 生成水果選項，包含庫存數量
        const largeFruits = products.filter(p => p.category === 'large_fruit');
        const fruitOptions = largeFruits.map(p => {
            // 查找對應的庫存數據
            const stockItem = inventory.find(i => i.sku === p.sku);
            const stockQuantity = stockItem ? stockItem.quantity : 0;
            
            // 生成選項文字，使用【】符號來突出庫存數量
            const displayText = `${p.name} (${p.details.size}) - 庫存:【${stockQuantity}】`;
            
            return `<option value="${p.sku}" data-stock="${stockQuantity}">${displayText}</option>`;
        }).join('');
        const boxItems = products.filter(p => p.category === 'packaging' && p.details?.type === 'box');
        // 初始化全域包材選擇狀態
        selectedBoxSku = boxItems[0]?.sku || '';
        selectedAdditional = new Set();
        let currentWOFormState = {}; // 保存工單表單狀態

        const renderSelectedSummary = () => {
            const box = findProduct(selectedBoxSku);
            const others = Array.from(selectedAdditional).map(sku => findProduct(sku)).filter(Boolean);
            const chips = others.map(p => `<span class="inline-flex items-center px-2 py-1 text-xs rounded-full border border-gray-300 mr-1 mb-1">${p.name}</span>`).join('') || '<span class="text-xs text-gray-400">未選擇</span>';
            return `<div class="space-y-2">
                <div><span class="text-sm text-gray-600">盒子:</span> <span class="text-sm font-medium">${box ? box.name : '未選擇'}</span></div>
                <div><span class="text-sm text-gray-600">其他包材:</span> <div class="mt-1">${chips}</div></div>
            </div>`;
        };

        function renderWOForm(initialState = {}) {
            const fruitOptions = products
                .filter(p => p.category === 'large_fruit')
                .map(p => {
                    // 查找對應的庫存數據
                    const stockItem = inventory.find(i => i.sku === p.sku);
                    const stockQuantity = stockItem ? stockItem.quantity : 0;
                    // 生成選項文字，使用【】符號來突出庫存數量
                    const displayText = `${p.name} (${p.details.size}) - 庫存:【${stockQuantity}】`;
                    const selected = initialState.largeItemSku === p.sku ? 'selected' : '';
                    return `<option value="${p.sku}" data-stock="${stockQuantity}" ${selected}>${displayText}</option>`;
                })
                .join('');
            
            const html = `
                <form id="new-wo-form" class="p-6 space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-3">新增工單</h3>
                    <div><label class="block text-sm font-medium">選擇大件水果</label><select name="largeItemSku" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm fruit-select">${fruitOptions}</select></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">需求大件數</label><input name="requestUnits" type="number" min="1" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm" value="${initialState.requestUnits || ''}"></div>
                        <div><label class="block text-sm font-medium">大件單位成本</label><input name="unitCost" type="number" min="0" step="0.01" required class="mt-1 w-full rounded-md border-gray-300 bg-gray-100 shadow-sm" placeholder="選擇水果後自動帶入" readonly value="${initialState.unitCost || ''}"></div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium">包材</label>
                            <div class="flex gap-2">
                                <select id="favorite-combo-select" class="text-sm px-3 py-1 rounded-md border-gray-300">
                                    <option value="">常用組合</option>
                                </select>
                                <button type="button" id="add-to-favorite-btn" class="text-sm px-3 py-1 rounded-md bg-green-600 text-white hover:bg-green-700">加入常用</button>
                                <button type="button" id="open-pkg-picker" class="text-sm px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700">選擇包材</button>
                            </div>
                        </div>
                        <div id="selected-packaging-summary" class="p-3 bg-gray-50 rounded-md border">${renderSelectedSummary()}</div>
                    </div>
                    <div><label class="block text-sm font-medium">備註</label><textarea name="note" rows="2" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${initialState.note || ''}</textarea></div>
                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">建立工單</button>
                    </div>
                </form>`;

            const modalContent = document.getElementById('modal-content');
            if (!modalContent.innerHTML.trim()) {
                // 如果模態框還沒開啟，正常開啟
            openModal(html);
            } else {
                // 如果模態框已經開啟，只替換內容並調整大小
                modalContent.className = `bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform translateY(0)`;
                modalContent.innerHTML = html;
            }
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            document.getElementById('open-pkg-picker').addEventListener('click', openPackagingPickerModal);
            document.getElementById('new-wo-form').addEventListener('submit', submitWOForm);
            
            // 水果選擇變更時自動帶入大件成本
            const fruitSelect = document.querySelector('.fruit-select');
            const unitCostInput = document.querySelector('input[name="unitCost"]');
            
            fruitSelect.addEventListener('change', function() {
                const selectedSku = this.value;
                if (selectedSku) {
                    const stockItem = inventory.find(item => item.sku === selectedSku);
                    if (stockItem && stockItem.unitCost) {
                        unitCostInput.value = stockItem.unitCost;
                    } else {
                        unitCostInput.value = '';
                        unitCostInput.placeholder = '此品項未設定單位成本';
                    }
                } else {
                    unitCostInput.value = '';
                    unitCostInput.placeholder = '選擇水果後自動帶入';
                }
            });
            
            // 為水果選擇下拉選單添加樣式和處理藍色字體
            if (fruitSelect) {
                fruitSelect.style.fontSize = '14px';
                fruitSelect.style.lineHeight = '1.5';
                
                // 為每個選項添加庫存數量的提示並處理藍色顯示
                Array.from(fruitSelect.options).forEach(option => {
                    const stockQuantity = parseInt(option.getAttribute('data-stock') || '0');
                    option.setAttribute('title', `庫存數量: ${stockQuantity}`);
                    
                    // 使用【】符號來視覺上突出庫存數量
                    // 由於 HTML option 元素的樣式限制，使用【】符號來標示庫存數量
                    option.style.color = '#374151';
                    option.style.fontWeight = '500';
                });
            }
            
            // 初始化常用組合下拉選單
            initFavoriteComboDropdown();
            // 綁定常用組合選擇事件
            document.getElementById('favorite-combo-select').addEventListener('change', handleFavoriteComboSelect);
            // 綁定加入常用按鈕事件
            document.getElementById('add-to-favorite-btn').addEventListener('click', handleAddToFavorite);
        }

        function submitWOForm(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const largeItemSku = formData.get('largeItemSku');
            const requestUnits = parseInt(formData.get('requestUnits'));
            if (!selectedBoxSku) { alert('請先選擇盒子'); return; }

            const stockItem = findStock(largeItemSku);
            const availableLot = stockItem && stockItem.lots ? stockItem.lots.find(l => l.quantity >= requestUnits) : undefined;
            if (!availableLot) { alert(`錯誤：此水果無單一足夠庫存的工號可供配發。\n需求: ${requestUnits} | 請檢查庫存。`); return; }
            const sourceLotNumber = availableLot.lotNumber;

            // 生成小件成品 SKU
            const boxProduct = findProduct(selectedBoxSku);
            let smallItemSku = `PKG-${selectedBoxSku.split('-')[1]}-${selectedBoxSku.split('-')[2]}`;
            let smallProduct = findProduct(smallItemSku);
            if (!smallProduct) {
                // 如果小件成品不存在，創建新的小件成品
                smallProduct = { 
                    sku: smallItemSku, 
                    category: 'small_fruit', 
                    name: `${boxProduct.name} (${boxProduct.details.spec})` 
                };
                products.push(smallProduct);
                inventory.push({ sku: smallItemSku, quantity: 0 });
            }

            const newWO = {
                id: (() => { let id = generateWorkOrderId('WO'); while (workOrders.some(w => w.id === id)) { id = generateWorkOrderId('WO'); } return id; })(),
                status: '待處理',
                largeItemSku,
                sourceLotNumber,
                smallItemSku,
                boxSku: selectedBoxSku,
                retailRequest: { note: formData.get('note') },
                warehouseInfo: { requestUnits, dispatchedUnits: 0, dispatchedBy: '', dispatchedAt: null, returnedUnits: 0 },
                packagingResult: { receivedUnits: 0, producedCount: 0, ngCount: 0, completedBy: '', completedAt: null },
                costing: { unitCost: parseFloat(formData.get('unitCost')), finalCostPerPackage: 0 },
                additionalPackagingSkus: Array.from(selectedAdditional),
            };
            workOrders.unshift(newWO);
            closeModal();
            currentView = 'work_orders';
            selectedWorkOrderId = newWO.id;
            renderApp();
        }
        function openPackagingPickerModal() {
            // 保存當前表單狀態到全域變數
            const form = document.getElementById('new-wo-form');
            if (form) {
                currentWOFormState = {
                    largeItemSku: form.elements.largeItemSku.value,
                    requestUnits: form.elements.requestUnits.value,
                    unitCost: form.elements.unitCost.value,
                    note: form.elements.note.value
                };
            }
            
            let activeTabKey = 'box';

            function renderPicker() {
                const tabHasSelection = (key) => {
                    if (key === 'box') {
                        return !!selectedBoxSku;
                    }
                    const skusForCategory = products
                        .filter(p => p.category === 'packaging' && p.details?.type === key)
                        .map(p => p.sku);
                    return skusForCategory.some(sku => selectedAdditional.has(sku));
                };

                const tabsHtml = packagingCategories.map(cat => {
                    const hasSelection = tabHasSelection(cat.key);
                    const isActive = cat.key === activeTabKey;
                    const baseClass = 'px-4 py-3 text-sm text-left w-full transition-colors duration-150';
                    const activeClasses = isActive ? 'bg-white font-semibold text-blue-700' : 'hover:bg-gray-200';
                    const selectionClasses = hasSelection ? 'border-l-4 border-blue-500 font-semibold' : 'border-l-4 border-transparent';
                    const combinedClasses = `${baseClass} ${activeClasses} ${selectionClasses}`;
                    
                    return `<button type="button" data-key="${cat.key}" class="pkg-tab-btn ${combinedClasses}">${cat.name}</button>`;
                }).join('');

                const itemsForActiveTab = products.filter(p => p.category === 'packaging' && p.details?.type === activeTabKey);
                const buttonsHtml = itemsForActiveTab.map(p => {
                    const isBox = activeTabKey === 'box';
                    const isActive = isBox ? (p.sku === selectedBoxSku) : selectedAdditional.has(p.sku);
                    const buttonClass = `pkg-item-btn px-4 py-2 rounded-md border text-sm w-full text-left flex justify-between items-center ${isActive ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-50'}`;
                    const checkmark = isActive ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>' : '';
                    return `<button type="button" data-sku="${p.sku}" data-type="${activeTabKey}" class="${buttonClass}"><span>${p.name}</span> ${checkmark}</button>`;
                }).join('');

                const renderPickerSummary = () => {
                    const box = findProduct(selectedBoxSku);
                    const others = Array.from(selectedAdditional).map(sku => findProduct(sku)).filter(Boolean);
                    
                    if (!box && others.length === 0) {
                        return '<p class="text-sm text-gray-500">尚未選擇任何包材</p>';
                    }

                    const boxHtml = box ? `<span class="inline-flex items-center px-2.5 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800 mr-2 mb-2">${box.name} (盒子)</span>` : '';
                    const othersHtml = others.map(p => `<span class="inline-flex items-center px-2.5 py-1 text-sm font-medium rounded-full bg-gray-200 text-gray-800 mr-2 mb-2">${p.name}</span>`).join('');

                    return boxHtml + othersHtml;
                };

                const modalHtml = `
                    <div class="p-0 flex flex-col max-h-[80vh]" style="height: 80vh;">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">選擇包材</h3>
                        </div>
                        <div class="flex-grow flex overflow-hidden">
                            <div class="w-1/3 border-r bg-gray-100 overflow-y-auto">
                                <nav class="flex flex-col pt-2">${tabsHtml}</nav>
                            </div>
                            <div class="w-2/3 overflow-y-auto p-4">
                                <div class="space-y-2">${buttonsHtml || '<p class="text-sm text-gray-500">此類別尚無品項</p>'}</div>
                            </div>
                        </div>
                        <div class="p-4 border-t bg-white">
                            <h4 class="text-sm font-semibold text-gray-800 mb-2">已選項目：</h4>
                            <div id="picker-summary" class="flex flex-wrap items-center min-h-[2.5rem]">
                                ${renderPickerSummary()}
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                            <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                            <button type="button" id="save-pkg-selection" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">儲存選擇</button>
                        </div>
                    </div>`;
                
                modalContent.innerHTML = modalHtml;
                attachPickerListeners();
            }

            function attachPickerListeners() {
                modalContent.querySelector('.cancel-btn').addEventListener('click', () => {
                    renderWOForm(currentWOFormState); // 取消時還原之前的表單狀態
                });
                modalContent.querySelector('#save-pkg-selection').addEventListener('click', () => { 
                    renderWOForm(currentWOFormState); // 儲存選擇後回到工單表單並還原狀態
                });

                modalContent.querySelectorAll('.pkg-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        activeTabKey = btn.dataset.key;
                        renderPicker();
                    });
                });

                modalContent.querySelectorAll('.pkg-item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const sku = btn.dataset.sku;
                        const type = btn.dataset.type;
                        if (type === 'box') {
                            selectedBoxSku = (selectedBoxSku === sku) ? '' : sku;
                        } else {
                            if (selectedAdditional.has(sku)) {
                                selectedAdditional.delete(sku);
                            } else {
                                selectedAdditional.add(sku);
                            }
                        }
                        renderPicker();
                    });
                });
            }
            
            const modalContent = document.getElementById('modal-content');
            if (!modalContent.innerHTML.trim()) {
                // 如果模態框還沒開啟，先開啟它
            openModal('', 'max-w-3xl');
            } else {
                // 如果模態框已經開啟，只需要改變大小
                modalContent.className = `bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform translateY(0)`;
            }
            renderPicker();
        }

        // 常用組合相關輔助函數
        function initFavoriteComboDropdown() {
            const select = document.getElementById('favorite-combo-select');
            if (!select) return;
            
            // 在初始化下拉選單前先清理無效的包材
            cleanupInvalidPackagingInCombos();
            
            // 清空現有選項（保留預設選項）
            select.innerHTML = '<option value="">常用組合</option>';
            
            // 只顯示可見且有效的常用組合
            const visibleCombos = favoritePackagingCombos.filter(combo => combo.visible && (combo.boxSku || combo.additionalSkus.length > 0));
            visibleCombos.forEach(combo => {
                const option = document.createElement('option');
                option.value = combo.id;
                option.textContent = combo.name;
                select.appendChild(option);
            });
        }
        
        function handleFavoriteComboSelect(e) {
            const comboId = e.target.value;
            if (!comboId) return;
            
            const combo = favoritePackagingCombos.find(c => c.id === comboId);
            if (!combo) return;
            
            // 套用選中的常用組合
            selectedBoxSku = combo.boxSku;
            selectedAdditional.clear();
            combo.additionalSkus.forEach(sku => selectedAdditional.add(sku));
            
            // 更新顯示
            updateSelectedSummary();
        }
        
        function handleAddToFavorite() {
            if (!selectedBoxSku) {
                openErrorModal('請先選擇包材組合才能加入常用');
                return;
            }
            
            // 保存當前表單狀態到全域變數
            const form = document.getElementById('new-wo-form');
            currentWOFormState = {
                largeItemSku: form.elements.largeItemSku.value,
                requestUnits: form.elements.requestUnits.value,
                unitCost: form.elements.unitCost.value,
                note: form.elements.note.value
            };
            
            openAddFavoriteModal();
        }
        
        function openAddFavoriteModal() {
            const modalHtml = `
                <form id="add-favorite-form" class="p-6 space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-3">加入常用組合</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">組合名稱</label>
                        <input type="text" id="favorite-name-input" 
                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" 
                               placeholder="請輸入常用組合名稱" required>
                    </div>
                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">取消</button>
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">加入常用</button>
                    </div>
                </form>`;
            
            openModal(modalHtml);
            
            // 聚焦到輸入框
            setTimeout(() => {
                const input = document.getElementById('favorite-name-input');
                if (input) {
                    input.focus();
                }
            }, 100);
            
            document.querySelector('.cancel-btn').addEventListener('click', closeModal);
            document.getElementById('add-favorite-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('favorite-name-input').value.trim();
                
                if (!name) {
                    openErrorModal('請輸入組合名稱');
                    return;
                }
                
                // 檢查名稱是否重複
                if (favoritePackagingCombos.some(combo => combo.name === name)) {
                    openErrorModal('此名稱已存在，請使用其他名稱');
                    return;
                }
                
                // 建立新的常用組合
                const newCombo = {
                    id: `combo-${Date.now()}`,
                    name: name,
                    boxSku: selectedBoxSku,
                    additionalSkus: Array.from(selectedAdditional),
                    visible: true,
                    createdAt: new Date()
                };
                
                favoritePackagingCombos.push(newCombo);
                
                // 重新初始化下拉選單
                initFavoriteComboDropdown();
                
                // 直接回到工單表單，不顯示成功訊息
                renderWOForm(currentWOFormState);
            });
        }
        

        
        function updateSelectedSummary() {
            const summaryDiv = document.getElementById('selected-packaging-summary');
            if (summaryDiv) {
                summaryDiv.innerHTML = renderSelectedSummary();
            }
        }

        // 初始渲染表單
        renderWOForm();
    }
    // 檢視狐狸頭匯入資料的功能
    function viewFoxImportData(sku) {
        const product = findProduct(sku);
        if (!product || !product.foxImportData) {
            alert('找不到狐狸頭匯入資料');
            return;
        }
        
        const foxData = product.foxImportData;
        const modalHtml = `
            <div class="p-6">
                <h3 class="text-lg font-semibold border-b pb-3 mb-4">狐狸頭匯入資料詳情</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <label class="block text-sm font-medium text-gray-700">品項名稱</label>
                            <div class="text-sm text-gray-900">${product.name}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <label class="block text-sm font-medium text-gray-700">狐狸頭@水果品名</label>
                            <div class="text-sm text-gray-900">${foxData.originalName}</div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="text-md font-medium text-gray-900 mb-3">匯入時的完整資料</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="font-medium">日期:</span> ${foxData.importDate || '未記錄'}</div>
                            <div><span class="font-medium">水果種類:</span> ${foxData.fruitType || '未記錄'}</div>
                            <div><span class="font-medium">SIZE:</span> ${foxData.size || '未記錄'}</div>
                            <div><span class="font-medium">品種:</span> ${foxData.variety || '未記錄'}</div>
                            <div><span class="font-medium">品牌:</span> ${foxData.brand || '未記錄'}</div>
                            <div><span class="font-medium">數量:</span> ${foxData.quantity || '未記錄'}</div>
                            <div><span class="font-medium">單價:</span> ${foxData.unitPrice || '未記錄'}</div>
                            <div><span class="font-medium">Category:</span> ${foxData.category || '未記錄'}</div>
                            <div><span class="font-medium">國家:</span> ${foxData.country || '未記錄'}</div>
                            <div><span class="font-medium">區域:</span> ${foxData.region || '未記錄'}</div>
                            <div><span class="font-medium">等級:</span> ${foxData.grade || '未記錄'}</div>
                            <div><span class="font-medium">異動別:</span> ${foxData.transactionType || '未記錄'}</div>
                            <div><span class="font-medium">交易碼:</span> ${foxData.transactionCode || '未記錄'}</div>
                            <div><span class="font-medium">客戶/廠商:</span> ${foxData.customer || '未記錄'}</div>
                            <div><span class="font-medium">ETA:</span> ${foxData.eta || '未記錄'}</div>
                            <div><span class="font-medium">櫃號:</span> ${foxData.containerNumber || '未記錄'}</div>
                            <div><span class="font-medium">單據號碼:</span> ${foxData.documentNumber || '未記錄'}</div>
                            <div><span class="font-medium">冰庫:</span> ${foxData.coldStorage || '未記錄'}</div>
                            <div><span class="font-medium">公司別:</span> ${foxData.company || '未記錄'}</div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="text-xs text-gray-500">匯入時間: ${foxData.importTimestamp ? new Date(foxData.importTimestamp).toLocaleString() : '未記錄'}</div>
                    </div>
                </div>
                <div class="pt-4 flex justify-end">
                    <button class="ok-btn bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">確認</button>
                </div>
            </div>`;
        
        openModal(modalHtml, 'max-w-4xl');
        document.querySelector('.ok-btn').addEventListener('click', closeModal);
    }

    function openInventoryLookupModal() {
        const modalHtml = `
            <div class="p-6">
                <h3 class="text-lg font-semibold border-b pb-3 mb-4">庫存快速查詢</h3>
                <input type="text" id="inventory-search-input" placeholder="搜尋品項名稱..." class="w-full rounded-md border-gray-300 shadow-sm mb-4">
                <div id="inventory-lookup-results" class="max-h-96 overflow-y-auto"></div>
            </div>`;
        openModal(modalHtml, 'max-w-2xl');

        const searchInput = document.getElementById('inventory-search-input');
        const resultsContainer = document.getElementById('inventory-lookup-results');

        const renderResults = (filter = '') => {
            resultsContainer.innerHTML = '';
            const filteredInventory = inventory.filter(i => {
                const product = findProduct(i.sku);
                return product.name.toLowerCase().includes(filter.toLowerCase()) || product.sku.toLowerCase().includes(filter.toLowerCase());
            });

            if (filteredInventory.length === 0) {
                resultsContainer.innerHTML = `<p class="text-center text-gray-500 py-4">找不到符合條件的品項。</p>`;
                return;
            }

            let table = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">品項</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">工號 (批號)</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">庫存</th>
                </tr></thead><tbody>`;
            
            filteredInventory.forEach(item => {
                const product = findProduct(item.sku);
                if (product.category === 'large_fruit' && item.lots && item.lots.length > 0) {
                    item.lots.forEach(lot => {
                         table += `<tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-center"><div class="text-sm font-medium text-gray-900">${product.name}</div><div class="text-xs text-gray-500">${product.sku}</div></td>
                            <td class="px-4 py-3 text-center text-sm text-gray-700">${lot.lotNumber}</td>
                            <td class="px-4 py-3 text-center text-sm font-bold text-gray-800">${lot.quantity.toLocaleString()}</td>
                        </tr>`;
                    });
                } else {
                     table += `<tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-center"><div class="text-sm font-medium text-gray-900">${product.name}</div><div class="text-xs text-gray-500">${product.sku}</div></td>
                        <td class="px-4 py-3 text-center text-sm text-gray-700">N/A</td>
                        <td class="px-4 py-3 text-center text-sm font-bold text-gray-800">${item.quantity.toLocaleString()}</td>
                    </tr>`;
                }
            });
            table += `</tbody></table>`;
            resultsContainer.innerHTML = table;
        };

        searchInput.addEventListener('input', (e) => renderResults(e.target.value));
        renderResults();
    }

    // 更新工單狀態分頁標籤樣式
    function updateWorkOrderStatusTabs() {
        document.querySelectorAll('.work-order-status-tab').forEach(tab => {
            const isActive = tab.dataset.status === currentWorkOrderStatusFilter;
            tab.classList.toggle('text-blue-600', isActive);
            tab.classList.toggle('border-blue-500', isActive);
            tab.classList.toggle('text-gray-500', !isActive);
            tab.classList.toggle('border-transparent', !isActive);
        });
    }

    // --- Initial Setup ---
    mainTabsContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { currentView = e.target.dataset.view; renderApp(); } });
    roleSwitcher.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentRole = e.target.dataset.role;
            // Set default view based on role
            currentView = (currentRole === 'retail') ? 'dashboard' : 'work_orders';
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            // 顯示或隱藏門市人員專用的工單狀態分頁
            const statusTabsContainer = document.getElementById('work-order-status-tabs');
            if (statusTabsContainer) {
                if (currentRole === 'retail') {
                    statusTabsContainer.style.display = 'block';
                    // 重置為預設狀態
                    currentWorkOrderStatusFilter = '待處理';
                    updateWorkOrderStatusTabs();
                } else {
                    statusTabsContainer.style.display = 'none';
                }
            }
            
            renderApp(); // Re-render the whole app to apply role permissions
        }
    });
    // 工單狀態分頁標籤事件監聽器
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('work-order-status-tab')) {
            currentWorkOrderStatusFilter = e.target.dataset.status;
            updateWorkOrderStatusTabs();
            renderWorkOrderList();
        }
    });
    
    modalBackdrop.addEventListener('click', (e) => {
        // 只有在點擊背景本身（而不是模態框內容）時才關閉
        if (e.target === modalBackdrop) {
            closeModal();
        }
    });
    window.addEventListener('DOMContentLoaded', () => {
        workOrders.filter(wo => wo.status === '已完成').forEach(wo => {
            if(!inventoryLog.some(log => log.remark.includes(wo.id))) {
                addInventoryLog(wo.largeItemSku, '工單領料', -wo.warehouseInfo.dispatchedUnits, `工單: ${wo.id}`, wo.sourceLotNumber);
                if(wo.warehouseInfo.returnedUnits > 0) { addInventoryLog(wo.largeItemSku, '工單退料', wo.warehouseInfo.returnedUnits, `工單: ${wo.id}`, wo.sourceLotNumber); }
                addInventoryLog(wo.boxSku, '工單耗用', -wo.packagingResult.producedCount, `工單: ${wo.id}`);
                addInventoryLog(wo.smallItemSku, '成品入庫', wo.packagingResult.producedCount, `工單: ${wo.id}`, wo.sourceLotNumber, wo.costing.finalCostPerPackage);
            }
        });
        // DEMO: 預置幾筆包材的入庫，含儲位
        if (inventoryLog.filter(l => l.type === '手動入庫' && l.storageLocation).length === 0) {
            addInventoryLog('BOX-APP-12P', '手動入庫', 100, 'DEMO入庫', null, 0, '主倉-A1');
            addInventoryLog('BND-STD-RED', '手動入庫', 50, 'DEMO入庫', null, 0, '主倉-B2');
            addInventoryLog('INB-APP-12P', '手動入庫', 30, 'DEMO入庫', null, 0, '副倉-C1');
        }
        currentView = 'work_orders';
        renderApp(); 
        setupDateFilters('log', displayFilteredLogs);
        setupDateFilters('dashboard', renderDashboard);
        document.getElementById('add-wo-btn').addEventListener('click', openNewWorkOrderModal);
        document.getElementById('min-stock-settings-btn').addEventListener('click', openMinStockSettingsModal);
    });

    // 最低庫存量設定模態框
    function openMinStockSettingsModal() {
        const modalHtml = `
            <div class="p-6">
                <h3 class="text-lg font-semibold border-b pb-3 mb-4">最低庫存量設定</h3>
                
                <!-- 分頁標籤 -->
                <div class="mb-4">
                    <nav class="flex border-b border-gray-200" id="min-stock-tabs">
                        <button data-tab="large_fruit" class="min-stock-tab px-6 py-3 text-sm font-medium bg-blue-500 text-white border border-gray-200 border-b-0 rounded-t-lg -mb-px">大件原料</button>
                        <button data-tab="packaging" class="min-stock-tab px-6 py-3 text-sm font-medium bg-gray-100 text-gray-600 border border-gray-200 border-b-0 rounded-t-lg -mb-px ml-1 hover:bg-gray-200">包材</button>
                    </nav>
                </div>
                
                <!-- 分頁內容 -->
                <div id="min-stock-content" class="min-h-96 border border-gray-200 rounded-b-lg rounded-tr-lg bg-white">
                    <!-- 大件原料子分頁 -->
                    <div id="fruit-subtabs-container" class="hidden">
                        <div class="border-b border-gray-200 px-4 pt-4">
                            <nav class="flex space-x-1" id="fruit-subtabs">
                                <!-- 水果種類子分頁將由 JavaScript 動態生成 -->
                            </nav>
                        </div>
                        <div id="fruit-subcontent" class="p-4">
                            <!-- 水果種類子分頁內容將由 JavaScript 動態生成 -->
                        </div>
                    </div>
                    <!-- 包材子分頁 -->
                    <div id="packaging-subtabs-container" class="hidden">
                        <div class="border-b border-gray-200 px-4 pt-4">
                            <nav class="flex space-x-1" id="packaging-subtabs">
                                <!-- 包材類別子分頁將由 JavaScript 動態生成 -->
                            </nav>
                        </div>
                        <div id="packaging-subcontent" class="p-4">
                            <!-- 包材類別子分頁內容將由 JavaScript 動態生成 -->
                        </div>
                    </div>
                    <!-- 主要內容區域 -->
                    <div id="main-stock-content" class="p-4">
                        <!-- 內容將由 JavaScript 動態生成 -->
                    </div>
                </div>
                
                <!-- 按鈕區域 -->
                <div class="pt-6 border-t border-gray-200 flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                    <button type="button" id="save-min-stock-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">儲存設定</button>
                </div>
            </div>`;
        
        openModal(modalHtml, 'max-w-4xl');
        
        // 綁定分頁切換事件
        document.querySelectorAll('.min-stock-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const targetTab = e.target.dataset.tab;
                switchMinStockTab(targetTab);
            });
        });
        
        // 綁定按鈕事件
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
        document.getElementById('save-min-stock-btn').addEventListener('click', saveMinStockSettings);
        
        // 初始顯示大件原料分頁
        switchMinStockTab('large_fruit');
    }

    // 切換最低庫存量設定分頁
    function switchMinStockTab(tabType) {
        // 更新分頁標籤樣式
        document.querySelectorAll('.min-stock-tab').forEach(tab => {
            if (tab.dataset.tab === tabType) {
                tab.className = 'min-stock-tab px-6 py-3 text-sm font-medium bg-blue-500 text-white border border-gray-200 border-b-0 rounded-t-lg -mb-px';
            } else {
                tab.className = 'min-stock-tab px-6 py-3 text-sm font-medium bg-gray-100 text-gray-600 border border-gray-200 border-b-0 rounded-t-lg -mb-px ml-1 hover:bg-gray-200';
            }
        });
        
        // 隱藏所有子分頁容器
        document.getElementById('fruit-subtabs-container').classList.add('hidden');
        document.getElementById('packaging-subtabs-container').classList.add('hidden');
        document.getElementById('main-stock-content').classList.add('hidden');
        
        if (tabType === 'large_fruit') {
            // 顯示大件原料子分頁
            document.getElementById('fruit-subtabs-container').classList.remove('hidden');
            renderFruitSubTabs();
        } else if (tabType === 'packaging') {
            // 顯示包材子分頁
            document.getElementById('packaging-subtabs-container').classList.remove('hidden');
            renderPackagingSubTabs();
        } else {
            // 顯示主要內容（其他情況）
            document.getElementById('main-stock-content').classList.remove('hidden');
            renderMinStockContent(tabType);
        }
    }

    // 渲染最低庫存量設定內容
    function renderMinStockContent(tabType) {
        const contentContainer = document.getElementById('main-stock-content');
        const items = products.filter(p => p.category === tabType);
        const categoryName = tabType === 'large_fruit' ? '大件原料' : '包材';
        const unit = tabType === 'large_fruit' ? '箱/串' : '個';
        
        if (items.length === 0) {
            contentContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>目前沒有${categoryName}資料</p>
                </div>`;
            return;
        }
        
        if (tabType === 'packaging') {
            // 包材按類別分組顯示
            const groupedItems = {};
            items.forEach(item => {
                const categoryKey = item.details?.type || 'other';
                const categoryInfo = packagingCategories.find(cat => cat.key === categoryKey);
                const categoryName = categoryInfo ? categoryInfo.name : '其他';
                
                if (!groupedItems[categoryName]) {
                    groupedItems[categoryName] = [];
                }
                groupedItems[categoryName].push(item);
            });
            
            const groupSections = Object.keys(groupedItems).map(groupName => {
                const groupItems = groupedItems[groupName];
                const groupRows = groupItems.map(item => {
                    const currentMinStock = minStockSettings[tabType][item.sku] || '';
                    const currentStock = findStock(item.sku)?.quantity || 0;
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${item.sku}</td>
                            <td class="px-4 py-3 text-sm text-center font-semibold text-gray-800">${currentStock.toLocaleString()}</td>
                            <td class="px-4 py-3 text-center">
                                <input type="number" 
                                       data-sku="${item.sku}" 
                                       data-category="${tabType}"
                                       value="${currentMinStock}" 
                                       min="0" 
                                       step="1"
                                       class="min-stock-input w-20 px-2 py-1 text-sm border border-gray-300 rounded-md text-center focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="0">
                            </td>
                        </tr>`;
                }).join('');
                
                return `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 px-2 py-1 bg-blue-100 rounded">${groupName}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${groupRows}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }).join('');
            
            contentContainer.innerHTML = `
                <div class="grid grid-cols-4 gap-4 px-4 py-2 bg-gray-50 rounded text-xs font-medium text-gray-500 uppercase tracking-wider mb-4">
                    <div>品項名稱</div>
                    <div>SKU</div>
                    <div class="text-center">目前庫存 (${unit})</div>
                    <div class="text-center">最低庫存量 (${unit})</div>
                </div>
                <div class="space-y-4">
                    ${groupSections}
                </div>`;
        } else {
            // 大件原料按水果種類分組顯示
            const groupedItems = {};
            items.forEach(item => {
                const series = item.details?.fruitType || '其他';
                
                if (!groupedItems[series]) {
                    groupedItems[series] = [];
                }
                groupedItems[series].push(item);
            });
            
            const groupSections = Object.keys(groupedItems).map(groupName => {
                const groupItems = groupedItems[groupName];
                const groupRows = groupItems.map(item => {
                    const currentMinStock = minStockSettings[tabType][item.sku] || '';
                    const currentStock = findStock(item.sku)?.quantity || 0;
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${item.sku}</td>
                            <td class="px-4 py-3 text-sm text-center font-semibold text-gray-800">${currentStock.toLocaleString()}</td>
                            <td class="px-4 py-3 text-center">
                                <input type="number" 
                                       data-sku="${item.sku}" 
                                       data-category="${tabType}"
                                       value="${currentMinStock}" 
                                       min="0" 
                                       step="1"
                                       class="min-stock-input w-20 px-2 py-1 text-sm border border-gray-300 rounded-md text-center focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="0">
                            </td>
                        </tr>`;
                }).join('');
                
                return `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 px-2 py-1 bg-green-100 rounded">${groupName}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${groupRows}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }).join('');
            
            contentContainer.innerHTML = `
                <div class="grid grid-cols-4 gap-4 px-4 py-2 bg-gray-50 rounded text-xs font-medium text-gray-500 uppercase tracking-wider mb-4">
                    <div>品項名稱</div>
                    <div>SKU</div>
                    <div class="text-center">目前庫存 (${unit})</div>
                    <div class="text-center">最低庫存量 (${unit})</div>
                </div>
                <div class="space-y-4">
                    ${groupSections}
                </div>`;
        }
    }

    // 渲染大件原料子分頁
    function renderFruitSubTabs() {
        const fruitItems = products.filter(p => p.category === 'large_fruit');
        const fruitTypes = {};
        
        // 按水果種類分組
        fruitItems.forEach(item => {
            const fruitType = item.details?.fruitType || '其他';
            if (!fruitTypes[fruitType]) {
                fruitTypes[fruitType] = [];
            }
            fruitTypes[fruitType].push(item);
        });
        
        const fruitTypeNames = Object.keys(fruitTypes);
        if (fruitTypeNames.length === 0) {
            document.getElementById('fruit-subcontent').innerHTML = '<div class="text-center py-8 text-gray-500">目前沒有大件原料資料</div>';
            return;
        }
        
        // 生成子分頁標籤
        const subtabsHtml = fruitTypeNames.map((fruitType, index) => {
            const isActive = index === 0;
            const activeClass = isActive ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200';
            return `<button data-fruit-type="${fruitType}" class="fruit-subtab px-4 py-2 text-sm font-medium ${activeClass} border border-gray-200 border-b-0 rounded-t-lg -mb-px ${index > 0 ? 'ml-1' : ''}">${fruitType}</button>`;
        }).join('');
        
        document.getElementById('fruit-subtabs').innerHTML = subtabsHtml;
        
        // 綁定子分頁點擊事件
        document.querySelectorAll('.fruit-subtab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const selectedFruitType = e.target.dataset.fruitType;
                switchFruitSubTab(selectedFruitType, fruitTypes);
            });
        });
        
        // 初始顯示第一個水果種類
        switchFruitSubTab(fruitTypeNames[0], fruitTypes);
    }
    
    // 切換大件原料子分頁
    function switchFruitSubTab(selectedFruitType, fruitTypes) {
        // 更新子分頁標籤樣式
        document.querySelectorAll('.fruit-subtab').forEach(tab => {
            if (tab.dataset.fruitType === selectedFruitType) {
                tab.className = tab.className.replace(/bg-gray-\d+|text-gray-\d+|hover:bg-gray-\d+/g, '').replace(/\s+/g, ' ') + ' bg-green-500 text-white';
            } else {
                tab.className = tab.className.replace(/bg-green-\d+|text-white/g, '').replace(/\s+/g, ' ') + ' bg-gray-100 text-gray-600 hover:bg-gray-200';
            }
        });
        
        // 渲染選中水果種類的內容
        renderFruitSubContent(selectedFruitType, fruitTypes[selectedFruitType]);
    }
    
    // 渲染大件原料子分頁內容
    function renderFruitSubContent(fruitType, items) {
        const unit = '箱/串';
        const tableRows = items.map(item => {
            const currentMinStock = minStockSettings['large_fruit'][item.sku] || '';
            const currentStock = findStock(item.sku)?.quantity || 0;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${item.sku}</td>
                    <td class="px-4 py-3 text-sm text-center font-semibold text-gray-800">${currentStock.toLocaleString()}</td>
                    <td class="px-4 py-3 text-center">
                        <input type="number" 
                               data-sku="${item.sku}" 
                               data-category="large_fruit"
                               value="${currentMinStock}" 
                               min="0" 
                               step="1"
                               class="min-stock-input w-20 px-2 py-1 text-sm border border-gray-300 rounded-md text-center focus:ring-blue-500 focus:border-blue-500"
                               placeholder="0">
                    </td>
                </tr>`;
        }).join('');
        
        document.getElementById('fruit-subcontent').innerHTML = `
            <div class="grid grid-cols-4 gap-4 px-4 py-2 bg-gray-50 rounded text-xs font-medium text-gray-500 uppercase tracking-wider mb-4">
                <div>品項名稱</div>
                <div>SKU</div>
                <div class="text-center">目前庫存 (${unit})</div>
                <div class="text-center">最低庫存量 (${unit})</div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                </table>
            </div>`;
    }
    
    // 渲染包材子分頁
    function renderPackagingSubTabs() {
        const packagingItems = products.filter(p => p.category === 'packaging');
        const packagingTypes = {};
        
        // 按包材類別分組
        packagingItems.forEach(item => {
            const categoryKey = item.details?.type || 'other';
            const categoryInfo = packagingCategories.find(cat => cat.key === categoryKey);
            const categoryName = categoryInfo ? categoryInfo.name : '其他';
            
            if (!packagingTypes[categoryName]) {
                packagingTypes[categoryName] = [];
            }
            packagingTypes[categoryName].push(item);
        });
        
        const packagingTypeNames = Object.keys(packagingTypes);
        if (packagingTypeNames.length === 0) {
            document.getElementById('packaging-subcontent').innerHTML = '<div class="text-center py-8 text-gray-500">目前沒有包材資料</div>';
            return;
        }
        
        // 生成子分頁標籤
        const subtabsHtml = packagingTypeNames.map((packagingType, index) => {
            const isActive = index === 0;
            const activeClass = isActive ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200';
            return `<button data-packaging-type="${packagingType}" class="packaging-subtab px-4 py-2 text-sm font-medium ${activeClass} border border-gray-200 border-b-0 rounded-t-lg -mb-px ${index > 0 ? 'ml-1' : ''}">${packagingType}</button>`;
        }).join('');
        
        document.getElementById('packaging-subtabs').innerHTML = subtabsHtml;
        
        // 綁定子分頁點擊事件
        document.querySelectorAll('.packaging-subtab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const selectedPackagingType = e.target.dataset.packagingType;
                switchPackagingSubTab(selectedPackagingType, packagingTypes);
            });
        });
        
        // 初始顯示第一個包材類別
        switchPackagingSubTab(packagingTypeNames[0], packagingTypes);
    }
    
    // 切換包材子分頁
    function switchPackagingSubTab(selectedPackagingType, packagingTypes) {
        // 更新子分頁標籤樣式
        document.querySelectorAll('.packaging-subtab').forEach(tab => {
            if (tab.dataset.packagingType === selectedPackagingType) {
                tab.className = tab.className.replace(/bg-gray-\d+|text-gray-\d+|hover:bg-gray-\d+/g, '').replace(/\s+/g, ' ') + ' bg-blue-500 text-white';
            } else {
                tab.className = tab.className.replace(/bg-blue-\d+|text-white/g, '').replace(/\s+/g, ' ') + ' bg-gray-100 text-gray-600 hover:bg-gray-200';
            }
        });
        
        // 渲染選中包材類別的內容
        renderPackagingSubContent(selectedPackagingType, packagingTypes[selectedPackagingType]);
    }
    
    // 渲染包材子分頁內容
    function renderPackagingSubContent(packagingType, items) {
        const unit = '個';
        const tableRows = items.map(item => {
            const currentMinStock = minStockSettings['packaging'][item.sku] || '';
            const currentStock = findStock(item.sku)?.quantity || 0;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${item.sku}</td>
                    <td class="px-4 py-3 text-sm text-center font-semibold text-gray-800">${currentStock.toLocaleString()}</td>
                    <td class="px-4 py-3 text-center">
                        <input type="number" 
                               data-sku="${item.sku}" 
                               data-category="packaging"
                               value="${currentMinStock}" 
                               min="0" 
                               step="1"
                               class="min-stock-input w-20 px-2 py-1 text-sm border border-gray-300 rounded-md text-center focus:ring-blue-500 focus:border-blue-500"
                               placeholder="0">
                    </td>
                </tr>`;
        }).join('');
        
        document.getElementById('packaging-subcontent').innerHTML = `
            <div class="grid grid-cols-4 gap-4 px-4 py-2 bg-gray-50 rounded text-xs font-medium text-gray-500 uppercase tracking-wider mb-4">
                <div>品項名稱</div>
                <div>SKU</div>
                <div class="text-center">目前庫存 (${unit})</div>
                <div class="text-center">最低庫存量 (${unit})</div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                </table>
            </div>`;
    }

    // 檢查低庫存品項
    function getLowStockItems() {
        const lowStockItems = [];
        
        inventory.forEach(stockItem => {
            const product = findProduct(stockItem.sku);
            if (!product) return;
            
            const category = product.category;
            const minStock = minStockSettings[category]?.[stockItem.sku];
            
            if (minStock && stockItem.quantity <= minStock) {
                lowStockItems.push({
                    sku: stockItem.sku,
                    name: product.name,
                    currentStock: stockItem.quantity,
                    minStock: minStock,
                    category: category,
                    categoryName: category === 'large_fruit' ? '大件原料' : category === 'packaging' ? '包材' : '小件成品'
                });
            }
        });
        
        return lowStockItems;
    }
    
    // 獲取低庫存警告數量
    function getLowStockCount() {
        return getLowStockItems().length;
    }
    
    // 顯示低庫存詳情模態框
    function showLowStockDetails() {
        const lowStockItems = getLowStockItems();
        
        if (lowStockItems.length === 0) {
            openSuccessModal('目前沒有低庫存警告！', () => {});
            return;
        }
        
        const tableRows = lowStockItems.map(item => {
            const warningLevel = item.currentStock === 0 ? 'text-red-600' : item.currentStock <= item.minStock * 0.5 ? 'text-red-500' : 'text-orange-500';
            const warningIcon = item.currentStock === 0 ? '🔴' : item.currentStock <= item.minStock * 0.5 ? '🟠' : '🟡';
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${warningIcon}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${item.sku}</td>
                    <td class="px-4 py-3 text-sm text-center text-gray-600">${item.categoryName}</td>
                    <td class="px-4 py-3 text-sm text-center ${warningLevel} font-semibold">${item.currentStock}</td>
                    <td class="px-4 py-3 text-sm text-center text-gray-600">${item.minStock}</td>
                </tr>`;
        }).join('');
        
        const modalHtml = `
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-2 rounded-full mr-3">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">低庫存警告詳情</h3>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-yellow-800">發現 ${lowStockItems.length} 項品項庫存不足</p>
                            <p class="text-sm text-yellow-700 mt-1">請及時補貨以避免影響正常作業</p>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">品項名稱</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">類別</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">目前庫存</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">最低庫存</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 text-sm text-gray-600">
                    <p><span class="text-red-600">🔴</span> 零庫存 - 緊急補貨</p>
                    <p><span class="text-red-500">🟠</span> 嚴重不足 - 優先補貨</p>
                    <p><span class="text-orange-500">🟡</span> 庫存偏低 - 建議補貨</p>
                </div>
                
                <div class="pt-6 border-t border-gray-200 flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">關閉</button>
                    <button type="button" onclick="goToInventoryManagement()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">前往庫存管理</button>
                </div>
            </div>`;
        
        openModal(modalHtml, 'max-w-4xl');
        
        // 綁定關閉按鈕事件
        document.querySelector('.cancel-btn').addEventListener('click', closeModal);
    }
    
    // 前往庫存管理頁面
    function goToInventoryManagement() {
        closeModal();
        currentView = 'inventory';
        renderApp();
    }
    
    // 獲取低庫存警告CSS類別
    function getLowStockWarningClass(sku, currentStock, category) {
        const minStock = minStockSettings[category]?.[sku];
        if (!minStock) return 'text-gray-800';
        
        if (currentStock === 0) return 'text-red-600';
        if (currentStock <= minStock * 0.5) return 'text-red-500';
        if (currentStock <= minStock) return 'text-orange-500';
        return 'text-gray-800';
    }
    
    // 獲取低庫存警告圖示
    function getLowStockWarningIcon(sku, currentStock, category) {
        const minStock = minStockSettings[category]?.[sku];
        if (!minStock) return '';
        
        if (currentStock === 0) return '🔴';
        if (currentStock <= minStock * 0.5) return '🟠';
        if (currentStock <= minStock) return '🟡';
        return '';
    }

    // 儲存最低庫存量設定
    function saveMinStockSettings() {
        const inputs = document.querySelectorAll('.min-stock-input');
        let hasChanges = false;
        
        inputs.forEach(input => {
            const sku = input.dataset.sku;
            const category = input.dataset.category;
            const value = parseInt(input.value) || 0;
            
            if (value !== (minStockSettings[category][sku] || 0)) {
                hasChanges = true;
                if (value > 0) {
                    minStockSettings[category][sku] = value;
                } else {
                    delete minStockSettings[category][sku];
                }
            }
        });
        
        if (hasChanges) {
            openSuccessModal('最低庫存量設定已成功儲存！', () => {
                closeModal();
            });
        } else {
            closeModal();
        }
    }

	function openManagePackagingCategoriesModal() {
		const renderList = () => {
			const rows = packagingCategories.map((cat, idx) => `
				<tr class="hover:bg-gray-50">
					<td class="px-4 py-2 text-center text-sm">${cat.name}</td>
					<td class="px-4 py-2 text-center">
						<div class="flex justify-center gap-2">
							<button data-idx="${idx}" class="rename-cat-btn text-blue-600 hover:bg-blue-50 rounded p-2 transition-colors" title="重新命名">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
								</svg>
							</button>
							<button data-idx="${idx}" class="delete-cat-btn text-red-600 hover:bg-red-50 rounded p-2 transition-colors" title="刪除">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
								</svg>
							</button>
						</div>
					</td>
				</tr>
			`).join('');
			return `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">類別名稱</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead><tbody>${rows}</tbody></table></div>`;
		};

		const modalHtml = `
			<div class="p-6 space-y-4">
				<h3 class="text-lg font-semibold border-b pb-3">管理包材類別</h3>
				<div class="flex gap-2">
					<input type="text" id="new-cat-name" class="flex-1 rounded-md border-gray-300 shadow-sm" placeholder="新增類別名稱">
					<button id="add-cat-btn" class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">新增</button>
				</div>
				<div id="cat-list">${renderList()}</div>
				<div class="pt-2 text-right">
					<button class="cancel-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">關閉</button>
				</div>
			</div>
		`;
		openModal(modalHtml, 'max-w-xl');
		document.querySelector('.cancel-btn').addEventListener('click', closeModal);
		document.getElementById('add-cat-btn').addEventListener('click', () => {
			const name = (document.getElementById('new-cat-name').value || '').toString().trim();
			if (!name) { alert('請輸入類別名稱'); return; }
			// 產生唯一 key
			const keyBase = name.normalize('NFKD').replace(/[^\w]+/g, '_').toLowerCase();
			let key = keyBase || `cat_${Date.now()}`;
			let i = 1; while (packagingCategories.some(c => c.key === key)) { key = `${keyBase}_${i++}`; }
			packagingCategories.push({ key, name });
			document.getElementById('cat-list').innerHTML = renderList();
			bindRowActions();
			
			// 保存當前活躍的包材分頁
			const currentActiveTab = document.querySelector('#maintenance-packaging-sub-tabs .sub-tab.active');
			const currentPaneId = currentActiveTab ? currentActiveTab.getAttribute('data-pane') : null;
			// 從 pane ID 中提取 category (格式: maintenance-{category}-pane)
			const currentCategory = currentPaneId ? currentPaneId.replace('maintenance-', '').replace('-pane', '') : null;
			
			// 重新渲染包材子分頁，直接指定活躍分頁
			initMaintenancePackagingTabs(currentCategory);
			
			// 清空輸入框，準備新增下一個類別
			document.getElementById('new-cat-name').value = '';
		});

		function bindRowActions() {
			document.querySelectorAll('.rename-cat-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const idx = parseInt(btn.dataset.idx);
					const current = packagingCategories[idx];
					openRenameCategoryModal(current, idx, renderList, bindRowActions);
				});
			});
			document.querySelectorAll('.delete-cat-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const idx = parseInt(btn.dataset.idx);
					const cat = packagingCategories[idx];
					openDeleteCategoryModal(cat, idx, renderList, bindRowActions);
				});
			});
		}

					bindRowActions();
	}

	// 重新命名包材類別的模態框
	function openRenameCategoryModal(current, idx, renderList, bindRowActions) {
		const modalHtml = `
			<form id="rename-category-form" class="p-6 space-y-4">
				<h3 class="text-lg font-medium text-gray-900">重新命名包材類別</h3>
				
				<div>
					<label for="rename-category-name" class="block text-sm font-medium text-gray-700">類別名稱</label>
					<input type="text" id="rename-category-name" name="name" value="${current.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
				</div>
				
				<div class="flex justify-end gap-3 pt-4">
					<button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">確認修改</button>
				</div>
			</form>
		`;
		
		openModal(modalHtml);
		
		// 綁定事件
		document.querySelector('.cancel-btn').addEventListener('click', () => {
			closeModal();
			// 回到管理包材類別模態框，增加延遲時間
			setTimeout(() => {
				openManagePackagingCategoriesModal();
			}, 300);
		});
		
		document.getElementById('rename-category-form').addEventListener('submit', (e) => {
			e.preventDefault();
			const newName = document.getElementById('rename-category-name').value.trim();
			const inputElement = document.getElementById('rename-category-name');
			
			// 清除之前的錯誤樣式
			inputElement.classList.remove('border-red-500', 'ring-red-500');
			let errorElement = document.getElementById('rename-category-error-message');
			if (errorElement) {
				errorElement.remove();
			}
			
			if (!newName) {
				// 在表單內顯示錯誤訊息
				inputElement.classList.add('border-red-500', 'ring-red-500');
				const errorHtml = `<p id="rename-category-error-message" class="text-red-600 text-sm mt-1">請輸入類別名稱</p>`;
				inputElement.parentNode.insertAdjacentHTML('beforeend', errorHtml);
				inputElement.focus();
				return;
			}
			
			// 檢查名稱是否重複
			if (packagingCategories.some((cat, i) => i !== idx && cat.name === newName)) {
				inputElement.classList.add('border-red-500', 'ring-red-500');
				const errorHtml = `<p id="rename-category-error-message" class="text-red-600 text-sm mt-1">此名稱已存在，請使用其他名稱</p>`;
				inputElement.parentNode.insertAdjacentHTML('beforeend', errorHtml);
				inputElement.focus();
				inputElement.select();
				return;
			}
			
			// 更新類別名稱
			packagingCategories[idx] = { ...current, name: newName };
			
			// 更新相關的包材分頁
					const subNav = document.getElementById('packaging-sub-tabs');
					const panes = document.getElementById('packaging-panes-container');
					if (subNav && panes) { subNav.innerHTML = ''; panes.innerHTML = ''; }
					const init = (typeof initPackagingTabs === 'function') ? initPackagingTabs : null;
					if (init) init();
			
			closeModal();
			// 回到管理包材類別模態框，增加延遲時間
			setTimeout(() => {
				openManagePackagingCategoriesModal();
			}, 300);
		});
	}
	// 刪除包材類別的模態框
	function openDeleteCategoryModal(cat, idx, renderList, bindRowActions) {
		// 檢查此類別下有多少包材
		const categoryProducts = products.filter(p => p.category === 'packaging' && p.details?.type === cat.key);
		const categorySkus = categoryProducts.map(p => p.sku);
		
		// 檢查哪些常用組合使用了這個類別的包材
		const affectedCombos = findCombosUsingCategory(cat.key);
		
		let warningMessage = `您確定要刪除類別「<span class="font-semibold">${cat.name}</span>」嗎？<br><span class="text-red-600 font-medium">此操作無法復原，該類別下的所有包材將不再顯示。</span>`;
		
		if (categoryProducts.length > 0) {
			warningMessage += `<br><br><div class="bg-orange-50 border border-orange-200 rounded-md p-3 mt-3">
				<div class="flex items-start">
					<svg class="w-5 h-5 text-orange-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					<div>
						<p class="text-sm font-medium text-orange-800">📦 包材影響</p>
						<p class="text-sm text-orange-700 mt-1">此類別包含 <span class="font-medium text-red-600">${categoryProducts.length}</span> 個包材品項：</p>
						<p class="text-sm text-orange-700 mt-1">${categoryProducts.map(p => p.name).join('、')}</p>
						<p class="text-sm text-orange-700 mt-2 font-medium">刪除類別後，這些包材將無法在系統中顯示或使用。</p>
					</div>
				</div>
			</div>`;
		}
		
		if (affectedCombos.length > 0) {
			const comboNames = affectedCombos.map(combo => `「${combo.name}」`).join('、');
			warningMessage += `<br><div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mt-3">
				<div class="flex items-start">
					<svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					<div>
						<p class="text-sm font-medium text-yellow-800">⚠️ 常用組合影響</p>
						<p class="text-sm text-yellow-700 mt-1">此類別的包材被以下 <span class="font-medium text-red-600">${affectedCombos.length}</span> 個常用組合使用：</p>
						<p class="text-sm text-yellow-700 mt-1">${comboNames}</p>
						<p class="text-sm text-yellow-700 mt-2 font-medium">刪除後，這些組合將自動移除相關包材。</p>
					</div>
				</div>
			</div>`;
		}
		
		const modalHtml = `
			<div class="p-6 space-y-4">
				<div class="flex items-center gap-3">
					<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
					</svg>
					<h3 class="text-lg font-medium text-gray-900">確認刪除包材類別</h3>
				</div>
				
				<div class="text-sm text-gray-600 max-h-80 overflow-y-auto">
					${warningMessage}
				</div>
				
				<div class="flex justify-end gap-3 pt-4">
					<button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">取消</button>
					<button type="button" class="confirm-delete-btn px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">確認刪除</button>
				</div>
			</div>
		`;
		
		openModal(modalHtml, 'max-w-2xl');
		
		// 綁定事件
		document.querySelector('.cancel-btn').addEventListener('click', () => {
			closeModal();
			// 回到管理包材類別模態框，增加延遲時間
			setTimeout(() => {
				openManagePackagingCategoriesModal();
			}, 300);
		});
		
		document.querySelector('.confirm-delete-btn').addEventListener('click', () => {
			console.log('開始刪除包材類別:', cat.name);
			console.log('該類別包含的包材SKU:', categorySkus);
			
			// 先從產品清單中移除該類別的所有包材
			categorySkus.forEach(sku => {
				const productIndex = products.findIndex(p => p.sku === sku);
				if (productIndex !== -1) {
					console.log(`從產品清單移除包材: ${products[productIndex].name} (${sku})`);
					products.splice(productIndex, 1);
				}
				
				// 同時從庫存清單中移除
				const inventoryIndex = inventory.findIndex(i => i.sku === sku);
				if (inventoryIndex !== -1) {
					console.log(`從庫存清單移除包材: ${sku}`);
					inventory.splice(inventoryIndex, 1);
				}
			});
			
			// 刪除類別
			packagingCategories.splice(idx, 1);
			
			// 清理常用組合中的已刪除包材
			let removedEmptyCombos = 0;
			if (categorySkus.length > 0) {
				console.log('開始清理常用組合...');
				removedEmptyCombos = cleanupComboAfterDeletion(categorySkus);
				
				// 再次執行無效包材清理，確保完全清理
				console.log('執行額外的無效包材清理...');
				const additionalRemoved = cleanupInvalidPackagingInCombos();
				removedEmptyCombos += additionalRemoved;
			}
			
			// 保存當前活躍的包材分頁
			const currentActiveTab = document.querySelector('#maintenance-packaging-sub-tabs .sub-tab.active');
			const currentPaneId = currentActiveTab ? currentActiveTab.getAttribute('data-pane') : null;
			const currentCategory = currentPaneId ? currentPaneId.replace('maintenance-', '').replace('-pane', '') : null;
			
			// 更新相關的包材分頁
			let targetCategory = currentCategory;
			// 如果被刪除的類別是當前活躍的分頁，則使用第一個可用的類別
			if (currentCategory === cat.key) {
				targetCategory = packagingCategories.length > 0 ? packagingCategories[0].key : null;
			}
			
			initMaintenancePackagingTabs(targetCategory);
			
			// 立即強制更新常用組合界面
			if (currentView === 'maintenance') {
				console.log('立即更新常用組合分頁');
				setTimeout(() => {
					if (typeof updateFavoriteComboPane === 'function') {
						updateFavoriteComboPane();
					}
				}, 10);
			}
			
			closeModal();
			
			// 顯示成功訊息，包含受影響的組合和包材資訊
			let successMessage = `包材類別「${cat.name}」已成功刪除。`;
			if (categoryProducts.length > 0) {
				successMessage += `<br><br>受影響的 ${categoryProducts.length} 個包材品項將不再顯示。`;
			}
			if (affectedCombos.length > 0) {
				successMessage += `<br>已自動更新 ${affectedCombos.length} 個常用組合。`;
				if (removedEmptyCombos > 0) {
					successMessage += `<br>其中 ${removedEmptyCombos} 個組合因為沒有任何包材而被移除。`;
				}
			}
			
			openSuccessModal(successMessage, () => {
				// 回到管理包材類別模態框，增加延遲時間
				setTimeout(() => {
					openManagePackagingCategoriesModal();
				}, 100);
				
				// 如果有受影響的組合，也更新常用組合分頁
				if (affectedCombos.length > 0) {
					setTimeout(() => {
						if (typeof updateFavoriteComboPane === 'function') {
							updateFavoriteComboPane();
						}
					}, 200);
				}
			});
		});
	}

</script>
</body>
</html>